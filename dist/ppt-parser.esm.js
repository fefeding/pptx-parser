import t from"jszip";import{unescape as e}from"html-escaper";const r={p:"http://schemas.openxmlformats.org/presentationml/2006/main",a:"http://schemas.openxmlformats.org/drawingml/2006/main",r:"http://schemas.openxmlformats.org/officeDocument/2006/relationships",mc:"http://schemas.openxmlformats.org/markup-compatibility/2006",c:"http://schemas.openxmlformats.org/drawingml/2006/chart",d:"http://schemas.openxmlformats.org/drawingml/2006/diagram"},n=914400,i=96,s=96/n,o="ppt/slides/",a="ppt/slides/_rels/",l="docProps/",c="ppt/slideLayouts/";function d(t){const e="string"==typeof t?parseInt(t||"0",10):t;return Math.round(e*s*100)/100}function p(t){return Math.round(9525*t)}function u(t){const e={};return t?.attributes?(Array.from(t.attributes).forEach(t=>{e[t.name]=t.value}),e):e}function h(t,e,r){return t?Array.from(t.getElementsByTagNameNS(r,e)):[]}function f(t,e,r){return t&&t.getElementsByTagNameNS(r,e)[0]||null}function g(t,e,r=""){return t&&t.getAttribute(e)||r}function m(t,e){if(!t)return!1;const r=t.getAttribute(e);return"1"===r||"true"===r}function y(t){const e=(new DOMParser).parseFromString(t,"application/xml"),r=Array.from(e.documentElement.children),n={};return r.forEach(t=>{const e=t.getAttribute("Id"),r=t.getAttribute("Type"),i=t.getAttribute("Target");e&&(n[e]={id:e,type:r||"",target:i||""})}),n}function b(t,e){const r=t.indexOf("_rels/");let n=t;-1!==r&&(n=t.substring(0,r));const i=(n+e).split("/"),s=[];for(const t of i)""!==t&&"."!==t&&(".."===t?s.length>0&&s.pop():s.push(t));return s.join("/")}function x(t,e){const r=y(t);for(const t in r){const n=r[t];n.target=b(e,n.target)}return r}function w(t){const e=(new DOMParser).parseFromString(t,"application/xml"),r="http://purl.org/dc/elements/1.1/",n="http://purl.org/dc/terms/",i=(t,r)=>{const n=e.getElementsByTagNameNS(r,t)[0];return n?.textContent||void 0};return{title:i("title",r),author:i("creator",r),subject:i("subject",r),keywords:i("keywords","http://schemas.openxmlformats.org/package/2006/metadata/core-properties"),created:i("created",n),modified:i("modified",n)}}function $(t="ppt-node"){return`${t}-${Date.now()}-${Math.floor(1e4*Math.random())}`}function v(t,e,r){{const n=`[pptx-parser ${t.toUpperCase()}]`;void 0!==r?console[t](n,e,r):console[t](n,e)}}class S{constructor(t,e,r,n={},i={},s={}){this.id=t,this.rect=r,this.style={fontSize:14,color:"#333333",fontWeight:"normal",textAlign:"left",backgroundColor:"transparent",borderColor:"#000000",borderWidth:1},this.content=n,this.props=i,this.relsMap=s,this.name="",this.hidden=!1}getContainerStyle(){const{x:t,y:e,width:r,height:n}=this.rect,i=["position: absolute",`left: ${t}px`,`top: ${e}px`,`width: ${r}px`,`height: ${n}px`];return this.hidden&&i.push("display: none"),i.join("; ")}parsePosition(t,e="spPr",n=r.p){const i=f(t,e,n);return i?function(t){const e=f(t,"xfrm",r.a);if(!e)return{x:0,y:0,width:0,height:0};const n=f(e,"off",r.a),i=f(e,"ext",r.a);return{x:n?d(n.getAttribute("x")||"0"):0,y:n?d(n.getAttribute("y")||"0"):0,width:i?d(i.getAttribute("cx")||"0"):0,height:i?d(i.getAttribute("cy")||"0"):0}}(i):{x:0,y:0,width:0,height:0}}parseIdAndName(t,e,n=r.p){const i=f(t,e,n),s=i?f(i,"cNvPr",n):null;return{id:g(s,"id",this.generateId()),name:g(s,"name",""),hidden:m(s,"hidden")}}generateId(){return`el_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getAttributes(t){return u(t)}}class A extends S{constructor(){super(...arguments),this.type="shape"}static fromNode(t,e){try{const n=new A("","shape",{x:0,y:0,width:0,height:0},{},{},e),i=f(t,"nvSpPr",r.p),s=i?f(i,"cNvPr",r.p):null;n.id=g(s,"id",n.generateId()),n.name=g(s,"name",""),n.hidden=m(s,"hidden");const o=i?f(i,"nvPr",r.p):null,a=o?f(o,"ph",r.p):null;n.isPlaceholder=!!a;const l=a?.getAttribute("type");if(l){["title","body","dateTime","slideNumber","footer","other"].includes(l)?n.placeholderType=l:n.placeholderType="other"}const c=f(t,"spPr",r.p);n.parseShapeProperties(c,t);const d=f(t,"txBody",r.p);return d&&n.parseTextBody(d,t,e),n.shapeType=n.detectShapeType(c),n.type=n.text||n.textStyle?"text":"shape",n.rawNode=t,n}catch(t){return console.error("Failed to parse shape element:",t),null}}parseShapeProperties(t,e){if(!t)return;const n=f(t,"xfrm",r.a);if(n){const t=f(n,"off",r.a),e=f(n,"ext",r.a);t&&(this.rect.x=d(t.getAttribute("x")||"0"),this.rect.y=d(t.getAttribute("y")||"0")),e&&(this.rect.width=d(e.getAttribute("cx")||"0"),this.rect.height=d(e.getAttribute("cy")||"0"));const i=n.getAttribute("rot");null!==i&&(this.rotation=parseInt(i)/6e4),this.flipH="1"===n.getAttribute("flipH"),this.flipV="1"===n.getAttribute("flipV")}this.parseFill(t)}parseFill(t){const e=f(t,"solidFill",r.a);if(e){const t=f(e,"srgbClr",r.a);t?.getAttribute("val")&&(this.style.backgroundColor=`#${t.getAttribute("val")}`);const n=f(e,"schemeClr",r.a);n?.getAttribute("val")&&(this.style.backgroundColor=n.getAttribute("val")||"transparent")}f(t,"gradFill",r.a)}parseTextBody(t,e,n){const i=Array.from(t.children).filter(t=>"a:p"===t.tagName||t.tagName.includes(":p"));this.textStyle=i.flatMap(t=>this.parseParagraph(t,e,n)),this.text=this.textStyle.map(t=>t.text).join("");const s=t.querySelector("a\\:p, p\\:p a\\:p"),o=s?f(s,"pPr",r.a):null;o&&(this.paragraphStyle={align:o.getAttribute("algn")||void 0,indent:parseInt(o.getAttribute("indent")||"0")/100,lineSpacing:parseInt(o.getAttribute("lnSpc")||"0")/100,spaceBefore:parseInt(g(f(o,"spcBef",r.a),"spcPts","0"))/100,spaceAfter:parseInt(g(f(o,"spcAft",r.a),"spcPts","0"))/100,rtl:"1"===o.getAttribute("rtl")})}parseParagraph(t,e,n){const i=[];this.bulletStyle=this.parseBulletStyle(t);const s=Array.from(t.children).filter(t=>"a:r"===t.tagName||t.tagName.includes(":r"));for(const t of s){const e=this.parseTextRun(t,n);e&&i.push(e)}const o=f(t,"hlinkClick",r.a);if(o){const t=o.getAttributeNS(r.r,"id")||o.getAttribute("r:id")||"";t&&n[t]&&(this.hyperlink={id:t,url:n[t].target,tooltip:o.getAttribute("tooltip")||void 0})}return i}parseBulletStyle(t){const e=f(t,"pPr",r.a);if(!e)return{};if(f(e,"buNone",r.a))return{type:"none"};const n=f(e,"buChar",r.a);if(n){return{type:"char",char:n.getAttribute("char")||"•",font:n.getAttribute("font")||void 0,color:this.parseColor(n),size:parseInt(n.getAttribute("sz")||"100")/100}}const i=f(e,"buBlip",r.a);if(i){return{type:"blip",imageSrc:i.getAttributeNS(r.r,"embed")||i.getAttribute("r:embed")||""}}const s=f(e,"buAutoNum",r.a);return s?{type:"autoNum",autoNumType:s.getAttribute("type")||"arabic",level:parseInt(s.getAttribute("startAt")||"1")}:{type:"none"}}parseTextRun(t,e){const n=f(t,"rPr",r.a),i=f(t,"t",r.a);if(!i)return null;const s={text:i.textContent||""};if(n){const t=n.getAttribute("sz");t&&(s.fontSize=parseInt(t)/100);const e=f(n,"latin",r.a),i=f(n,"ea",r.a),o=f(n,"cs",r.a),a=e?.getAttribute("typeface"),l=i?.getAttribute("typeface"),c=o?.getAttribute("typeface");a?s.fontFamily=a:l?s.fontFamily=l:c&&(s.fontFamily=c),"1"===n.getAttribute("b")&&(s.bold=!0,this.style.fontWeight="bold"),"1"===n.getAttribute("i")&&(s.italic=!0);const d=n.getAttribute("u");d&&(s.underline="none"===d?"none":"underline"),"1"===n.getAttribute("strike")&&(s.strike=!0);const p=f(n,"solidFill",r.a);if(p){const t=f(p,"srgbClr",r.a);t?.getAttribute("val")&&(s.color=`#${t.getAttribute("val")}`,this.style.color=s.color)}const u=f(n,"highlight",r.a);if(u){const t=f(u,"srgbClr",r.a);t?.getAttribute("val")&&(s.backgroundColor=`#${t.getAttribute("val")}`)}}return s}parseColor(t){const e=f(t,"solidFill",r.a);if(e){const t=f(e,"srgbClr",r.a);if(t?.getAttribute("val"))return`#${t.getAttribute("val")}`}}detectShapeType(t){if(!t)return"rectangle";const e=f(t,"prstGeom",r.a);if(e){const t=e.getAttribute("prst")||"";return{rect:"rectangle",ellipse:"ellipse",roundRect:"roundedRectangle",triangle:"triangle",diamond:"diamond",pentagon:"pentagon",hexagon:"hexagon",octagon:"octagon",star4:"star",star5:"5-point star",star6:"6-point star",star8:"8-point star",star10:"10-point star",star12:"12-point star",star16:"16-point star",star24:"24-point star",star32:"32-point star",heart:"heart",lightning:"lightning",sun:"sun",moon:"moon",cloud:"cloud",arrow:"arrow",bentArrow:"bent arrow",chevron:"chevron",home:"home",cube:"cube",bevel:"bevel",donut:"donut",noSmoking:"noSmoking",blockArc:"blockArc",foldedCorner:"foldedCorner",smileyFace:"smileyFace"}[t]||t}return f(t,"custGeom",r.a)?"custom":"rectangle"}toHTML(){const t=this.getContainerStyle(),e=this.getTextStyle(),r=this.getRotationStyle(),n=[...this.parseStyleString(t),...this.parseStyleString(r)].join("; ");if("text"===this.type&&this.text)return`<div style="${n}">\n        <div style="${e}">${this.escapeHtml(this.text)}</div>\n      </div>`;{const e=this.getShapeStyle();return`<div style="${[...this.parseStyleString(t),...this.parseStyleString(e),...this.parseStyleString(r)].join("; ")}"></div>`}}getTextStyle(){const t=["display: flex","align-items: center","justify-content: this.textStyleFromAlign(this.paragraphStyle?.align)","padding: 10px",`color: ${this.style.color}`,`font-size: ${this.textStyleFromFontSize()}px`];return"bold"===this.style.fontWeight&&t.push("font-weight: bold"),this.style.backgroundColor&&"transparent"!==this.style.backgroundColor&&t.push(`background-color: ${this.style.backgroundColor}`),this.style.borderWidth&&this.style.borderWidth>0&&t.push(`border: ${this.style.borderWidth}px solid ${this.style.borderColor}`),this.textStyle?.[0]?.fontFamily&&t.push(`font-family: ${this.textStyle[0].fontFamily}`),t.join("; ")}getRotationStyle(){return void 0===this.rotation||0===this.rotation?"":`transform: rotate(${this.rotation}deg); transform-origin: center;`}getShapeStyle(){return[`background-color: ${this.style.backgroundColor||"#ffffff"}`,`border: ${this.style.borderWidth}px solid ${this.style.borderColor}`].join("; ")}textStyleFromAlign(t){switch(t){case"right":return"flex-end";case"center":case"justify":return"center";default:return"flex-start"}}textStyleFromFontSize(){return this.textStyle?.[0]?.fontSize?this.textStyle[0].fontSize:this.style.fontSize||14}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}parseStyleString(t){return t.split(";").filter(t=>t.trim())}toParsedElement(){return{id:this.id,type:"shape",rect:this.rect,style:this.style,content:this.content,props:{isPlaceholder:this.isPlaceholder,placeholderType:this.placeholderType,shapeType:this.shapeType,textStyle:this.textStyle,paragraphStyle:this.paragraphStyle,bulletStyle:this.bulletStyle,hyperlink:this.hyperlink,rotation:this.rotation},name:this.name,hidden:this.hidden,text:this.text,textStyle:this.textStyle,attrs:this.getAttributes(this.rawNode),rawNode:this.rawNode}}}class k extends S{constructor(){super(...arguments),this.type="image",this.mediaType="image",this.src="",this.relId=""}static fromNode(t,e){try{const n=new k("","image",{x:0,y:0,width:0,height:0},"",{},e),i=f(t,"nvPicPr",r.p),s=i?f(i,"cNvPr",r.p):null;n.id=g(s,"id",n.generateId()),n.name=g(s,"name",""),n.hidden=m(s,"hidden"),n.altText=g(s,"descr","");f(t,"spPr",r.p);n.rect=n.parsePosition(t);const o=f(t,"blipFill",r.p);let a="";if(o){const t=f(o,"blip",r.a);a=t?.getAttributeNS(r.r,"embed")||t?.getAttribute("r:embed")||""}const l=i?f(i,"nvPr",r.p):null,c=l?f(l,"videoFile",r.a):null,d=l?f(l,"audioFile",r.a):null;return c?(n.mediaType="video",n.videoInfo=n.parseVideoInfo(c,a,e),n.src=n.videoInfo.src,n.relId=a):d?(n.mediaType="audio",n.audioInfo=n.parseAudioInfo(d,a,e),n.src=n.audioInfo.src,n.relId=a):(n.mediaType="image",n.src=n.parseImageSrc(a,e,t),n.relId=a,n.src.endsWith(".png")?n.mimeType="image/png":n.src.endsWith(".jpg")||n.src.endsWith(".jpeg")?n.mimeType="image/jpeg":n.src.endsWith(".gif")?n.mimeType="image/gif":n.src.endsWith(".svg")&&(n.mimeType="image/svg+xml")),n.content={src:n.src,alt:n.altText,mediaType:n.mediaType,videoInfo:n.videoInfo,audioInfo:n.audioInfo},n.props={imgId:a,mimeType:n.mimeType,mediaType:n.mediaType},n.rawNode=t,n}catch(t){return console.error("Failed to parse image element:",t),null}}parseVideoInfo(t,e,n){const i=t.getAttribute("link"),s=t.getAttributeNS(r.r,"link")||"";if(i)return{src:i,type:"link",autoplay:!0,muted:!1,controls:!0,loop:!1};{const t=n[s]?.target||"";return{src:t,type:"blob",format:this.detectVideoFormat(t),autoplay:!1,muted:!1,controls:!0,loop:!1}}}parseAudioInfo(t,e,n){const i=t.getAttribute("link"),s=t.getAttributeNS(r.r,"link")||"";if(i)return{src:i,type:"link",autoplay:!0,muted:!1,controls:!0,loop:!1};{const t=n[s]?.target||"";return{src:t,type:"blob",format:this.detectAudioFormat(t),autoplay:!1,muted:!1,controls:!0,loop:!1}}}parseImageSrc(t,e,r){if(!t||!e[t])return"";return e[t].target}detectVideoFormat(t){return t.endsWith(".mp4")?"mp4":t.endsWith(".webm")?"webm":t.endsWith(".ogg")?"ogg":void 0}detectAudioFormat(t){return t.endsWith(".mp3")?"mp3":t.endsWith(".wav")?"wav":t.endsWith(".ogg")?"ogg":void 0}toHTML(){const t=this.getContainerStyle();return"video"===this.mediaType&&this.videoInfo?this.toVideoHTML(t):"audio"===this.mediaType&&this.audioInfo?this.toAudioHTML(t):this.toImageHTML(t)}toImageHTML(t){const e=["width: 100%","height: 100%","object-fit: contain"].join("; ");return`<div style="${t}">\n      <img src="${this.src}" alt="${this.altText||""}" style="${e}" />\n    </div>`}toVideoHTML(t){const e=this.videoInfo,r=["width: 100%","height: 100%","object-fit: contain"].join("; ");return"link"===e.type?`<div style="${t}">\n        <iframe\n          src="${e.src}"\n          style="${r}"\n          frameborder="0"\n          allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"\n          allowfullscreen>\n        </iframe>\n      </div>`:`<div style="${t}">\n        <video\n          src="${e.src}"\n          style="${r}"\n          ${e.autoplay?"autoplay":""}\n          ${e.muted?"muted":""}\n          ${e.loop?"loop":""}\n          ${e.controls?"controls":""}>\n          ${this.getVideoSourceTag(e.format)}\n        </video>\n      </div>`}getVideoSourceTag(t){if(!t)return"";const e={mp4:"video/mp4",webm:"video/webm",ogg:"video/ogg"}[t];return e?`<source src="${this.videoInfo?.src}" type="${e}" />`:""}toAudioHTML(t){const e=this.audioInfo,r=["width: 100%","display: block"].join("; ");return"link"===e.type?`<div style="${t}">\n        <audio\n          src="${e.src}"\n          style="${r}"\n          ${e.autoplay?"autoplay":""}\n          ${e.muted?"muted":""}\n          ${e.loop?"loop":""}\n          ${e.controls?"controls":""}>\n        </audio>\n      </div>`:`<div style="${t}">\n        <audio id="audio_${this.id}" style="${r}" ${e.controls?"controls":""}>\n          ${this.getAudioSourceTag(e.format)}\n        </audio>\n      </div>`}getAudioSourceTag(t){if(!t)return"";const e={mp3:"audio/mpeg",wav:"audio/wav",ogg:"audio/ogg"}[t];return e?`<source src="${this.audioInfo?.src}" type="${e}" />`:""}toParsedElement(){return{id:this.id,type:"image",rect:this.rect,style:this.style,content:this.content,props:this.props,name:this.name,hidden:this.hidden,relId:this.relId,src:this.src,altText:this.altText,mimeType:this.mimeType,attrs:this.getAttributes(this.rawNode),rawNode:this.rawNode}}}class T extends S{static fromNode(t,e){try{const n=f(t,"oleObj",r.p);if(!n){const n=f(t,"Fallback",r.mc);if(n){const t=f(n,"pic",r.p);if(t){const r=k.fromNode(t,e);if(r)return new T(r.id,r.rect,"",r.relId,{...r.props,isOle:!0,hasFallback:!0},e)}}return null}const i=n.getAttribute("progId")||"",s=n.getAttributeNS(r.r,"id")||n.getAttribute("r:id")||"",o=new T("",{x:0,y:0,width:0,height:0},i,s,{},e),a=f(t,"nvGraphicFramePr",r.p),l=a?f(a,"cNvPr",r.p):null;o.id=g(l,"id",o.generateId()),o.name=g(l,"name",""),o.hidden=m(l,"hidden"),o.oleName=o.name;const c=f(t,"xfrm",r.p);if(c){const t=f(c,"off",r.a),e=f(c,"ext",r.a);t&&e&&(o.rect.x=d(t.getAttribute("x")||"0"),o.rect.y=d(t.getAttribute("y")||"0"),o.rect.width=d(e.getAttribute("cx")||"0"),o.rect.height=d(e.getAttribute("cy")||"0"))}return o.content={},o.props={progId:i,relId:s,hasFallback:!1},o.rawNode=t,o}catch(t){return console.error("Failed to parse OLE element:",t),null}}constructor(t,e,r,n,i={},s={}){super(t,"ole",e,i,s),this.type="ole",this.progId=r,this.relId=n,this.oleName=""}toHTML(){return`<div style="${this.getContainerStyle()}">\n      <div style="${["width: 100%","height: 100%","display: flex","align-items: center","justify-content: center","background-color: #f5f5f5","border: 1px dashed #ccc","color: #666","font-size: 12px","text-align: center","padding: 10px"].join("; ")}">\n        ${this.progId||this.oleName||"OLE Object"}\n      </div>\n    </div>`}toParsedElement(){return{id:this.id,type:"ole",rect:this.rect,style:this.style,content:this.content,props:this.props,name:this.name,hidden:this.hidden,relId:this.relId,progId:this.progId,hasFallback:this.hasFallback,attrs:this.getAttributes(this.rawNode),rawNode:this.rawNode}}}class P extends S{constructor(){super(...arguments),this.type="chart",this.relId=""}static fromNode(t,e){try{const n=f(t,"nvGraphicFramePr",r.p),i=n?f(n,"cNvPr",r.p):null,s=g(i,"id",`chart_${Date.now()}`),o=g(i,"name",""),a=m(i,"hidden"),l=f(t,"xfrm",r.p);let c={x:0,y:0,width:0,height:0};if(l){const t=f(l,"off",r.a),e=f(l,"ext",r.a);t&&(c.x=d(t.getAttribute("x")||"0"),c.y=d(t.getAttribute("y")||"0")),e&&(c.width=d(e.getAttribute("cx")||"0"),c.height=d(e.getAttribute("cy")||"0"))}const p=new P(s,"chart",c,"",{},e);p.name=o,p.hidden=a;const u=f(t,"graphic",r.a),h=u?f(u,"graphicData",r.a):null;if(!h)return null;if(!(h.getAttribute("uri")||"").includes("chart"))return null;const y=f(h,"chart",r.c);if(!y)return null;const b=y.getAttribute("type")||"unknown",x=y.getAttributeNS(r.r,"id")||y.getAttribute("r:id")||"";if(p.chartType=p.detectChartType(y),p.relId=x,p.content={chartType:"unknown",data:[]},p.props={relId:x,chartType:b},p.rawNode=t,x&&e[x]){const t=e[x].target;console.log(`Chart file path: ${t}`)}return p}catch(t){return console.error("Failed to parse chart element:",t),null}}detectChartType(t){const e=Array.from(t.children);for(const t of e){const e=t.tagName;if(e.includes("lineChart"))return"lineChart";if(e.includes("barChart"))return"barChart";if(e.includes("pieChart"))return e.includes("3D")?"pie3DChart":"pieChart";if(e.includes("areaChart"))return"areaChart";if(e.includes("scatterChart"))return"scatterChart"}return"unknown"}toHTML(){const t=this.getContainerStyle(),e=["width: 100%","height: 100%","display: flex","align-items: center","justify-content: center","background-color: #fafafa","border: 1px solid #ddd","color: #333","font-size: 14px","text-align: center","border-radius: 4px","padding: 20px"].join("; "),r=this.getChartLabel();return this.chartData&&Array.isArray(this.chartData.series)&&this.chartData.series.length>0?`<div style="${t}">\n        <div style="width: 100%;">\n          <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">\n            ${this.chartData?.title||"Chart"}\n          </div>\n          ${this.renderChartData()}\n        </div>\n      </div>`:`<div style="${t}">\n      <div style="${e}">\n        ${r}\n      </div>\n    </div>`}getChartLabel(){const t={lineChart:"折线图",barChart:"柱状图",pieChart:"饼图",pie3DChart:"3D饼图",areaChart:"面积图",scatterChart:"散点图",unknown:"图表"};return this.chartType&&t[this.chartType]||"Chart"}renderChartData(){if(!this.chartData||!this.chartData.series)return"";const t=this.chartData;let e='<div style="margin: 10px 0;">';return t.xTitle&&(e+=`<div style="font-size: 12px; color: #666; margin-bottom: 5px;">X轴: ${t.xTitle}</div>`),t.yTitle&&(e+=`<div style="font-size: 12px; color: #666; margin-bottom: 10px;">Y轴: ${t.yTitle}</div>`),e+='<div style="display: flex; flex-wrap: wrap; gap: 10px;">',t.series&&t.series.forEach((t,r)=>{e+=`\n          <div style="\n            background: ${t.color||"#4285f4"};\n            color: white;\n            padding: 10px;\n            border-radius: 4px;\n            min-width: 150px;\n          ">\n            <div style="font-weight: bold;">${t.name||`系列 ${r+1}`}</div>\n            <div style="font-size: 12px; margin-top: 5px;">\n              数据点: ${t.points?.length||0}\n            </div>\n          </div>\n        `}),e+="</div>",e+="</div>",e}toParsedElement(){return{id:this.id,type:"chart",rect:this.rect,style:this.style,content:this.content,props:this.props,name:this.name,hidden:this.hidden,relId:this.relId,chartType:this.chartType,attrs:this.getAttributes(this.rawNode),rawNode:this.rawNode}}}class C extends S{constructor(t,e,r={},n={},i={}){super(t,"diagram",e,r,n,i),this.type="diagram",this.relId=""}static fromNode(t,e){try{const n=f(t,"nvGraphicFramePr",r.p),i=n?f(n,"cNvPr",r.p):null,s=g(i,"id",`diagram_${Date.now()}`),o=g(i,"name",""),a=m(i,"hidden"),l=f(t,"xfrm",r.p);let c={x:0,y:0,width:0,height:0};if(l){const t=f(l,"off",r.a),e=f(l,"ext",r.a);t&&(c.x=d(t.getAttribute("x")||"0"),c.y=d(t.getAttribute("y")||"0")),e&&(c.width=d(e.getAttribute("cx")||"0"),c.height=d(e.getAttribute("cy")||"0"))}const p=new C(s,c,"",{},e);p.name=o,p.hidden=a;const u=f(t,"graphic",r.a),h=u?f(u,"graphicData",r.a):null;if(!h)return null;const y=h.getAttribute("uri")||"";if(!y.includes("diagram"))return null;const b=f(h,"dgm",r.d);if(!b)return null;const x=b.getAttributeNS(r.r,"rel")||b.getAttribute("r:rel")||"";return p.relId=x,p.diagramData=p.parseDiagramData(b,e),p.content={diagramData:p.diagramData},p.props={relId:x,diagramType:y},p.rawNode=t,p}catch(t){return console.error("Failed to parse diagram element:",t),null}}parseDiagramData(t,e){const n={},i=t.getAttributeNS(r.d,"relIds")||"";i&&i.split(",").map(t=>t.trim());const s=f(t,"spTree",r.d);return s&&(n.shapes=this.parseShapes(s)),n}parseShapes(t){const e=[],n=Array.from(t.children);for(const t of n){const n=t.getAttribute("id")||"",i=t.tagName||"shape",s=f(t,"xfrm",r.d);let o;if(s){const t=f(s,"off",r.a),a=f(s,"ext",r.d);if(t){const e=parseInt(t.getAttribute("x")||"0"),r=parseInt(t.getAttribute("y")||"0");o={x:d(e),y:d(r)}}if(a){const t=parseInt(a.getAttribute("cx")||"0"),r=parseInt(a.getAttribute("cy")||"0");e.push({id:n,type:i,position:o,size:{width:d(t),height:d(r)}})}}else e.push({id:n,type:i})}return e}toHTML(){return`<div style="${this.getContainerStyle()}">\n      <div style="${["width: 100%","height: 100%","display: flex","align-items: center","justify-content: center","background-color: #f0f0f0","border: 1px dashed #ccc","color: #666","font-size: 14px","text-align: center","padding: 20px","border-radius: 4px"].join("; ")}">\n        ${this.getDiagramInfo()}\n      </div>\n    </div>`}getDiagramInfo(){const t=this.diagramData?.shapes?.length||0;let e='<div style="text-align: left;">';return e+='<div style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">SmartArt / Diagram</div>',e+=`<div style="margin-bottom: 10px;">形状数量: ${t}</div>`,this.diagramData?.shapes&&t>0&&(e+='<div style="margin-top: 10px;">',this.diagramData.shapes.slice(0,10).forEach((t,r)=>{e+=`<div style="\n          display: inline-block;\n          width: 60px;\n          height: 40px;\n          background: #e0e0e0;\n          border: 1px solid #ccc;\n          border-radius: 4px;\n          margin: 5px;\n          font-size: 12px;\n        ">\n          ${t.type}\n        </div>`}),t>10&&(e+=`<div style="display: inline-block; padding: 10px;">...还有 ${t-10} 个形状</div>`),e+="</div>"),e+="</div>",e}toParsedElement(){return{id:this.id,type:"diagram",rect:this.rect,style:this.style,content:this.content,props:this.props,name:this.name,hidden:this.hidden,attrs:this.getAttributes(this.rawNode),rawNode:this.rawNode}}}class N extends S{constructor(){super(...arguments),this.type="table",this.rows=[],this.colWidths=[]}static fromNode(t,e){try{const n=new N("","table",{x:0,y:0,width:0,height:0},{},{},e),i=f(t,"nvGraphicFramePr",r.p),s=i?f(i,"cNvPr",r.p):null;n.id=g(s,"id",n.generateId()),n.name=g(s,"name",""),n.hidden=!1;const o=f(t,"xfrm",r.p);if(o){const t=f(o,"off",r.a),e=f(o,"ext",r.a);t&&(n.rect.x=d(t.getAttribute("x")||"0"),n.rect.y=d(t.getAttribute("y")||"0")),e&&(n.rect.width=d(e.getAttribute("cx")||"0"),n.rect.height=d(e.getAttribute("cy")||"0"))}const a=f(t,"graphic",r.a),l=a?f(a,"graphicData",r.a):null;if(!l)return null;if(!(l.getAttribute("uri")||"").includes("table"))return null;const c=f(l,"tbl",r.a);return c?(n.parseTable(c),n.tableStyle=n.parseTableStyle(c),n.rtl="1"===c.getAttribute("rtl"),n.content={rows:n.rows,colWidths:n.colWidths,tableStyle:n.tableStyle},n.props={rowCount:n.rows.length,colCount:n.colWidths.length},n.rawNode=t,n):null}catch(t){return console.error("Failed to parse table element:",t),null}}parseTable(t){const e=h(t,"tr",r.a);this.rows=e.map(t=>this.parseTableRow(t));const n=h(t,"gridCol",r.a);this.colWidths=n.map(t=>d(t.getAttribute("w")||"0"))}parseTableRow(t){const e={cells:[],style:{}},n=t.getAttribute("h");n&&(e.height=d(n));const i=h(t,"tc",r.a);return e.cells=i.map(t=>this.parseTableCell(t)),e}parseTableCell(t){const e={style:{}},n=t.getAttribute("rowSpan");n&&(e.rowSpan=parseInt(n));const i=t.getAttribute("gridSpan");i&&(e.colSpan=parseInt(i));const s=f(t,"txBody",r.a);s&&(e.text=function(t){const e=h(t,"p",r.a),n=[];return e.forEach(t=>{h(t,"r",r.a).forEach(t=>{const e=f(t,"t",r.a);e?.textContent&&n.push(e.textContent)})}),n.join("")}(s));const o=f(t,"tcPr",r.a);return o&&this.parseCellStyle(o,e),e}parseCellStyle(t,e){const n=f(t,"tcBdr",r.a);if(n){const t=this.parseBorder(n,"left"),r=this.parseBorder(n,"top");this.parseBorder(n,"right"),this.parseBorder(n,"bottom"),e.style&&(e.style.borderColor=t?.color||r?.color,e.style.borderWidth=r?.width||"1px")}const i=f(t,"fill",r.a);if(i){const t=f(i,"solidFill",r.a);if(t){const n=f(t,"srgbClr",r.a);n?.getAttribute("val")&&(e.style.backgroundColor=`#${n.getAttribute("val")}`)}}const s=t.getAttribute("vAlign");s&&e.style&&(e.style.verticalAlign=s);const o=t.getAttribute("marL"),a=t.getAttribute("marR"),l=t.getAttribute("marT"),c=t.getAttribute("marB");if(e.style){const t=parseInt(o||"0"),r=parseInt(a||"0"),n=parseInt(l||"0"),i=parseInt(c||"0"),s=[];n&&s.push(`${d(n)}px`),r&&s.push(`${d(r)}px`),i&&s.push(`${d(i)}px`),t&&s.push(`${d(t)}px`),s.length>0&&(e.style.padding=s.join(" "))}}parseBorder(t,e){const n=f(t,e,r.a);if(!n)return;const i=n.getAttribute("color");return{color:i?`#${i}`:void 0,width:parseInt(n.getAttribute("sz")||"0")/100+"px"}}parseTableStyle(t){const e={};f(t,"wholeTbl",r.a);const n=f(t,"tblBg",r.a);if(n){const t=f(n,"fill",r.a),i=f(t,"solidFill",r.a),s=f(i,"srgbClr",r.a);s?.getAttribute("val")&&(e.firstRow={backgroundColor:`#${s.getAttribute("val")}`})}const i=f(t,"firstRow",r.a);i&&(e.firstRow=this.parseRowStyle(i));const s=f(t,"lastRow",r.a);s&&(e.lastRow={backgroundColor:this.parseRowBackgroundColor(s)});const o=f(t,"firstCol",r.a);o&&(e.firstCol={backgroundColor:this.parseRowBackgroundColor(o)});const a=f(t,"lastCol",r.a);a&&(e.lastCol={backgroundColor:this.parseRowBackgroundColor(a)});const l=f(t,"band1H",r.a);l&&(e.bandRow={odd:{backgroundColor:this.parseRowBackgroundColor(l)}});const c=f(t,"band2H",r.a);return c&&(e.bandRow||(e.bandRow={}),e.bandRow.even={backgroundColor:this.parseRowBackgroundColor(c)}),e}parseRowStyle(t){const e=f(t,"fill",r.a);if(e){const t=f(e,"solidFill",r.a),n=f(t,"srgbClr",r.a);if(n?.getAttribute("val")){return{backgroundColor:`#${n.getAttribute("val")}`}}}return{}}parseRowBackgroundColor(t){const e=f(t,"fill",r.a);if(e){const t=f(e,"solidFill",r.a),n=f(t,"srgbClr",r.a);if(n?.getAttribute("val"))return`#${n.getAttribute("val")}`}}toHTML(){return`<div style="${this.getContainerStyle()}">\n      <table style="${this.getTableStyle()}">\n        <tbody>\n${this.rows.map(t=>this.rowToHTML(t)).join("\n")}\n        </tbody>\n      </table>\n    </div>`}getTableStyle(){return["width: 100%","height: 100%","border-collapse: collapse","border-spacing: 0"].join("; ")}rowToHTML(t){return`      <tr style="${this.getRowStyle(t)}">\n${t.cells.map(t=>this.cellToHTML(t)).join("\n        ")}\n      </tr>`}getRowStyle(t){const e=[];return t.height&&e.push(`height: ${t.height}px`),t.style?.isHeader&&this.tableStyle?.firstRow?.backgroundColor?e.push(`background-color: ${this.tableStyle.firstRow.backgroundColor}`):t.style?.isFooter&&this.tableStyle?.lastRow?.backgroundColor&&e.push(`background-color: ${this.tableStyle.lastRow.backgroundColor}`),e.join("; ")}cellToHTML(t){const e=this.getCellStyle(t),r=[];t.rowSpan&&t.rowSpan>1&&r.push(`rowspan="${t.rowSpan}"`),t.colSpan&&t.colSpan>1&&r.push(`colspan="${t.colSpan}"`);return`<td${r.length>0?" "+r.join(" "):""} style="${e}">${t.text||""}</td>`}getCellStyle(t){const e=[];return t.style?.backgroundColor&&e.push(`background-color: ${t.style.backgroundColor}`),t.style?.borderColor&&t.style?.borderWidth&&e.push(`border: ${t.style.borderWidth} solid ${t.style.borderColor}`),t.style?.padding&&e.push(`padding: ${t.style.padding}`),t.style?.verticalAlign&&e.push(`vertical-align: ${t.style.verticalAlign}`),e.join("; ")}toParsedElement(){return{id:this.id,type:"table",rect:this.rect,style:this.style,content:this.content,props:this.props,name:this.name,hidden:this.hidden,attrs:this.getAttributes(this.rawNode),rawNode:this.rawNode}}}class I extends S{constructor(){super(...arguments),this.type="group",this.children=[]}static fromNode(t,e){try{const n=new I(`group_${Date.now()}`,"group",{x:0,y:0,width:0,height:0},[],{},e),i=f(t,"grpSpPr",r.p);return n.parseGroupProperties(i,t),Array.from(t.children).forEach(t=>{if(1!==t.nodeType)return;const r=t.tagName;let i=null;"p:sp"===r||"sp"===r?i=A.fromNode(t,e):"p:pic"===r||"pic"===r?i=k.fromNode(t,e):"p:graphicFrame"===r||"graphicFrame"===r?i=n.parseGraphicFrame(t,e):"p:grpSp"!==r&&"grpSp"!==r||(i=I.fromNode(t,e)),i&&n.children.push(i)}),n.content={},n.props={},n.name="分组",n.rawNode=t,n}catch(t){return console.error("Failed to parse group element:",t),null}}parseGraphicFrame(t,e){const n=f(t,"graphic",r.a),i=n?f(n,"graphicData",r.a):null;if(!i)return null;const s=i.getAttribute("uri")||"";return s.includes("oleObject")?T.fromNode(t,e):s.includes("chart")?P.fromNode(t,e):s.includes("diagram")?C.fromNode(t,e):s.includes("table")?N.fromNode(t,e):null}parseGroupProperties(t,e){if(!t)return;const n=f(t,"xfrm",r.a);if(n){const t=f(n,"off",r.a),e=f(n,"ext",r.a),i=f(n,"chOff",r.a),s=f(n,"chExt",r.a);if(i){const t=parseInt(i.getAttribute("x")||"0"),e=parseInt(i.getAttribute("y")||"0");this.childOffset={x:d(t),y:d(e)}}if(e&&s){const r=parseInt(e.getAttribute("cx")||"0"),n=parseInt(e.getAttribute("cy")||"0"),o=parseInt(s.getAttribute("cx")||"0"),a=parseInt(s.getAttribute("cy")||"0");this.childOffset||(this.childOffset={x:0,y:0});let l=0,c=0;i&&(l=parseInt(i.getAttribute("x")||"0"),c=parseInt(i.getAttribute("y")||"0")),t&&(this.childOffset.x+=d(parseInt(t.getAttribute("x")||"0")-l),this.childOffset.y+=d(parseInt(t.getAttribute("y")||"0")-c)),this.rect.x=d(o),this.rect.y=d(a),this.rect.width=d(r-o),this.rect.height=d(n-a)}const o=n.getAttribute("rot");null!==o&&(this.rotation=parseInt(o)/6e4),this.flipH="1"===n.getAttribute("flipH"),this.flipV="1"===n.getAttribute("flipV")}}toHTML(){return`<div class="ppt-group" style="${this.getGroupStyle()}">\n${this.children.map(t=>t.toHTML()).join("\n")}\n    </div>`}getGroupStyle(){const t=["position: absolute",`left: ${this.rect.x}px`,`top: ${this.rect.y}px`,`width: ${this.rect.width}px`,`height: ${this.rect.height}px`];return void 0!==this.rotation&&0!==this.rotation&&(t.push(`transform: rotate(${this.rotation}deg)`),t.push("transform-origin: center center")),this.flipH&&this.flipV?(t.push(`transform: rotate(${this.rotation||0}deg) scale(-1, -1)`),t.push("transform-origin: center center")):this.flipH?(t.push(`transform: rotate(${this.rotation||0}deg) scale(-1, 1)`),t.push("transform-origin: center center")):this.flipV&&(t.push(`transform: rotate(${this.rotation||0}deg) scale(1, -1)`),t.push("transform-origin: center center")),this.childOffset&&(t.push(`margin-left: ${this.childOffset.x}px`),t.push(`margin-top: ${this.childOffset.y}px`)),this.hidden&&t.push("display: none"),t.join("; ")}toParsedElement(){return{id:this.id,type:"group",rect:this.rect,style:this.style,content:this.content,props:{rotation:this.rotation,flipH:this.flipH,flipV:this.flipV,childOffset:this.childOffset},name:this.name,hidden:this.hidden,children:this.children.map(t=>t instanceof A||t instanceof k||t instanceof T||t instanceof P||t instanceof C||t instanceof I?t.toParsedElement():t),attrs:this.getAttributes(this.rawNode),rawNode:this.rawNode}}}function M(t,e){return t.textStyle||t.style?t.textStyle||t.style:t.isPlaceholder&&t.placeholderType?function(t,e){if(e.layout?.textStyles){const r=F(e.layout.textStyles,t);if(r)return r}if(e.master?.textStyles){const r=F(e.master.textStyles,t);if(r)return r}return{fontSize:14,color:"#333333",fontWeight:"normal",fontFamily:"Arial",align:"left"}}(t.placeholderType,e):{fontSize:14,color:"#333333",fontWeight:"normal",fontFamily:"Arial",align:"left"}}function F(t,e){switch(e){case"title":case"ctrTitle":case"subTitle":return L(t.titleParaPr);case"body":case"obj":case"chart":case"table":case"dgm":return L(t.bodyPr);default:return L(t.otherPr)}}function L(t){if(!t)return null;const e={},n=f(t,"defRPr",r.a);if(n){const t=f(n,"sz",r.a);if(t){const r=parseInt(t.getAttribute("val")||"0",10)/100;e.fontSize=r}const i=f(n,"solidFill",r.a);if(i){const t=f(i,"srgbClr",r.a);t?.getAttribute("val")&&(e.color=`#${t.getAttribute("val")}`);const n=f(i,"schemeClr",r.a);n?.getAttribute("val")&&(e.color=n.getAttribute("val"))}const s=f(n,"latin",r.a);s?.getAttribute("typeface")&&(e.fontFamily=s.getAttribute("typeface"));const o=f(n,"b",r.a);o&&(e.fontWeight="1"===o.getAttribute("val")||"true"===o.getAttribute("val")?"bold":"normal");const a=f(n,"i",r.a);a&&(e.italic="1"===a.getAttribute("val")||"true"===a.getAttribute("val"));const l=f(n,"u",r.a);l&&(e.underline=l.getAttribute("val")||"sng");const c=f(n,"strike",r.a);c&&(e.strike="1"===c.getAttribute("val")||"true"===c.getAttribute("val"))}const i=t.getAttribute("algn");return i&&(e.align=i),Object.keys(e).length>0?e:null}function j(t,e,r,n){if(!t.elements||!Array.isArray(t.elements))return;const i=function(t,e,r,n){return{slide:t,layout:e,master:r,theme:n}}(t,e,r,n);t.elements.forEach(t=>{"shape"!==t.type&&"text"!==t.type||function(t,e){if(t.textStyle&&t.textStyle.length>0)return;if(t.isPlaceholder&&t.placeholderType){const r=M(t,e);r&&(t.style={...t.style,...r})}}(t,i)})}function R(t,e={},r){if(!t||!t.type)return null;switch(t.type){case"shape":case"text":{const r=new A(t.id,t.type,t.rect,t.content,t.props,e);return Object.assign(r,t),r}case"image":{let n=t.src||"";r&&t.relId&&r.has(t.relId)&&(n=r.get(t.relId)||n);const i=new k(t.id,t.rect,n,t.relId||"",t.props||{},e);return Object.assign(i,t),i.src=n,i}case"ole":{const r=new T(t.id,t.rect,t.progId,t.relId,t.props,e);return Object.assign(r,t),r}case"chart":{const r=new P(t.id,"chart",t.rect,t.content,t.props,e);return Object.assign(r,t),r}case"table":{const r=new N(t.id,t.rect,t.content,t.props,e);return Object.assign(r,t),r}case"diagram":{const r=new C(t.id,t.rect,t.content,t.props,e);return Object.assign(r,t),r}case"group":{const r=new I(t.id,t.rect,t.props,e);return Object.assign(r,t),r}default:return null}}class E{constructor(t,e,r,n,i){this.id=t.id,this.title=t.title,this.background="string"==typeof t.background?t.background:"",this.elements=e,this.rawResult=t,this.layout=r,this.master=n,this.mediaMap=i}toHTML(){!this.rawResult.styleApplied&&this.layout&&(j(this.rawResult,this.layout,this.master),this.rawResult.styleApplied=!0);const t=[`width: ${960}px`,`height: ${540}px`,"position: relative",this.getSlideBackground(),"overflow: hidden"].join("; "),e=this.renderLayoutElements(),r=this.elements.map(t=>t.toHTML()).join("\n");return`<div class="ppt-slide" style="${t}" data-slide-id="${this.id}" data-slide-title="${this.escapeHtml(this.title)}">\n${e}\n${r}\n    </div>`}renderLayoutElements(){const t=[];return this.master?.elements&&this.master.elements.length>0&&this.master.elements.forEach(e=>{if(e instanceof S)e.hidden||t.push(`<div class="ppt-master-element">${e.toHTML()}</div>`);else{const r=R(e,this.master.relsMap||{},this.mediaMap);if(r&&!e.hidden){const e=r.toHTML();t.push(`<div class="ppt-master-element">${e}</div>`)}}}),this.layout?.elements&&this.layout.elements.length>0&&this.layout.elements.forEach(e=>{if(e instanceof S)e.isPlaceholder||e.hidden||t.push(`<div class="ppt-layout-element">${e.toHTML()}</div>`);else{const r=R(e,this.layout.relsMap||{},this.mediaMap);if(r&&e.type&&!e.hidden&&!e.isPlaceholder){const e=r.toHTML();t.push(`<div class="ppt-layout-element">${e}</div>`)}}}),t.join("\n")}getSlideBackground(){const t=this.rawResult.background;if(!t)return"background-color: #ffffff;";if("string"==typeof t)return`background-color: ${t};`;if("color"===t.type&&t.value)return`background-color: ${t.value};`;if("image"===t.type){const e=t.value||t.relId;if(e)return`background-image: url('${e}'); background-size: cover; background-position: center;`}return"background-color: #ffffff;"}toHTMLString(){const t=["width: 960px","height: 540px","margin: 20px auto","border: 1px solid #ccc","box-shadow: 0 2px 8px rgba(0,0,0,0.1)",`background-color: ${this.background}`,"position: relative","overflow: hidden"].join("; "),e=this.toHTML();return`<div class="ppt-slide-container" style="${t}">\n      <div class="ppt-slide-header" style="padding: 10px; background: #f5f5f5; border-bottom: 1px solid #ddd; font-size: 14px; font-weight: bold;">\n        ${this.escapeHtml(this.title)}\n      </div>\n      ${e}\n    </div>`}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}}class D{constructor(t,e,r,n=960,i=540,s){this.id=t,this.title=e,this.slides=r,this.width=n,this.height=i,this.ratio=n/i,this.author=s}static fromParseResult(t){const e=t.slides.map(t=>{const{createElementFromData:e}=require("../elements"),r=(t.elements||[]).map(r=>r instanceof S?r:e(r,t.relsMap||{})).filter(t=>null!==t);return new E(t,r,t.layout,t.master)});return new D(t.id,t.title,e,t.props.width||960,t.props.height||540,t.author)}toHTML(){const t=[`width: ${this.width}px`,`min-height: ${this.height}px`,"margin: 20px auto","padding: 20px","background: #f9f9f9","border: 1px solid #ddd"].join("; "),e=this.slides.map(t=>t.toHTMLString()).join("\n\n");return`<!DOCTYPE html>\n<html lang="zh-CN">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>${this.escapeHtml(this.title)}</title>\n  <style>\n    .ppt-slide-container {\n      page-break-after: always;\n    }\n    .ppt-slide-container:last-child {\n      page-break-after: auto;\n    }\n  </style>\n</head>\n<body>\n  <div style="${t}">\n    <h1 style="text-align: center; margin-bottom: 30px;">${this.escapeHtml(this.title)}</h1>\n${e}\n  </div>\n</body>\n</html>`}toHTMLWithNavigation(){const t=this.slides.map((t,e)=>`\n        <div class="ppt-slide-page" data-index="${e}" style="display: ${0===e?"block":"none"};">\n          ${t.toHTML()}\n        </div>\n      `).join("\n"),e=`\n      <div style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000;">\n        <button onclick="prevSlide()" style="padding: 10px 20px; margin-right: 10px; cursor: pointer;">上一页</button>\n        <span id="slideCounter" style="padding: 10px;">1 / ${this.slides.length}</span>\n        <button onclick="nextSlide()" style="padding: 10px 20px; margin-left: 10px; cursor: pointer;">下一页</button>\n      </div>\n    `,r=`\n      <script>\n        let currentSlide = 0;\n        const slides = document.querySelectorAll('.ppt-slide-page');\n\n        function showSlide(index) {\n          slides.forEach((slide, i) => {\n            slide.style.display = i === index ? 'block' : 'none';\n          });\n          document.getElementById('slideCounter').textContent = (index + 1) + ' / ${this.slides.length}';\n          currentSlide = index;\n        }\n\n        function prevSlide() {\n          showSlide(Math.max(0, currentSlide - 1));\n        }\n\n        function nextSlide() {\n          showSlide(Math.min(${this.slides.length} - 1, currentSlide + 1));\n        }\n\n        document.addEventListener('keydown', (e) => {\n          if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') prevSlide();\n          if (e.key === 'ArrowRight' || e.key === 'ArrowDown') nextSlide();\n        });\n      <\/script>\n    `;return`<!DOCTYPE html>\n<html lang="zh-CN">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>${this.escapeHtml(this.title)}</title>\n  <style>\n    * { margin: 0; padding: 0; box-sizing: border-box; }\n    body {\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      min-height: 100vh;\n      background: #333;\n    }\n    .ppt-wrapper {\n      width: ${this.width}px;\n      height: ${this.height}px;\n      background: #fff;\n      box-shadow: 0 4px 20px rgba(0,0,0,0.3);\n    }\n  </style>\n</head>\n<body>\n  <div class="ppt-wrapper">\n${t}\n  </div>\n${e}\n${r}\n</body>\n</html>`}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}}class H extends S{constructor(t,e,r,n={}){super(t,"placeholder",r,{},n,{}),this.type="placeholder",this.placeholderType=e,this.isPlaceholder=!0,this.idx=n.idx,this.name=n.name,this.text=n.text,this.textStyle=n.textStyle}toHTML(){const t=[this.getContainerStyle(),"pointer-events: none","user-select: none"].join("; "),e=this.getPlaceholderContent();return`<div class="ppt-placeholder" data-placeholder-type="${this.placeholderType}" style="${t}">\n${e}\n</div>`}getPlaceholderContent(){switch(this.placeholderType){case"title":return this.isContentSet?this.renderTextContent():'<span class="placeholder-label">点击添加标题</span>';case"body":return this.isContentSet?this.renderTextContent():'<span class="placeholder-label">点击添加文本</span>';case"slideNumber":return'<span class="slide-number"></span>';case"footer":return this.text||'<span class="footer-text"></span>';case"dateTime":return this.text||'<span class="date-time"></span>';default:return this.text||""}}renderTextContent(){return this.text?this.textStyle&&this.textStyle.length>0?this.textStyle.map(t=>`<span style="${this.getTextRunStyle(t)}">${t.text}</span>`).join(""):`<span style="color: inherit;">${this.text}</span>`:""}get isContentSet(){return!(!this.text||!this.text.trim())}getTextRunStyle(t){const e=[];return t.fontSize&&e.push(`font-size: ${t.fontSize}px`),t.fontFamily&&e.push(`font-family: ${t.fontFamily}`),t.color&&e.push(`color: ${t.color}`),t.bold&&e.push("font-weight: bold"),t.italic&&e.push("font-style: italic"),t.underline&&e.push("text-decoration: underline"),e.join("; ")}}class z extends S{constructor(t,e,r=[],n={}){super(t,"layout",{x:0,y:0,width:960,height:540},{},n,{}),this.type="layout",this.name=e,this.placeholders=r,this.textStyles=n.textStyles,this.background=n.background}static fromResult(t){const e=(t.placeholders||[]).map(t=>new H(t.id,t.type,t.rect,{idx:t.idx,name:t.name,rawNode:t.rawNode}));return new z(t.id,t.name,e,{textStyles:t.textStyles,background:t.background,relsMap:t.relsMap,colorMap:t.colorMap})}toHTML(){const t=this.getBackgroundStyle(),e=[this.getContainerStyle(),t].join("; "),r=this.placeholders.map(t=>t.toHTML()).join("\n");return`<div class="ppt-layout" style="${e}" data-layout-id="${this.id}" data-layout-name="${this.name||""}">\n${r}\n</div>`}getBackgroundStyle(){return this.background?"color"===this.background.type&&this.background.value?`background-color: ${this.background.value};`:"image"===this.background.type&&this.background.relId?`background-image: url('${this.background.relId}'); background-size: cover;`:"background-color: transparent;":"background-color: transparent;"}}class O extends S{constructor(t,e=[],r=[],n={}){super(t,"master",{x:0,y:0,width:960,height:540},{},n,{}),this.type="master",this.masterId=n.masterId,this.elements=e,this.placeholders=r,this.textStyles=n.textStyles,this.background=n.background,this.colorMap=n.colorMap||{}}static fromResult(t){const e=(t.placeholders||[]).map(t=>new H(t.id,t.type||"other",t.rect||{x:0,y:0,width:100,height:50},{idx:t.idx,name:t.name}));return new O(t.id,[],e,{masterId:t.masterId,textStyles:t.textStyles,background:t.background,colorMap:t.colorMap,relsMap:t.relsMap})}toHTML(){const t=["width: 100%","height: 100%","position: absolute","top: 0","left: 0",this.getBackgroundStyle(),"pointer-events: none","z-index: 0"].join("; "),e=this.elements.map(t=>t.toHTML()).join("\n"),r=this.placeholders.map(t=>t.toHTML()).join("\n");return`<div class="ppt-master" style="${t}" data-master-id="${this.id}">\n${r}\n${e}\n</div>`}getBackgroundStyle(){return this.background?"color"===this.background.type&&this.background.value?`background-color: ${this.background.value};`:"image"===this.background.type&&this.background.relId?`background-image: url('${this.background.relId}'); background-size: cover;`:"background-color: transparent;":"background-color: transparent;"}getPlaceholderStyle(t){if(!this.textStyles)return null;switch(t){case"title":return this.parseParagraphProperties(this.textStyles.titleParaPr);case"body":return this.parseParagraphProperties(this.textStyles.bodyPr);default:return this.parseParagraphProperties(this.textStyles.otherPr)}}parseParagraphProperties(t){return t?{}:null}}class W extends S{constructor(t,e=[],r=[],n=[],i={}){super(t,"tags",{x:0,y:0,width:0,height:0},{},i,{}),this.type="tags",this.tags=e,this.customProperties=r,this.extensions=n,this.slideId=i.slideId}static fromResult(t){return new W(t.id,t.tags,t.customProperties,t.extensions,{slideId:t.slideId})}toHTML(){if(!(this.tags.length>0||this.customProperties.length>0))return"";return`<div class="ppt-tags" style="${["display: none",`data-tags-id="${this.id}"`,`data-slide-id="${this.slideId||""}"`].join("; ")}" ${this.tags.length>0?`data-tags='${JSON.stringify(this.tags)}'`:""} ${this.customProperties.length>0?`data-custom-props='${JSON.stringify(this.customProperties)}'`:""} ${this.extensions.length>0?`data-extensions='${JSON.stringify(this.extensions)}'`:""}>\n</div>`}toHTMLDebug(){const t=["position: absolute","top: 10px","right: 10px","background: rgba(0, 0, 0, 0.8)","color: white","padding: 10px","border-radius: 4px","font-size: 12px","max-width: 300px","z-index: 1000","pointer-events: none"].join("; ");let e=`<strong>Tags (${this.tags.length}):</strong>`;return this.tags.length>0&&(e+="<ul>",this.tags.forEach(t=>{e+=`<li>${t.name}: ${t.value}</li>`}),e+="</ul>"),this.customProperties.length>0&&(e+=`<strong>Properties (${this.customProperties.length}):</strong><ul>`,this.customProperties.forEach(t=>{e+=`<li>${t.name}: ${t.value} (${t.type})</li>`}),e+="</ul>"),`<div class="ppt-tags-debug" style="${t}">\n${e}\n</div>`}getTag(t){return this.tags.find(e=>e.name===t)?.value}getProperty(t){return this.customProperties.find(e=>e.name===t)?.value}setTag(t,e){const r=this.tags.find(e=>e.name===t);r?r.value=e:this.tags.push({name:t,value:e})}setProperty(t,e,r){const n=this.customProperties.find(e=>e.name===t);n?(n.value=e,r&&(n.type=r)):this.customProperties.push({name:t,value:e,type:r})}}class B extends S{constructor(t,e=[],r=[],n={}){super(t,"notesMaster",{x:0,y:0,width:800,height:600},{},n,{}),this.type="notesMaster",this.elements=e,this.placeholders=r,this.background=n.background}static fromResult(t){return new B(t.id,[],t.placeholders||[],{background:t.background,relsMap:t.relsMap})}toHTML(){const t=this.getBackgroundStyle(),e=[this.getContainerStyle(),t].join("; "),r=this.elements.map(t=>t.toHTML()).join("\n");return`<div class="ppt-notes-master" style="${e}" data-notes-master-id="${this.id}">\n${r}\n</div>`}getBackgroundStyle(){return this.background?"color"===this.background.type&&this.background.value?`background-color: ${this.background.value};`:"image"===this.background.type&&this.background.relId?`background-image: url('${this.background.relId}'); background-size: cover;`:"background-color: #ffffff;":"background-color: #ffffff;"}}class _ extends S{constructor(t,e,r={}){super(t,"notesSlide",e,{},r,{}),this.type="notesSlide",this.text=r.text,this.masterRef=r.masterRef,this.slideId=r.slideId}static fromResult(t){return new _(t.id,{x:0,y:0,width:800,height:600},{text:t.text,masterRef:t.masterRef,slideId:t.slideId,elements:t.elements,background:t.background,relsMap:t.relsMap})}toHTML(){const t=[this.getContainerStyle(),"background: #fff","padding: 20px","border: 1px solid #ddd","border-radius: 4px"].join("; ");let e="";return this.slideId&&(e+=`<div style="font-weight: bold; margin-bottom: 10px;">幻灯片 ${this.slideId} 备注</div>`),this.text?e+=`<div style="font-size: 14px; line-height: 1.6;">${this.text}</div>`:e+='<div style="color: #999; font-style: italic;">无备注内容</div>',`<div class="ppt-notes-slide" style="${t}" data-notes-id="${this.id}" data-slide-id="${this.slideId||""}">\n${e}\n</div>`}setMaster(t){this.master=t}}class X extends S{constructor(t,e,r=960,n=540,i={}){super(t,"document",{x:0,y:0,width:r,height:n},{},i,{}),this.type="document",this.title=e,this.width=r,this.height=n,this.ratio=r/n,this.pageSize=i.pageSize||"16:9",this.author=i.author,this.subject=i.subject,this.keywords=i.keywords,this.description=i.description,this.created=i.created,this.modified=i.modified,this.slides=[],this.layouts={},this.masters=[],this.tags=[],this.notesMasters=[],this.notesSlides=[],this.globalRelsMap=i.globalRelsMap||{},this.mediaMap=i.mediaMap}static fromParseResult(t){const e=new X(t.id,t.title,t.props.width||960,t.props.height||540,{pageSize:t.props.pageSize,author:t.author,subject:t.subject,keywords:t.keywords,description:t.description,created:t.created,modified:t.modified,globalRelsMap:t.globalRelsMap,mediaMap:t.mediaMap});return t.masterSlides&&t.masterSlides.length>0&&(e.masters=t.masterSlides.map(t=>O.fromResult(t))),t.slideLayouts&&Object.entries(t.slideLayouts).forEach(([t,r])=>{e.layouts[t]=z.fromResult(r)}),t.notesMasters&&t.notesMasters.length>0&&(e.notesMasters=t.notesMasters.map(t=>B.fromResult(t))),t.notesSlides&&t.notesSlides.length>0&&(e.notesSlides=t.notesSlides.map(t=>{const r=_.fromResult(t);if(t.masterRef){const n=e.notesMasters.find(e=>e.id===t.masterRef);n&&r.setMaster(n)}return r})),t.tags&&t.tags.length>0&&(e.tags=t.tags.map(t=>W.fromResult(t))),t.slides&&t.slides.length>0&&(e.slides=t.slides.map(t=>{const r=(t.elements||[]).map(r=>r instanceof S?r:R(r,t.relsMap||{},e.mediaMap)).filter(t=>null!==t),n=t.layout,i=t.master;return new E(t,r,n,i,e.mediaMap)})),e}toHTML(t={}){return!1!==t.withNavigation?this.toHTMLWithNavigation(t):this.toHTMLDocument(t)}toHTMLDocument(t={}){const e=[`max-width: ${this.width}px`,"margin: 0 auto","padding: 20px","background: #f5f5f5"].join("; "),r=this.slides.map(t=>t.toHTML()).join("\n\n"),n=!1!==t.includeStyles?this.generateStyles(t):"";return`<!DOCTYPE html>\n<html lang="zh-CN">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>${this.escapeHtml(this.title)}</title>\n  ${n?"<style>\n"+n+"\n</style>":""}\n</head>\n<body>\n  <div class="ppt-container" style="${e}">\n    <div class="ppt-header" style="text-align: center; padding: 20px 0; margin-bottom: 20px; border-bottom: 1px solid #ddd;">\n      <h1>${this.escapeHtml(this.title)}</h1>\n      ${this.author?`<p style="color: #666; font-size: 14px;">作者: ${this.escapeHtml(this.author)}</p>`:""}\n    </div>\n    <div class="ppt-slides">\n${r}\n    </div>\n  </div>\n</body>\n</html>`}toHTMLWithNavigation(t={}){const e=this.slides.map((t,e)=>`\n        <div class="ppt-slide-page" data-index="${e}" style="display: ${0===e?"block":"none"};">\n          ${t.toHTML()}\n        </div>\n      `).join("\n"),r=`\n      <div class="ppt-navigation" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 25px;">\n        <button onclick="prevSlide()" style="padding: 8px 16px; cursor: pointer; background: #fff; border: none; border-radius: 4px; font-size: 14px;">上一页</button>\n        <span id="slideCounter" style="color: #fff; font-size: 14px; min-width: 60px; text-align: center;">1 / ${this.slides.length}</span>\n        <button onclick="nextSlide()" style="padding: 8px 16px; cursor: pointer; background: #fff; border: none; border-radius: 4px; font-size: 14px;">下一页</button>\n      </div>\n    `,n=`\n      <script>\n        let currentSlide = 0;\n        const slides = document.querySelectorAll('.ppt-slide-page');\n\n        function showSlide(index) {\n          slides.forEach((slide, i) => {\n            slide.style.display = i === index ? 'block' : 'none';\n          });\n          document.getElementById('slideCounter').textContent = (index + 1) + ' / ${this.slides.length}';\n          currentSlide = index;\n        }\n\n        function prevSlide() {\n          showSlide(Math.max(0, currentSlide - 1));\n        }\n\n        function nextSlide() {\n          showSlide(Math.min(${this.slides.length} - 1, currentSlide + 1));\n        }\n\n        document.addEventListener('keydown', (e) => {\n          if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') prevSlide();\n          if (e.key === 'ArrowRight' || e.key === 'ArrowDown') nextSlide();\n        });\n\n        // 触摸滑动支持\n        let touchStartX = 0;\n        let touchEndX = 0;\n        document.addEventListener('touchstart', e => {\n          touchStartX = e.changedTouches[0].screenX;\n        });\n        document.addEventListener('touchend', e => {\n          touchEndX = e.changedTouches[0].screenX;\n          if (touchStartX - touchEndX > 50) nextSlide();\n          if (touchEndX - touchStartX > 50) prevSlide();\n        });\n      <\/script>\n    `,i=!1!==t.includeStyles?this.generateStyles(t):this.generateNavigationStyles();return`<!DOCTYPE html>\n<html lang="zh-CN">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>${this.escapeHtml(this.title)}</title>\n  ${i?"<style>\n"+i+"\n</style>":""}\n</head>\n<body>\n  <div class="ppt-wrapper">\n${e}\n  </div>\n${r}\n${!1!==t.includeScripts?n:""}\n</body>\n</html>`}generateStyles(t){const e=["/* PPTX 文档基础样式 */","* { box-sizing: border-box; margin: 0; padding: 0; }","","body {",'  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;',"  background: #333;","  min-height: 100vh;","}","",".ppt-wrapper {","  display: flex;","  justify-content: center;","  align-items: center;","  min-height: 100vh;","  padding: 20px;","}","",".ppt-container {","  background: #fff;","  box-shadow: 0 2px 8px rgba(0,0,0,0.1);","}","","/* 幻灯片样式 */",".ppt-slide {","  position: relative;","  margin: 20px auto;","  border: 1px solid #ddd;","  background: #fff;","}","",".ppt-slide-page {",`  width: ${this.width}px;`,`  height: ${this.height}px;`,"  background: #fff;","  box-shadow: 0 4px 20px rgba(0,0,0,0.3);","}","","/* 布局和母版元素 */",".ppt-master-element,",".ppt-layout-element {","  pointer-events: none;","}","","/* 元素通用样式 */",".ppt-element {","  position: absolute;","}","","/* 文本元素 */",".ppt-text {","  overflow: hidden;","}","","/* 占位符样式 */",".ppt-placeholder {","  pointer-events: none;","  user-select: none;","}",""];return t.customCss&&(e.push("/* 自定义样式 */"),e.push(t.customCss)),e.join("\n")}generateNavigationStyles(){return`* { margin: 0; padding: 0; box-sizing: border-box; }\nbody {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  min-height: 100vh;\n  background: #333;\n}\n.ppt-wrapper {\n  width: ${this.width}px;\n  height: ${this.height}px;\n  background: #fff;\n  box-shadow: 0 4px 20px rgba(0,0,0,0.3);\n}`}getSlide(t){return this.slides[t]}getLayout(t){return this.layouts[t]}getMaster(t){return this.masters.find(e=>e.id===t)}escapeHtml(t){const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return t.replace(/[&<>"']/g,t=>e[t])}}function V(t){return X.fromParseResult(t)}function U(t,e){const n=t.tagName;if("p:sp"===n||"sp"===n)return A.fromNode(t,e);if("p:pic"===n||"pic"===n)return k.fromNode(t,e);if("p:graphicFrame"===n||"graphicFrame"===n){const n=f(t,"graphic",r.a),i=n?f(n,"graphicData",r.a):null;if(!i)return null;const s=i.getAttribute("uri")||"";return s.includes("oleObject")?T.fromNode(t,e):s.includes("chart")?P.fromNode(t,e):s.includes("diagram")?C.fromNode(t,e):s.includes("table")?N.fromNode(t,e):null}return"p:grpSp"===n||"grpSp"===n?I.fromNode(t,e):null}async function G(t,e,r=a){try{const n=`${r}${e}.xml.rels`,i=await(t.file(n)?.async("string"));return i?x(i,"_rels/.rels"):{}}catch(t){return v("warn",`Failed to parse ${r}${e} relationships`,t),{}}}function q(t,e={},n=0){try{const i=new DOMParser,s=i.parseFromString(t,"application/xml").documentElement;if("p:sld"!==s.tagName&&!s.tagName.includes("sld"))return v("warn","Invalid slide XML root element",s.tagName),Z(n);const o=Y(s,e),a=function(t,e){const n=f(t,"cSld",r.p);if(!n)return`幻灯片 ${e+1}`;const i=f(n,"spTree",r.p);if(!i)return`幻灯片 ${e+1}`;const s=h(i,"sp",r.p);for(const t of s){const e=f(t,"nvSpPr",r.p);if(!e)continue;const n=f(e,"nvPr",r.p);if(!n)continue;const i=f(n,"ph",r.p);if(!i)continue;const s=i.getAttribute("type");if("title"===s||"ctrTitle"===s){const e=f(t,"txBody",r.p);if(!e)continue;const n=J(e);if(n&&n.trim())return n.trim()}}return`幻灯片 ${e+1}`}(s,n),l=function(t,e){const n=[],i=f(t,"cSld",r.p);if(!i)return v("warn","cSld element not found"),n;const s=f(i,"spTree",r.p);if(!s)return v("warn","spTree element not found"),n;return v("info","Processing spTree children..."),Array.from(s.children).forEach((t,i)=>{if(1!==t.nodeType)return;const s=t.tagName,o=t.localName||s.split(":").pop()||s;v("info",`Processing element ${i}: tagName=${s}, localName=${o}`);let a=null;"sp"===o?a=A.fromNode(t,e):"pic"===o?a=k.fromNode(t,e):"graphicFrame"===o?a=function(t,e){try{const n=f(t,"graphic",r.a),i=n?f(n,"graphicData",r.a):null;if(!i)return v("warn","graphicData not found in graphicFrame"),null;const s=i.getAttribute("uri")||"";return s.includes("oleObject")?T.fromNode(t,e):s.includes("chart")?P.fromNode(t,e):s.includes("diagram")?C.fromNode(t,e):s.includes("table")?N.fromNode(t,e):(v("info",`Unknown graphicFrame type: ${s}`),null)}catch(t){return v("error","Failed to parse graphicFrame element",t),null}}(t,e):"grpSp"===o?a=I.fromNode(t,e):v("info",`Skipping unknown element type: tagName=${s}, localName=${o}`),a&&n.push(a)}),v("info",`Total elements parsed: ${n.length}`),n}(s,e);return v("info",`Parsed slide ${n+1}: ${l.length} elements`),{id:$("slide"),title:a,background:o,elements:l.map(t=>t),relsMap:e}}catch(t){return v("error",`Failed to parse slide ${n}`,t),Z(n)}}function Y(t,e={}){const n=f(t,"bg",r.p);if(!n)return{type:"color",value:"#ffffff"};const i=f(n,"bgRef",r.p);if(i)return function(t){t.getAttribute("idx");const e=f(t,"schemeClr",r.a);if(e){const t=e.getAttribute("val");if(t)return{type:"color",value:t,schemeRef:t}}return{type:"color",value:"#ffffff"}}(i);const s=f(n,"bgPr",r.p);if(s){const t=f(s,"blipFill",r.a);if(t){const n=f(t,"blip",r.a);if(n){const t=n.getAttribute("r:embed")||n.getAttributeNS(r.r,"embed");if(t&&e[t])return{type:"image",value:e[t].target,relId:t}}}const n=f(s,"solidFill",r.a);if(n){const t=f(n,"srgbClr",r.a);if(t?.getAttribute("val"))return{type:"color",value:`#${t.getAttribute("val")}`};const e=f(n,"schemeClr",r.a);if(e){const t=e.getAttribute("val");if(t)return{type:"color",value:t||"#ffffff",schemeRef:t||void 0}}}if(f(s,"gradFill",r.a))return{type:"color",value:"#ffffff"}}return{type:"color",value:"#ffffff"}}function J(t){const e=Array.from(t.children).filter(t=>"a:p"===t.tagName||t.tagName.includes(":p")),r=[];for(const t of e){const e=Array.from(t.children).filter(t=>"a:r"===t.tagName||t.tagName.includes(":r"));for(const t of e){const e=f(t,"t","http://schemas.openxmlformats.org/drawingml/2006/main");e?.textContent&&r.push(e.textContent)}}return r.join("")}function Z(t){return{id:$("slide"),title:`幻灯片 ${t+1}`,background:"#ffffff",elements:[],relsMap:{}}}async function K(t,e,r,n){if(e.background&&"string"!=typeof e.background){const i=e.background;if("image"===i.type&&i.relId){const e=await Q(t,i.relId,r,n);e&&(i.value=e)}}let i=0;for(const s of e.elements)if("image"===s.type){i++;const o=s,a=o.relId;if(a){v("info",`Found image element in ${e.id}: relId=${a}, src=${o.src}`);const i=await Q(t,a,r,n);i?(o.src=i,v("info",`Updated image src to base64 URL, length=${i.length}`)):v("warn",`Failed to resolve image relId=${a} in ${e.id}`)}else v("warn",`Image element missing relId in ${e.id}`)}i>0&&v("info",`Found ${i} image elements in ${e.id}`)}async function Q(t,e,r,n){if(n.has(e))return v("info",`Cache hit for relId=${e}`),n.get(e);const i=r[e];if(!i)return v("warn",`No relationship found for relId=${e} in relsMap`),null;v("info",`Resolving image relId=${e}, target=${i.target}`);const s=await async function(t,e){v("info",`findImageFileInZip: targetPath=${e}`);let r=await t.file(e);if(r)return{file:r,path:e};if(e.startsWith("..")){const n=`ppt/${e.substring(3)}`;if(r=await t.file(n),r)return{file:r,path:n}}if(e.includes("media/")&&!e.startsWith("ppt/")){const n=`ppt/${e}`;if(r=await t.file(n),r)return{file:r,path:n}}if(e.startsWith("media/")){const n=`ppt/${e}`;if(r=await t.file(n),r)return{file:r,path:n}}const n=["ppt/slideLayouts/","ppt/slideMasters/","ppt/slides/","ppt/notesMasters/","ppt/notesSlides/","ppt/",""];for(const i of n){const n=i+e;if(r=await t.file(n),r)return{file:r,path:n}}const i=[];t.forEach((t,e)=>{i.push({name:t,file:e})});const s=e.split("/").pop()||"";if(s){const t=s.toLowerCase();for(const{name:e,file:r}of i)if((e.split("/").pop()||"").toLowerCase()===t&&e.includes("media/"))return{file:r,path:e};for(const{name:e,file:r}of i)if((e.split("/").pop()||"").toLowerCase()===t)return{file:r,path:e}}const o=[".png",".jpg",".jpeg",".gif",".bmp",".svg",".webp"];for(const{name:t,file:e}of i){const r=t.toLowerCase();for(const n of o)if(r.endsWith(n)&&(r.includes("image")||r.includes("img")))return{file:e,path:t}}v("info",`Could not find image file for target: ${e}`),v("info",`Available files in ZIP (${i.length} total):`);const a=i.filter(({name:t})=>t.includes("media/"));return a.length>0&&(v("info",`Media files (${a.length}):`),a.slice(0,20).forEach(({name:t})=>{v("info",`  - ${t}`)}),a.length>20&&v("info",`  ... and ${a.length-20} more`)),null}(t,i.target);if(!s)return v("warn",`Image file not found in zip after exhaustive search. Original target: ${i.target}`),null;const{file:o,path:a}=s;v("info",`Found image file at: ${a}`);const l=await o.async("base64"),c=function(t){const e=t.split(".").pop()?.toLowerCase();switch(e){case"png":return"image/png";case"jpg":case"jpeg":default:return"image/jpeg";case"gif":return"image/gif";case"bmp":return"image/bmp";case"svg":return"image/svg+xml";case"webp":return"image/webp"}}(a),d=`data:${c};base64,${l}`;return v("info",`Converted image to base64 URL, mimeType=${c}, length=${d.length}`),n.set(e,d),d}async function tt(t,e="ppt/theme/theme1.xml"){try{const r=await(t.file(e)?.async("string"));if(!r)return v("warn",`Theme file not found: ${e}`),null;const n=(new DOMParser).parseFromString(r,"application/xml"),i=function(t){const e={},r=f(t,"themeElements","http://schemas.openxmlformats.org/drawingml/2006/main");if(!r)return e;const n=f(r,"clrScheme","http://schemas.openxmlformats.org/drawingml/2006/main");if(!n)return e;const i={bg1:"bg1",tx1:"tx1",bg2:"bg2",tx2:"tx2",accent1:"accent1",accent2:"accent2",accent3:"accent3",accent4:"accent4",accent5:"accent5",accent6:"accent6",hlink:"hlink",folHlink:"folHlink"};return Array.from(n.children).forEach(t=>{if(1!==t.nodeType)return;const r=t.localName||t.tagName.split(":").pop();r&&i[r]&&(e[i[r]]=function(t){const e=f(t,"srgbClr","http://schemas.openxmlformats.org/drawingml/2006/main");if(e){const t=e.getAttribute("val");if(t)return`#${t}`}const r=f(t,"sysClr","http://schemas.openxmlformats.org/drawingml/2006/main");if(r){const t=r.getAttribute("lastClr");if(t)return`#${t}`}return"#ffffff"}(t))}),e}(n.documentElement);return v("info",`Parsed theme from ${e}`),{colors:i}}catch(t){return v("error",`Failed to parse theme: ${e}`,t),null}}function et(t,e,n){try{const i=new DOMParser,s=i.parseFromString(t,"application/xml").documentElement,o=function(t,e){const r=f(t,"bg","http://schemas.openxmlformats.org/presentationml/2006/main");if(!r)return{type:"color",value:"#ffffff"};const n=f(r,"bgRef","http://schemas.openxmlformats.org/presentationml/2006/main");if(n){n.getAttribute("idx");const t=f(n,"schemeClr","http://schemas.openxmlformats.org/drawingml/2006/main");if(t){const e=t.getAttribute("val");if(e)return{type:"color",value:e,schemeRef:e}}}const i=f(r,"bgPr","http://schemas.openxmlformats.org/presentationml/2006/main");if(i){const t=f(i,"blipFill","http://schemas.openxmlformats.org/drawingml/2006/main");if(t){const r=f(t,"blip","http://schemas.openxmlformats.org/drawingml/2006/main");if(r){const t=r.getAttribute("r:embed")||r.getAttributeNS("http://schemas.openxmlformats.org/officeDocument/2006/relationships","embed");if(t&&e[t])return{type:"image",value:e[t].target,relId:t}}}const r=f(i,"solidFill","http://schemas.openxmlformats.org/drawingml/2006/main");if(r){const t=f(r,"srgbClr","http://schemas.openxmlformats.org/drawingml/2006/main");if(t?.getAttribute("val"))return{type:"color",value:`#${t.getAttribute("val")}`};const e=f(r,"schemeClr","http://schemas.openxmlformats.org/drawingml/2006/main");if(e){const t=e.getAttribute("val");if(t)return{type:"color",value:t||"#ffffff",schemeRef:t||void 0}}}}return{type:"color",value:"#ffffff"}}(s,e),a=function(t){const e=f(t,"clrMapOvr","http://schemas.openxmlformats.org/presentationml/2006/main"),r={};if(!e)return r;const n=f(e,"masterClrMapping","http://schemas.openxmlformats.org/drawingml/2006/main");n&&Array.from(n.attributes).forEach(t=>{r[t.name]=t.value});return r}(s),l=function(t){const e=f(t,"txStyles","http://schemas.openxmlformats.org/presentationml/2006/main");if(!e)return{};return{titleParaPr:f(e,"titleP","http://schemas.openxmlformats.org/presentationml/2006/main"),bodyPr:f(e,"body","http://schemas.openxmlformats.org/presentationml/2006/main"),otherPr:f(e,"other","http://schemas.openxmlformats.org/presentationml/2006/main")}}(s),c=function(t,e){const n=[],i=f(t,"cSld","http://schemas.openxmlformats.org/presentationml/2006/main");if(!i)return n;const s=f(i,"spTree","http://schemas.openxmlformats.org/presentationml/2006/main");return s?(Array.from(s.children).forEach(t=>{if(1!==t.nodeType)return;const i=t.localName||t.tagName.split(":").pop();if("sp"===i){const i=f(t,"nvSpPr",r.p),s=i?f(i,"nvPr",r.p):null,o=s?f(s,"ph",r.p):null;if(o){const e=o.getAttribute("type");if(["sldNum","ftr","dt"].includes(e||"")){const e=function(t){const e=f(t,"nvSpPr",r.p);if(!e)return null;const n=f(e,"cNvPr",r.p),i=n?.getAttribute("id"),s=n?.getAttribute("name"),o=f(e,"nvPr",r.p);if(!o)return null;const a=f(o,"ph",r.p);if(!a)return null;const l=a.getAttribute("type"),c=f(t,"spPr",r.a),d=f(c,"xfrm",r.a);let p={x:0,y:0,width:0,height:0};if(d){const t=f(d,"off",r.a),e=f(d,"ext",r.a);t&&(p.x=parseInt(t.getAttribute("x")||"0"),p.y=parseInt(t.getAttribute("y")||"0")),e&&(p.width=parseInt(e.getAttribute("cx")||"0"),p.height=parseInt(e.getAttribute("cy")||"0"))}return{id:i,name:s,type:"shape",placeholder:l,rect:p}}(t);e&&n.push(e)}}else{const r=A.fromNode(t,e);r&&n.push(r)}}else if("pic"===i){const r=k.fromNode(t,e);r&&n.push(r)}else if("grpSp"===i){const r=I.fromNode(t,e);r&&n.push(r)}else if("graphicFrame"===i){const i=function(t,e){try{const n=f(t,"graphic",r.a),i=n?f(n,"graphicData",r.a):null;if(!i)return null;const s=i.getAttribute("uri")||"";return s.includes("table")?N.fromNode(t,e):s.includes("chart")?P.fromNode(t,e):s.includes("diagram")?C.fromNode(t,e):null}catch(t){return v("warn","Failed to parse master graphicFrame element",t),null}}(t,e);i&&n.push(i)}}),n):n}(s,e),d=c.filter(t=>t.placeholder);let p;for(const t of Object.values(e))if(t.type.includes("theme")){const e=t.target.match(/theme(\d+)\.xml/);e&&(p=`theme${e[1]}`,v("info",`Master references theme: ${p}`))}return{id:`master-${n}`,masterId:`slideMaster${n}`,background:o,elements:c,placeholders:d,colorMap:a,textStyles:l,themeRef:p,relsMap:e}}catch(t){return v("error",`Failed to parse master slide ${n}`,t),{id:`master-${n}`,masterId:`slideMaster${n}`,elements:[],colorMap:{}}}}const rt={slideLayouts:c,slideLayoutsRels:"ppt/slideLayouts/_rels/"};function nt(t,e={}){try{const n=new DOMParser,i=n.parseFromString(t,"application/xml").documentElement;if("p:sldLayout"!==i.tagName&&!i.tagName.includes("sldLayout"))return v("warn","Invalid layout XML root element",i.tagName),null;const s=f(i,"cSld",r.p),o=s?.getAttribute("name")||void 0,a=Y(i,e),l=f(i,"clrMapOvr",r.p),c=f(l,"masterClrMapping",r.a);let d={};if(c){Array.from(c.attributes).forEach(t=>{"xmlns:a"!==t.name&&(d[t.name]=t.value)})}const p=function(t){const e=f(t,"txStyles",r.p);if(!e)return{};return{titleParaPr:f(e,"titleP",r.p),bodyPr:f(e,"body",r.p),otherPr:f(e,"other",r.p)}}(i),u=function(t,e){const n=[],i=f(t,"cSld",r.p);if(!i)return n;const s=f(i,"spTree",r.p);return s?(Array.from(s.children).forEach(t=>{if(1!==t.nodeType)return;const i=t.localName||t.tagName.split(":").pop();if("sp"===i){const i=f(t,"nvPr",r.p);if(!(i?f(i,"ph",r.p):null)){const r=A.fromNode(t,e);r&&n.push(r)}}else if("pic"===i){const r=k.fromNode(t,e);r&&n.push(r)}else if("grpSp"===i){const r=I.fromNode(t,e);r&&n.push(r)}else if("graphicFrame"===i){const i=function(t,e){try{const n=f(t,"graphic",r.a),i=n?f(n,"graphicData",r.a):null;if(!i)return null;const s=i.getAttribute("uri")||"";return s.includes("table")?N.fromNode(t,e):s.includes("chart")?P.fromNode(t,e):s.includes("diagram")?C.fromNode(t,e):null}catch(t){return v("warn","Failed to parse layout graphicFrame element",t),null}}(t,e);i&&n.push(i)}}),n):n}(i,e),h=function(t){const e=[],n=f(t,"cSld",r.p);if(!n)return e;const i=f(n,"spTree",r.p);return i?(Array.from(i.children).forEach(t=>{if(1!==t.nodeType)return;if("sp"===(t.localName||t.tagName.split(":").pop())){const n=function(t){const e=f(t,"nvSpPr",r.p);if(!e)return null;const n=f(e,"cNvPr",r.p),i=n?.getAttribute("id")||"",s=n?.getAttribute("name")||"",o=f(e,"nvPr",r.p);if(!o)return null;const a=f(o,"ph",r.p);if(!a)return null;const l=a.getAttribute("type"),c={title:"title",ctrTitle:"title",body:"body",dt:"dateTime",sldNum:"slideNumber",ftr:"footer"}[l||""]||"other",d=a.getAttribute("idx"),p=f(t,"spPr",r.p),u=f(p,"xfrm",r.a);let h={x:0,y:0,width:0,height:0};if(u){const t=f(u,"off",r.a),e=f(u,"ext",r.a);t&&(h.x=parseInt(t.getAttribute("x")||"0"),h.y=parseInt(t.getAttribute("y")||"0")),e&&(h.width=parseInt(e.getAttribute("cx")||"0"),h.height=parseInt(e.getAttribute("cy")||"0"))}const g=f(t,"txBody",r.p);let m,y;if(g){const t=f(g,"bodyPr",r.a);if(t){const e=t.getAttribute("algn"),r=t.getAttribute("anchor");"l"===e?m="left":"ctr"===e?m="center":"r"===e&&(m="right"),"t"===r?y="top":"ctr"===r?y="middle":"b"===r&&(y="bottom")}}return{id:i,type:c,name:s,rect:h,hAlign:m,vAlign:y,idx:d?parseInt(d):void 0,rawNode:t}}(t);n&&e.push(n)}}),e):e}(i);let g;for(const t of Object.values(e))if(t.type.includes("slideMaster")){const e=t.target.match(/slideMaster(\d+)\.xml/);e&&(g=`slideMaster${e[1]}`,v("info",`Layout references master file: ${g}`))}return{id:$("layout"),name:o,background:a,elements:u,placeholders:h,relsMap:e,colorMap:d,textStyles:p,masterRef:g}}catch(t){return v("error","Failed to parse slide layout",t),null}}async function it(t,e,n){try{const i=new DOMParser,s=i.parseFromString(n,"application/xml").documentElement,o=ot(s),a=lt(s),l=function(t){const e=[],n=f(t,"cSld",r.p);if(!n)return e;const i=f(n,"spTree",r.p);if(!i)return e;const s=Array.from(i.children).filter(t=>"p:sp"===t.tagName||t.tagName.includes(":sp"));for(const t of s){const n=f(t,"nvSpPr",r.p);if(!n)continue;const i=f(n,"nvPr",r.p);if(!i)continue;const s=f(i,"ph",r.p);if(!s)continue;const o=f(n,"cNvPr",r.p),a=g(o,"id",`placeholder_${Date.now()}`),l=g(o,"name",""),c=s.getAttribute("type")||"other",p=f(t,"spPr",r.p),u=p?f(p,"xfrm",r.a):null;let h={x:0,y:0,width:0,height:0};if(u){const t=f(u,"off",r.a),e=f(u,"ext",r.a);t&&(h.x=d(t.getAttribute("x")||"0"),h.y=d(t.getAttribute("y")||"0")),e&&(h.width=d(e.getAttribute("cx")||"0"),h.height=d(e.getAttribute("cy")||"0"))}e.push({id:a,type:c,name:l,rect:h})}return e}(s),c=e.match(/notesMaster(\d+)\.xml/)?.[1]||"1",p=await async function(t,e){try{const r=`ppt/notesMasters/_rels/${e}.xml.rels`,n=await(t.file(r)?.async("string"));return n?ct(n):(v("warn",`Notes master rels not found: ${r}`),{})}catch(t){return v("warn",`Failed to parse notes master rels for ${e}`,t),{}}}(t,`notesMaster${c}`);return v("info",`Parsed notes master: ${c}`),{id:`notesMaster_${c}`,elements:a,background:o,placeholders:l,relsMap:p}}catch(t){throw v("error",`Failed to parse notes master: ${e}`,t),t}}async function st(t,e,n){try{const i=new DOMParser,s=i.parseFromString(n,"application/xml").documentElement,o=ot(s),a=function(t){const e=f(t,"cSld",r.p);if(!e)return"";const n=f(e,"spTree",r.p);if(!n)return"";const i=Array.from(n.children).filter(t=>"p:sp"===t.tagName||t.tagName.includes(":sp"));for(const t of i){const e=f(t,"nvSpPr",r.p);if(!e)continue;const n=f(e,"nvPr",r.p);if(!n)continue;const i=f(n,"ph",r.p);if("body"===i?.getAttribute("type")){const e=f(t,"txBody",r.p);if(!e)continue;const n=at(e);if(n&&n.trim())return n.trim()}}return""}(s),l=lt(s),c=e.match(/notesSlide(\d+)\.xml/)?.[1]||"1",d=await async function(t,e){try{const r=`ppt/notesSlides/_rels/${e}.xml.rels`,n=await(t.file(r)?.async("string"));return n?ct(n):(v("warn",`Notes slide rels not found: ${r}`),{})}catch(t){return v("warn",`Failed to parse notes slide rels for ${e}`,t),{}}}(t,`notesSlide${c}`),p=d.rId1?.target||"";return v("info",`Parsed notes slide: ${c}`),{id:`notesSlide_${c}`,slideId:`slide${c}`,text:a,elements:l,background:o,relsMap:d,masterRef:p}}catch(t){throw v("error",`Failed to parse notes slide: ${e}`,t),t}}function ot(t){const e=f(t,"bg",r.p);if(!e)return{type:"color",value:"#ffffff"};const n=f(e,"bgPr",r.p);if(n){const t=f(n,"solidFill",r.a);if(t){const e=f(t,"srgbClr",r.a);if(e?.getAttribute("val"))return{type:"color",value:`#${e.getAttribute("val")}`}}}return{type:"color",value:"#ffffff"}}function at(t){const e=Array.from(t.children).filter(t=>"a:p"===t.tagName||t.tagName.includes(":p")),r=[];for(const t of e){const e=Array.from(t.children).filter(t=>"a:r"===t.tagName||t.tagName.includes(":r"));for(const t of e){const e=f(t,"t","http://schemas.openxmlformats.org/drawingml/2006/main");e?.textContent&&r.push(e.textContent)}}return r.join("\n")}function lt(t){const e=[],n=f(t,"cSld",r.p);if(!n)return e;const i=f(n,"spTree",r.p);return i?(Array.from(i.children).forEach((t,n)=>{if(1!==t.nodeType)return;const i=t.tagName;i.includes("sp")?e.push(function(t){const e=f(t,"cNvPr",r.p),n=g(e,"id",`shape_${Date.now()}`),i=g(e,"name",""),s=f(t,"spPr",r.p),o=s?f(s,"xfrm",r.a):null;let a={x:0,y:0,width:0,height:0};if(o){const t=f(o,"off",r.a),e=f(o,"ext",r.a);t&&(a.x=d(t.getAttribute("x")||"0"),a.y=d(t.getAttribute("y")||"0")),e&&(a.width=d(e.getAttribute("cx")||"0"),a.height=d(e.getAttribute("cy")||"0"))}return{id:n,name:i,type:"shape",rect:a,content:{}}}(t)):i.includes("pic")&&e.push(function(t){const e=f(t,"cNvPr",r.p),n=g(e,"id",`image_${Date.now()}`),i=g(e,"name",""),s=f(t,"spPr",r.p),o=s?f(s,"xfrm",r.a):null;let a={x:0,y:0,width:0,height:0};if(o){const t=f(o,"off",r.a),e=f(o,"ext",r.a);t&&(a.x=d(t.getAttribute("x")||"0"),a.y=d(t.getAttribute("y")||"0")),e&&(a.width=d(e.getAttribute("cx")||"0"),a.height=d(e.getAttribute("cy")||"0"))}return{id:n,name:i,type:"image",rect:a,content:{}}}(t))}),e):e}function ct(t){const e={};try{const r=new DOMParser,n=r.parseFromString(t,"application/xml").documentElement,i=Array.from(n.children).filter(t=>"Relationship"===t.tagName||t.tagName.includes(":Relationship"));for(const t of i){const r=t.getAttribute("Id")||"",n=t.getAttribute("Type")||"",i=t.getAttribute("Target")||"";r&&(e[r.replace("rId","")]={id:r,type:n,target:i})}}catch(t){v("warn","Failed to parse relationships XML",t)}return e}function dt(t,e,n){try{const i=new DOMParser,s=i.parseFromString(t,"application/xml").documentElement,o=function(t){const e=f(t,"plotArea",r.c);if(!e)return"unknown";const n=Array.from(e.children);for(const t of n){const e=t.tagName;if(e.includes("lineChart"))return"lineChart";if(e.includes("barChart"))return"barChart";if(e.includes("pieChart"))return e.includes("3D")?"pie3DChart":"pieChart";if(e.includes("areaChart"))return"areaChart";if(e.includes("scatterChart"))return"scatterChart"}return"unknown"}(s),a=function(t){const e=f(t,"title",r.c);if(!e)return;const n=f(e,"tx",r.c);if(!n)return;f(n,"strRef",r.c);const i=f(n,"strCache",r.c);if(i){const t=f(i,"pt",r.c);if(t?.textContent)return t.textContent.trim()}const s=f(n,"rich",r.c);if(s){const t=f(s,"p",r.a);if(t){const e=gt(t);if(e)return e}}return}(s),l=function(t){const e=[],n=f(t,"plotArea",r.c);if(!n)return e;const i=pt(n);if(!i)return e;const s=Array.from(i.children).filter(t=>t.tagName.includes(":ser")||"ser"===t.localName);for(const t of s){const r=parseInt(g(t,"idx","0"),10),n=parseInt(g(t,"order","0"),10),i=ut(t),s=ht(t);e.push({name:i,idx:r,order:n,points:s})}return e}(s),c=function(t){const e=[],n=f(t,"plotArea",r.c);if(!n)return e;const i=f(n,"catAx",r.c);if(!i)return e;const s=f(i,"tx",r.c);if(!s)return e;f(s,"strRef",r.c);const o=f(s,"strCache",r.c);if(o){const t=Array.from(o.children).filter(t=>t.tagName.includes(":pt")||"pt"===t.localName);for(const n of t){const t=f(n,"v",r.c);t?.textContent&&e.push(t.textContent.trim())}}return e}(s),d=ft(s,"x"),p=ft(s,"y"),u=function(t){const e=f(t,"legend",r.c);if(!e)return!1;return"1"!==e.getAttribute("deleted")}(s),h=function(t){const e=f(t,"plotArea",r.c);if(!e)return!1;const n=pt(e);if(!n)return!1;const i=f(n,"dLbls",r.c);if(!i)return!1;return"1"!==i.getAttribute("deleted")}(s);return v("info",`Parsed chart ${e}: type=${o}, series=${l.length}`),{id:`chart_${e}`,chartType:o,title:a,series:l,categories:c,xTitle:d,yTitle:p,showLegend:u,showDataLabels:h,relsMap:n}}catch(t){return v("error",`Failed to parse chart ${e}`,t),{id:`chart_${e}`,chartType:"unknown",relsMap:n}}}function pt(t){const e=Array.from(t.children);for(const t of e){const e=t.tagName;if(e.includes("lineChart")||e.includes("barChart")||e.includes("pieChart")||e.includes("areaChart")||e.includes("scatterChart"))return t}return null}function ut(t){const e=f(t,"tx",r.c);if(!e)return;f(e,"strRef",r.c);const n=f(e,"strCache",r.c);if(n){const t=f(n,"pt",r.c);if(t?.textContent)return t.textContent.trim()}const i=f(e,"v",r.c);return i?.textContent?i.textContent.trim():void 0}function ht(t){const e=[];f(t,"val",r.c);const n=f(t,"numCache",r.c);if(n){const t=Array.from(n.children).filter(t=>t.tagName.includes(":pt")||"pt"===t.localName);for(const n of t){const t=parseInt(g(n,"idx","0"),10),i=f(n,"v",r.c),s=i?.textContent?parseFloat(i.textContent):void 0;e.push({idx:t,value:s})}}return e}function ft(t,e){const n=f(t,"plotArea",r.c);if(!n)return;const i=f(n,"x"===e?"catAx":"valAx",r.c);if(!i)return;const s=f(i,"title",r.c);if(!s)return;const o=f(s,"tx",r.c);if(!o)return;const a=f(o,"rich",r.c);if(a){const t=f(a,"p",r.a);if(t){const e=gt(t);if(e)return e}}}function gt(t){const e=Array.from(t.children).filter(t=>t.tagName.includes(":r")||"r"===t.localName),n=[];for(const t of e){const e=f(t,"t",r.a);e?.textContent&&n.push(e.textContent)}return n.length>0?n.join(""):void 0}function mt(t,e,n){try{const i=new DOMParser,s=i.parseFromString(t,"application/xml").documentElement,o=s.getAttribute("type")||"unknown",a=s.getAttribute("layout")||"",l=function(t){const e=[],n=f(t,"spTree",r.d);if(!n)return e;const i=Array.from(n.children).filter(t=>t.tagName.includes(":sp")||"sp"===t.localName);for(const t of i){const n=g(t,"id",`shape_${Date.now()}`),i=t.getAttribute("type")||"shape",s=f(t,"xfrm",r.a);let o,a;if(s){const t=f(s,"off",r.a),e=f(s,"ext",r.a);if(t){const e=parseInt(t.getAttribute("x")||"0"),r=parseInt(t.getAttribute("y")||"0");o={x:d(e),y:d(r)}}if(e){const t=parseInt(e.getAttribute("cx")||"0"),r=parseInt(e.getAttribute("cy")||"0");a={width:d(t),height:d(r)}}}const l=yt(t);e.push({id:n,type:i,position:o,size:a,text:l})}return e}(s);return v("info",`Parsed diagram ${e}: type=${o}, shapes=${l.length}`),{id:`diagram_${e}`,diagramType:o,layout:a,shapes:l,relsMap:n}}catch(t){return v("error",`Failed to parse diagram ${e}`,t),{id:`diagram_${e}`,relsMap:n}}}function yt(t){const e=f(t,"txBody",r.d);if(!e)return;const n=f(e,"p",r.a);if(!n)return;return gt(n)}async function bt(t,e){try{const r=`ppt/charts/_rels/${e}.xml.rels`,n=await(t.file(r)?.async("string"));return n?wt(n):(v("warn",`Chart rels not found: ${r}`),{})}catch(t){return v("warn",`Failed to parse chart rels for ${e}`,t),{}}}async function xt(t,e){try{const r=`ppt/diagrams/_rels/data${e}.xml.rels`,n=await(t.file(r)?.async("string"));return n?wt(n):(v("warn",`Diagram rels not found: ${r}`),{})}catch(t){return v("warn",`Failed to parse diagram rels for ${e}`,t),{}}}function wt(t){const e={};try{const r=new DOMParser,n=r.parseFromString(t,"application/xml").documentElement,i=Array.from(n.children).filter(t=>"Relationship"===t.tagName||t.tagName.includes(":Relationship"));for(const t of i){const r=t.getAttribute("Id")||"",n=t.getAttribute("Type")||"",i=t.getAttribute("Target")||"";r&&(e[r.replace("rId","")]={id:r,type:n,target:i})}}catch(t){v("warn","Failed to parse relationships XML",t)}return e}async function $t(t,e){try{const n=`ppt/slides/${e}.xml`,i=await(t.file(n)?.async("string"));if(!i)return v("warn",`Slide not found: ${n}`),vt(e);const s=await async function(t,e){try{const r=`ppt/slides/_rels/${e}.xml.rels`,n=await(t.file(r)?.async("string"));return n?function(t){const e={};try{const r=new DOMParser,n=r.parseFromString(t,"application/xml").documentElement,i=Array.from(n.children).filter(t=>"Relationship"===t.tagName||t.tagName.includes(":Relationship"));for(const t of i){const r=t.getAttribute("Id")||"",n=t.getAttribute("Type")||"",i=t.getAttribute("Target")||"";r&&(e[r.replace("rId","")]={id:r,type:n,target:i})}}catch(t){v("warn","Failed to parse relationships XML",t)}return e}(n):(v("warn",`Slide rels not found: ${r}`),{})}catch(t){return v("warn",`Failed to parse slide rels for ${e}`,t),{}}}(t,e),o=function(t){const e=[];try{const n=(new DOMParser).parseFromString(t,"application/xml"),i=f(n.documentElement,"extLst",r.p);if(!i)return e;const s=Array.from(i.children).filter(t=>"p:ext"===t.tagName||t.tagName.includes(":ext"));for(const t of s){const r=t.getAttribute("uri")||"";if(r.includes("tags")||r.includes("ppt/tags")){const r=Array.from(t.children).filter(t=>"p:tag"===t.tagName||t.tagName.includes(":tag"));for(const t of r){const r=g(t,"name",""),n=g(t,"val","");r&&e.push({name:r,value:n})}}}}catch(t){v("warn","Failed to parse tags",t)}return e}(i),a=function(t){const e=[];try{const n=(new DOMParser).parseFromString(t,"application/xml"),i=f(n.documentElement,"extLst",r.p);if(!i)return e;const s=Array.from(i.children).filter(t=>"p:ext"===t.tagName||t.tagName.includes(":ext"));for(const t of s){const r=t.getAttribute("uri")||"",n=St(Array.from(t.children));e.push({uri:r,data:n})}}catch(t){v("warn","Failed to parse extensions",t)}return e}(i),l=function(t){const e=[];try{const n=(new DOMParser).parseFromString(t,"application/xml"),i=f(n.documentElement,"extLst",r.p);if(!i)return e;const s=Array.from(i.children).filter(t=>"p:ext"===t.tagName||t.tagName.includes(":ext"));for(const t of s){const r=t.getAttribute("uri")||"";if(r.includes("customProps")||r.includes("ppt/customProperties")){const r=Array.from(t.children).filter(t=>"p:custData"===t.tagName||t.tagName.includes(":custData"));for(const t of r){const r=g(t,"name",""),n=t.textContent||"",i=At(n);r&&e.push({name:r,value:n,type:i})}}}}catch(t){v("warn","Failed to parse custom properties",t)}return e}(i);return{id:`tags_${e}`,slideId:e,tags:o,extensions:a,customProperties:l,relsMap:s}}catch(t){return v("error",`Failed to parse tags for slide ${e}`,t),vt(e)}}function vt(t){return{id:`tags_${t}`,slideId:t,tags:[],extensions:[],customProperties:[],relsMap:{}}}function St(t){const e={};for(const r of t){if(1!==r.nodeType)continue;const t=r.localName||r.tagName.split(":").pop();if(r.children.length>0)e[t]=St(Array.from(r.children));else if(r.textContent){const n=r.textContent.trim();e[t]=n}else e[t]=null}return e}function At(t){if(!t)return"string";if("true"===t.toLowerCase()||"false"===t.toLowerCase())return"boolean";if(!isNaN(parseFloat(t))&&isFinite(Number(t)))return"number";return/^\d{4}-\d{2}-\d{2}(T\d{2}:\d{2}:\d{2})?$/.test(t)?"date":"string"}const kt={generateId:$,parseXmlText:t=>e(t||"").trim(),px2emu:p,emu2px:d,parseXmlToTree:t=>{const e=(new DOMParser).parseFromString(t,"application/xml").documentElement,r=t=>{const e=[];return Array.from(t.childNodes).forEach(t=>{1===t.nodeType&&e.push(r(t))}),{tag:t.tagName,attrs:kt.parseXmlAttrs(t.attributes),children:e,text:kt.parseXmlText(t.textContent||"")}};return r(e)},parseXmlAttrs:t=>{const e={};return Array.from(t).forEach(t=>{e[t.nodeName]=t.nodeValue||""}),e},parseXmlRect:t=>({x:d(t.x||"0"),y:d(t.y||"0"),width:d(t.cx||"0"),height:d(t.cy||"0")}),parseXmlStyle:t=>{const e={};t.fontSize?e.fontSize=parseInt(t.fontSize)/100:e.fontSize=14,t.fill?e.color=t.fill:e.color="#333333","1"===t.bold||"true"===t.bold?e.fontWeight="bold":e.fontWeight="normal";const r=t.align;return e.textAlign="left"===r||"center"===r||"right"===r||"justify"===r?r:"left",t.bgFill?e.backgroundColor=t.bgFill:e.backgroundColor="transparent",t.border?e.borderColor=t.border:e.borderColor="#000000",t.borderWidth?e.borderWidth=parseInt(t.borderWidth):e.borderWidth=1,e},hexToRgb:t=>{const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:{r:0,g:0,b:0}},rgbToHex:(t,e,r)=>"#"+((1<<24)+(t<<16)+(e<<8)+r).toString(16).slice(1),parseColor:t=>(t.startsWith("#"),t)};async function Tt(e,r){const n={parseImages:!0,keepRawXml:!1,verbose:!1,returnFormat:"enhanced",...r},i=await t.loadAsync(e);return"simple"===n.returnFormat?async function(t){const e=await async function(t){const e={width:1280,height:720,title:"未命名PPT"};try{const r=await(t.file("ppt/slideLayouts/slideLayout1.xml")?.async("string"));if(r){const t=kt.parseXmlToTree(r).children.find(t=>"cSld"===t.tag),n=t?.children.find(t=>"sldSz"===t.tag);if(n){const t=kt.parseXmlRect(n.attrs);e.width=t.width,e.height=t.height}}const n=await(t.file("docProps/core.xml")?.async("string"));if(n){const t=kt.parseXmlToTree(n);e.title=t.children.find(t=>t.tag.includes("title"))?.text||"未命名PPT"}}catch(t){console.warn("PPT配置解析失败，使用默认配置",t)}return e}(t),r=await async function(t){const e=[],r=Object.keys(t.files).filter(t=>t.startsWith("ppt/slides/slide")&&t.endsWith(".xml"));for(const n of r){const r=await t.file(n).async("string");e.push({xml:r,slideId:kt.generateId("slide"),rId:n.replace("ppt/slides/slide","").replace(".xml",""),layout:"normal"})}return e}(t),n=await Promise.all(r.map((t,e)=>async function(t,e,r){const{xml:n,layout:i}=e,s=kt.parseXmlToTree(n),o=s.children.find(t=>"p:cSld"===t.tag||"cSld"===t.tag),a=o?.children.find(t=>"p:spTree"===t.tag||"spTree"===t.tag),l=[];a&&a.children.forEach(t=>{const e=function(t){const{tag:e}=t;if("p:sp"===e||"sp"===e)return function(t){const e=kt.generateId("shape"),r=t.children,n=r.find(t=>"p:spPr"===t.tag||"spPr"===t.tag),i=r.find(t=>"p:txBody"===t.tag||"txBody"===t.tag);let s={x:0,y:0,width:0,height:0};if(n){const t=n.children.find(t=>"a:xfrm"===t.tag);if(t){const e=t.children.find(t=>"a:off"===t.tag),r=t.children.find(t=>"a:ext"===t.tag);e&&r&&(s=kt.parseXmlRect({x:e.attrs.x||"0",y:e.attrs.y||"0",cx:r.attrs.cx||"0",cy:r.attrs.cy||"0"}))}}let o="";if(i){const t=i.children.filter(t=>"a:p"===t.tag||"p"===t.tag),e=[];t.forEach(t=>{const r=t.children.filter(t=>"a:r"===t.tag||"r"===t.tag);r.forEach(t=>{const r=t.children.find(t=>"a:t"===t.tag||"t"===t.tag);if(r&&r.text){const n=t.children.find(t=>"a:rPr"===t.tag||"rPr"===t.tag);e.push({text:r.text,fontSize:n?.attrs.sz?parseInt(n.attrs.sz)/100:14,fontColor:n?.attrs.fill||"#333333",bold:"1"===n?.attrs.b,italic:"1"===n?.attrs.i})}})}),o={paragraphs:[{runs:e}]}}return{id:e,type:"text",rect:s,style:{fontSize:14,color:"#333333",fontWeight:"normal",textAlign:"left",backgroundColor:"transparent",borderColor:"#000000",borderWidth:1},content:o}}(t);if("p:pic"===e||"pic"===e)return function(t){const e=kt.generateId("image"),r=t.children,n=r.find(t=>"p:spPr"===t.tag||"spPr"===t.tag),i=r.find(t=>"p:blipFill"===t.tag||"blipFill"===t.tag);let s={x:0,y:0,width:0,height:0};if(n){const t=n.children.find(t=>"a:xfrm"===t.tag);if(t){const e=t.children.find(t=>"a:off"===t.tag),r=t.children.find(t=>"a:ext"===t.tag);e&&r&&(s=kt.parseXmlRect({x:e.attrs.x||"0",y:e.attrs.y||"0",cx:r.attrs.cx||"0",cy:r.attrs.cy||"0"}))}}let o="";if(i){const t=i.children.find(t=>"a:blip"===t.tag||"blip"===t.tag);o=t?.attrs["r:embed"]||t?.attrs.embed||""}return{id:e,type:"image",rect:s,style:{fontSize:14,color:"#333333",fontWeight:"normal",textAlign:"left",backgroundColor:"transparent",borderColor:"#000000",borderWidth:1},content:{url:"",imgId:o},props:{imgId:o,alt:"图片"}}}(t);if("p:graphicFrame"===e||"graphicFrame"===e)return function(t){const e=kt.generateId("graphic"),r=t.children,n=r.find(t=>"p:xfrm"===t.tag||"xfrm"===t.tag);let i={x:0,y:0,width:0,height:0};if(n){const t=n.children.find(t=>"a:off"===t.tag),e=n.children.find(t=>"a:ext"===t.tag);t&&e&&(i=kt.parseXmlRect({x:t.attrs.x||"0",y:t.attrs.y||"0",cx:e.attrs.cx||"0",cy:e.attrs.cy||"0"}))}const s=r.find(t=>"a:graphic"===t.tag||"graphic"===t.tag),o=s?.children.find(t=>"a:graphicData"===t.tag||"graphicData"===t.tag);if(!o)return null;const a=o.attrs.uri||"";if(a.includes("table"))return{id:e,type:"table",rect:i,style:{fontSize:14,color:"#333333",fontWeight:"normal",textAlign:"left",backgroundColor:"transparent",borderColor:"#cccccc",borderWidth:1},content:{rows:[]},props:{rowCount:0,colCount:0}};if(a.includes("chart"))return{id:e,type:"chart",rect:i,style:{fontSize:14,color:"#333333",fontWeight:"normal",textAlign:"left",backgroundColor:"transparent",borderColor:"#000000",borderWidth:1},content:{type:"unknown",data:[]},props:{legend:!0,grid:!0}};return null}(t);return null}(t);e&&l.push(e)});const c=function(t){const e=t.children.find(t=>"bg"===t.tag);if(!e)return"#ffffff";const r=e.children.find(t=>"fill"===t.tag);return r?.attrs.color||"#ffffff"}(s),d=function(t,e){const r=t.children.find(t=>"p:cSld"===t.tag||"cSld"===t.tag),n=r?.children.find(t=>"p:spTree"===t.tag||"spTree"===t.tag);if(!n)return`幻灯片${e}`;for(const t of n.children)if("p:sp"===t.tag||"sp"===t.tag){const e=t.children.find(t=>"p:nvSpPr"===t.tag||"nvSpPr"===t.tag),r=e?.children.find(t=>"p:nvPr"===t.tag||"nvPr"===t.tag),n=r?.children.find(t=>"p:ph"===t.tag||"ph"===t.tag);if("title"===n?.attrs.type){const e=t.children.find(t=>"p:txBody"===t.tag||"txBody"===t.tag),r=e?.children.find(t=>"a:p"===t.tag||"p"===t.tag),n=r?.children.find(t=>"a:r"===t.tag||"r"===t.tag),i=n?.children.find(t=>"a:t"===t.tag||"t"===t.tag);if(i?.text)return i.text}}return`幻灯片${e}`}(s,r+1);return{id:e.slideId,title:d,bgColor:c,elements:l,props:{width:1280,height:720,slideLayout:i}}}(0,t,e)));return{id:kt.generateId("ppt-doc"),title:e.title||"未命名PPT",slides:n,props:{width:e.width||1280,height:e.height||720,ratio:(e.width||1280)/(e.height||720)}}}(i):async function(t,e){try{v("info","Starting PPTX parsing...");const r=await async function(t){try{const e=await(t.file(`${l}core.xml`)?.async("string"));return e?w(e):(v("warn","core.xml not found"),{})}catch(t){return v("warn","Failed to parse core properties",t),{}}}(t),n=await async function(t){try{const e=await(t.file("ppt/presentation.xml")?.async("string"));if(e){const t=(new DOMParser).parseFromString(e,"application/xml"),r=t.documentElement.namespaceURI||"http://schemas.openxmlformats.org/presentationml/2006/main",n=t.getElementsByTagNameNS(r,"sldSz")[0];if(n){const t=n.getAttribute("cx"),e=n.getAttribute("cy");if(t&&e)return{width:d(t),height:d(e)}}}return{width:1280,height:720}}catch(t){return v("warn","Failed to parse slide size",t),{width:1280,height:720}}}(t),i=await tt(t);v("info",i?"Theme parsed successfully":"Theme not found");const s=await async function(t){try{const e=Object.keys(t.files).filter(t=>t.startsWith("ppt/slideMasters/")&&t.endsWith(".xml")).sort();v("info",`Found ${e.length} master slide files`);const r=[];for(const n of e){const e=n.match(/slideMaster(\d+)\.xml/)?.[1];if(!e)continue;const i=await(t.file(n)?.async("string"));if(!i)continue;const s=n.replace("slideMasters/","slideMasters/_rels/").replace(".xml",".xml.rels");let o={};try{const r=await(t.file(s)?.async("string"));r&&(o=x(r,s),v("info",`Loaded ${Object.keys(o).length} relationships for master ${e}`),Object.entries(o).forEach(([t,e])=>{v("info",`  - ${t}: type=${e.type}, target=${e.target}`)}))}catch(t){v("warn",`Failed to read master rels: ${s}`,t)}const a=et(i,o,e);r.push(a)}return r}catch(t){return v("error","Failed to parse master slides",t),[]}}(t);v("info",`Parsed ${s.length} master slides`);const a=new Map;s.forEach(t=>{t.masterId&&(a.set(t.masterId,t),v("info",`Master map: ${t.masterId} -> ${t.id}`))});const c=await async function(t){try{const e={},r=Object.keys(t.files).filter(t=>t.startsWith(rt.slideLayouts)&&t.endsWith(".xml")).filter(t=>!t.includes("_rels")).sort((t,e)=>parseInt(t.match(/slideLayout(\d+)\.xml/)?.[1]||"0",10)-parseInt(e.match(/slideLayout(\d+)\.xml/)?.[1]||"0",10));v("info",`Found ${r.length} layout files`);for(let n=0;n<r.length;n++){const i=r[n];v("info",`Parsing layout ${n+1}: ${i}`);const s=await(t.file(i)?.async("string"));if(!s){v("warn",`Failed to read layout: ${i}`);continue}const o=i.match(/slideLayout(\d+)\.xml/)?.[1];let a={};if(o){const e=`ppt/slideLayouts/_rels/slideLayout${o}.xml.rels`;try{const r=await(t.file(e)?.async("string"));r&&(a=x(r,e),v("info",`Loaded ${Object.keys(a).length} relationships for layout ${o}`),Object.entries(a).forEach(([t,e])=>{v("info",`  - ${t}: type=${e.type}, target=${e.target}`)}))}catch(t){v("warn",`Failed to read layout rels: ${e}`,t)}}const l=nt(s,a);l&&(e[`slideLayout${o}`]=l)}return e}catch(t){return v("error","Failed to parse slide layouts",t),{}}}(t);v("info",`Parsed ${Object.keys(c).length} slide layouts`),Object.entries(c).forEach(([t,e])=>{if(e.masterRef&&a.has(e.masterRef)){e.master=a.get(e.masterRef),v("info",`Layout ${t} references master: ${e.masterRef}`)}});const p=await async function(t,e){try{const r=Object.keys(t.files).filter(t=>t.startsWith(o)).filter(t=>t.endsWith(".xml")).filter(t=>!t.includes("_rels")).sort((t,e)=>parseInt(t.match(/slide(\d+)\.xml/)?.[1]||"0",10)-parseInt(e.match(/slide(\d+)\.xml/)?.[1]||"0",10));v("info",`Found ${r.length} slide files`);const n=[];for(let i=0;i<r.length;i++){const s=r[i];v("info",`Parsing slide ${i+1}: ${s}`);const o=await(t.file(s)?.async("string"));if(!o){v("warn",`Failed to read slide: ${s}`);continue}const a=s.match(/slide(\d+)\.xml/)?.[1];let l={};if(a){const e=`slide${a}`;l=await G(t,e),v("info",`Loaded ${Object.keys(l).length} relationships for slide ${e}`)}const c=q(o,l,i);e.keepRawXml&&(c.rawXml=o),n.push(c)}return n}catch(t){return v("error","Failed to parse slides",t),[]}}(t,e);p.forEach(t=>{const e=function(t){for(const[e,r]of Object.entries(t))if(r.type.includes("slideLayout")){const t=r.target.match(/slideLayout(\d+)\.xml/);if(t)return`slideLayout${t[1]}`}}(t.relsMap||{});if(e&&c[e]){const o=c[e],a=o,l=(r=t.background,n=o.background,s=a.master?.background,r&&"none"!==r.type?r:n&&"none"!==n.type?n:s||{type:"color",value:"#ffffff"});t.background=l,t.layoutId=e,t.layout=o,t.master=a.master,j(t,o,a.master,i);v("info",`Slide relationship chain: slide -> layout (${e}) -> master (${o.masterRef})`)}else e&&v("warn",`Layout ${e} referenced by slide not found in parsed layouts`);var r,n,s});const u=await async function(t){try{const e=await(t.file("_rels/.rels")?.async("string"));return e?x(e,"_rels/.rels"):{}}catch(t){return v("warn","Failed to parse global relationships",t),{}}}(t);v("info",`Parsed ${p.length} slides successfully`);const h=n.width/n.height,f=function(t){const e=.01;return Math.abs(t-1.33333)<e?"4:3":Math.abs(t-1.77778)<e?"16:9":Math.abs(t-1.6)<e?"16:10":"custom"}(h);i&&i.colors&&p.forEach((t,e)=>{if(t.background&&"object"==typeof t.background){const e=t.background;if(e.schemeRef){const t=function(t,e,r={}){if(r[t]){return e[{light:"lt1",dark:"dk1"}[n=r[t]]||n]||"#ffffff"}var n;return e[t]||"#ffffff"}(e.schemeRef,i.colors,{});e.value=t,delete e.schemeRef}}});const g=await async function(t){try{const e=Object.keys(t.files).filter(t=>t.startsWith("ppt/notesMasters/")).filter(t=>t.endsWith(".xml")).filter(t=>!t.includes("_rels")).sort((t,e)=>parseInt(t.match(/notesMaster(\d+)\.xml/)?.[1]||"0",10)-parseInt(e.match(/notesMaster(\d+)\.xml/)?.[1]||"0",10));v("info",`Found ${e.length} notes master files`);const r=[];for(const n of e){const e=await(t.file(n)?.async("string"));if(!e){v("warn",`Failed to read notes master: ${n}`);continue}const i=await it(t,n,e);r.push(i)}return r}catch(t){return v("error","Failed to parse notes masters",t),[]}}(t),m=await async function(t){try{const e=Object.keys(t.files).filter(t=>t.startsWith("ppt/notesSlides/")).filter(t=>t.endsWith(".xml")).filter(t=>!t.includes("_rels")).sort((t,e)=>parseInt(t.match(/notesSlide(\d+)\.xml/)?.[1]||"0",10)-parseInt(e.match(/notesSlide(\d+)\.xml/)?.[1]||"0",10));v("info",`Found ${e.length} notes slide files`);const r=[];for(const n of e){const e=await(t.file(n)?.async("string"));if(!e){v("warn",`Failed to read notes slide: ${n}`);continue}const i=await st(t,n,e);r.push(i)}return r}catch(t){return v("error","Failed to parse notes slides",t),[]}}(t);!function(t,e){const r=new Map;e.forEach(t=>{const e=t.id.replace("notesMaster_","");r.set(e,t)}),t.forEach(t=>{if(t.masterRef){const e=t.masterRef.split("/").pop()?.replace(".xml","")||"";r.has(e)&&(t.master=r.get(e))}})}(m,g);const y=await async function(t){try{const e=Object.keys(t.files).filter(t=>t.startsWith("ppt/charts/")).filter(t=>t.endsWith(".xml")).filter(t=>!t.includes("_rels")).sort();v("info",`Found ${e.length} chart files`);const r=[];for(const n of e){const e=await(t.file(n)?.async("string"));if(!e){v("warn",`Failed to read chart: ${n}`);continue}const i=n.match(/chart(\d+)\.xml/)?.[1]||"1",s=dt(e,i,await bt(t,`chart${i}`));r.push(s)}return r}catch(t){return v("error","Failed to parse charts",t),[]}}(t),b=await async function(t){try{const e=Object.keys(t.files).filter(t=>t.startsWith("ppt/diagrams/")).filter(t=>t.endsWith(".xml")).filter(t=>!t.includes("_rels")).sort();v("info",`Found ${e.length} diagram files`);const r=[];for(const n of e){const e=await(t.file(n)?.async("string"));if(!e){v("warn",`Failed to read diagram: ${n}`);continue}const i=n.match(/data(\d+)\.xml/)?.[1]||"1",s=mt(e,i,await xt(t,i));r.push(s)}return r}catch(t){return v("error","Failed to parse diagrams",t),[]}}(t),S=await async function(t,e){try{const r=[];for(let n=1;n<=e;n++){const e=`slide${n}`,i=await $t(t,e);r.push(i)}return v("info",`Parsed tags for ${e} slides`),r}catch(t){return v("error","Failed to parse slide tags",t),[]}}(t,p.length),A={id:$("ppt-doc"),title:r.title||"未命名PPT",author:r.author,subject:r.subject,keywords:r.keywords,description:r.description,created:r.created,modified:r.modified,slides:p,props:{width:n.width,height:n.height,ratio:h,pageSize:f},globalRelsMap:u,theme:i||void 0,masterSlides:s,slideLayouts:c,notesMasters:g.length>0?g:void 0,notesSlides:m.length>0?m:void 0,charts:y.length>0?y:void 0,diagrams:b.length>0?b:void 0,tags:S.length>0?S:void 0};return e.parseImages&&await async function(t,e){try{const r=new Map;for(const n of e.slides){if(n.background&&"string"!=typeof n.background){const e=n.background;if("image"===e.type&&e.relId){const i=await Q(t,e.relId,n.relsMap,r);i&&(e.value=i)}}let e=0;for(const i of n.elements)if("image"===i.type){e++;const s=i,o=s.relId;if(o){v("info",`Found image element in slide: relId=${o}, src=${s.src}`);const e=await Q(t,o,n.relsMap,r);e?(s.src=e,v("info",`Updated image src to base64 URL, length=${e.length}`)):v("warn",`Failed to resolve image relId=${o}`)}else v("warn","Image element missing relId")}e>0&&v("info",`Found ${e} image elements in slide ${n.id}`)}if(e.slideLayouts){v("info",`Processing ${Object.keys(e.slideLayouts).length} slide layouts`);for(const n in e.slideLayouts){const i=e.slideLayouts[n];v("info",`Processing layout: ${n}`),await K(t,i,i.relsMap,r)}}if(e.masterSlides){v("info",`Processing ${e.masterSlides.length} master slides`);for(const n of e.masterSlides)n.relsMap?(v("info",`Processing master: ${n.id}`),await K(t,n,n.relsMap,r)):v("warn",`Master ${n.id} missing relsMap`)}e.mediaMap=r,v("info",`Parsed ${r.size} images`)}catch(t){v("warn","Failed to parse images",t)}}(t,A),A}catch(t){throw v("error","PPTX parsing failed",t),new Error(`PPTX解析失败: ${t instanceof Error?t.message:String(t)}`)}}(i,n)}async function Pt(e){const r=new t;return function(t){t.folder("ppt")?.folder("slides"),t.folder("ppt")?.folder("slideLayouts"),t.folder("ppt")?.folder("_rels"),t.folder("docProps"),t.folder("_rels")}(r),await async function(t,e){const{width:r,height:n}=e.props,i=kt.px2emu(r),s=kt.px2emu(n),o=`<sldLayout xmlns="http://schemas.openxmlformats.org/presentationml/2006/main"><cSld><sldSz cx="${i}" cy="${s}" type="screen"/></cSld></sldLayout>`;t.file("ppt/slideLayouts/slideLayout1.xml",o);const a=`<cp:coreProperties xmlns:cp="http://schemas.openxmlformats.org/package/2006/metadata/core-properties"><dc:title>${e.title}</dc:title></cp:coreProperties>`;t.file("docProps/core.xml",a)}(r,e),await async function(t,e){e.forEach(async(e,r)=>{const n=function(t){const{elements:e,bgColor:r,props:n}=t,i=kt.px2emu(n.width),s=kt.px2emu(n.height),o=e.map(t=>function(t){const{type:e,rect:r,style:n,content:i}=t,{x:s,y:o,width:a,height:l}=r,c=kt.px2emu(s),d=kt.px2emu(o),p=kt.px2emu(a),u=kt.px2emu(l);switch(e){case"text":return`<p:txBody><a:bodyPr/><a:lstStyle/><a:p><a:r><a:rPr sz="${100*(n.fontSize||14)}" b="${"bold"===n.fontWeight?1:0}"/><a:t>${i}</a:t></a:r></a:p></p:txBody><p:spPr><a:xfrm><a:off x="${c}" y="${d}"/><a:ext cx="${p}" cy="${u}"/></a:xfrm></p:spPr>`;case"shape":return`<p:sp><p:spPr><a:xfrm><a:off x="${c}" y="${d}"/><a:ext cx="${p}" cy="${u}"/></a:xfrm><a:solidFill><a:srgbClr val="${n.backgroundColor?.replace("#","")||"ffffff"}"/></a:solidFill><a:ln><a:solidFill><a:srgbClr val="${n.borderColor?.replace("#","")||"000000"}"/></a:solidFill></a:ln></p:spPr></p:sp>`;case"image":return`<p:pic><p:blipFill><a:blip r:embed="rId1"/></p:blipFill><p:spPr><a:xfrm><a:off x="${c}" y="${d}"/><a:ext cx="${p}" cy="${u}"/></a:xfrm></p:spPr></p:pic>`;case"table":return`<p:tbl><p:tblPr><a:tblW w="${p}" type="dxa"/></p:tblPr>${i.map(t=>`<a:tr><a:tc><a:txBody><a:p><a:r><a:t>${t.join("")}</a:t></a:r></a:p></a:txBody></a:tc></a:tr>`).join("")}</p:tbl>`;default:return""}}(t)).join("\n");return`<p:sld xmlns:p="http://schemas.openxmlformats.org/presentationml/2006/main"><p:cSld><p:spTree><p:grpSp><p:spPr><a:xfrm><a:off x="0" y="0"/><a:ext cx="${i}" cy="${s}"/></a:xfrm></p:spPr>${o}</p:grpSp></p:spTree></p:cSld><p:bg><p:bgPr><a:solidFill><a:srgbClr val="${r.replace("#","")}"/></a:solidFill></p:bgPr></p:bg></p:sld>`.replace(/\s+/g," ").trim()}(e);t.file(`ppt/slides/slide${r+1}.xml`,n)})}(r,e.slides),await r.generateAsync({type:"blob",compression:"DEFLATE"})}const Ct=(t,e)=>{const{createDocument:r}=require("./elements"),n=r({slides:[t],props:{width:960,height:540}});return n.getSlide(0)?.toHTML()||""},Nt=(t,e)=>{const{createDocument:r}=require("./elements");return r(t).slides.map(t=>t.toHTML())},It=(t,e)=>{const{createDocument:r}=require("./elements");return r(t).toHTML({...e,withNavigation:!1})},Mt={utils:kt,parse:Tt,serialize:Pt};export{S as BaseElement,P as ChartElement,C as DiagramElement,X as DocumentElement,n as EMU_PER_INCH,I as GroupElement,k as ImageElement,z as LayoutElement,O as MasterElement,r as NS,B as NotesMasterElement,_ as NotesSlideElement,T as OleElement,i as PIXELS_PER_INCH,H as PlaceholderElement,kt as PptParseUtils,D as PptxDocument,A as ShapeElement,E as SlideElement,N as TableElement,W as TagsElement,V as createDocument,R as createElementFromData,U as createElementFromNode,Mt as default,d as emu2px,u as getAttrs,w as parseMetadata,Tt as parsePptx,y as parseRels,Nt as ppt2HTML,It as ppt2HTMLDocument,p as px2emu,Pt as serializePptx,Ct as slide2HTML};
//# sourceMappingURL=ppt-parser.esm.js.map
