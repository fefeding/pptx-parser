"use strict";var t=require("jszip"),e=require("fast-xml-parser");class s{constructor(t){"number"==typeof t||t instanceof ArrayBuffer?this.data=new Uint8Array(t):this.data=new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}static isBuffer(t){return t instanceof s}static from(t){return new s(t)}toString(){return String.fromCharCode.apply(null,Array.from(this.data))}}"undefined"!=typeof window&&"undefined"==typeof Buffer&&(window.Buffer=s);const r="undefined"!=typeof Buffer?Buffer:window.Buffer,i=()=>"undefined"!=typeof window&&"undefined"!=typeof document?"browser":"node",a=async(t,e=i())=>{if("node"===e){const e=await import("fs");if(r.isBuffer&&r.isBuffer(t))return new Uint8Array(t.buffer||t);if("string"==typeof t){const s=await e.promises.readFile(t);return new Uint8Array(s.buffer||s)}return new Uint8Array(t)}return new Promise((e,s)=>{if("string"==typeof t)fetch(t).then(t=>t.arrayBuffer()).then(t=>e(new Uint8Array(t))).catch(s);else if(t instanceof File){const r=new FileReader;r.onload=t=>e(new Uint8Array(t.target.result)),r.onerror=s,r.readAsArrayBuffer(t)}else t instanceof ArrayBuffer||t instanceof Uint8Array?e(new Uint8Array(t)):s(new Error("浏览器环境仅支持URL/File对象/ArrayBuffer作为PPTX源"))})},l=96/914400;class o{constructor(t){this.buffer=t,this.slides={},this.totalSlides=0,this.slideWidth=0,this.slideHeight=0,this.themeColors={},this.defaultTextStyle=null,this.slideLayoutContent={},this.slideMasterContent={},this.themeContent=null,this.layoutResObj={},this.masterResObj={},this.themeResObj={},this.imageCache=new Map}async init(){this.zip=await t.loadAsync(this.buffer),await this.parseTheme(),await this.parseSlideSize(),await this.parseSlides(),await this.parseMedia()}async parseSlideSize(){try{const t=await this.readXmlFile("ppt/presentation.xml");if(!t)return;const e=this.getTextByPathList(t,["p:presentation","p:sldSz"]),s=this.getAttrs(e);if(s){const t=parseInt(s.cx),e=parseInt(s.cy);this.slideWidth=Math.round(t*l),this.slideHeight=Math.round(e*l)}this.defaultTextStyle=this.getTextByPathList(t,["p:presentation","p:defaultTextStyle"])}catch(t){console.error("Failed to parse slide size:",t)}}async parseTheme(){}parseThemeColors(t){const e=this.getTextByPathList(t,["a:theme","a:themeElements","a:clrScheme"]);e&&Object.keys(e).forEach(t=>{if(t.startsWith("a:")){const s=e[t],r=this.getColorValue(s);r&&(this.themeColors[t.substring(2)]=r)}})}indexNodes(t){try{const e=Object.keys(t).find(t=>t.includes("sld"));if(!e)return{idTable:{},idxTable:{},typeTable:{}};const s=t[e]["p:cSld"];if(!s)return{idTable:{},idxTable:{},typeTable:{}};const r=s["p:spTree"];if(!r)return{idTable:{},idxTable:{},typeTable:{}};const i={},a={},l={};for(const t in r){if("p:nvGrpSpPr"===t||"p:grpSpPr"===t)continue;const e=r[t];(Array.isArray(e)?e:[e]).forEach(t=>{const e=t["p:nvSpPr"];if(e){const s=e["p:cNvPr"],r=e["p:nvPr"],o=r?.["p:ph"],n=this.getAttr(s,"id"),h=this.getAttr(o,"idx"),d=this.getAttr(o,"type");void 0!==n&&(i[n]=t),void 0!==h&&(a[h]=t),void 0!==d&&(l[d]=t)}})}return{idTable:i,idxTable:a,typeTable:l}}catch(t){return console.error("Failed to index nodes:",t),{idTable:{},idxTable:{},typeTable:{}}}}async parseSlides(){try{const t=await this.readXmlFile("[Content_Types].xml");if(!t)return;const e=this.getTextByPathList(t,["Types","Override"]);if(!Array.isArray(e))return;const s=[];e.forEach(t=>{const e=this.getAttrs(t);"application/vnd.openxmlformats-officedocument.presentationml.slide+xml"===e?.ContentType&&s.push(e.PartName.substring(1))}),this.totalSlides=s.length;for(const t of s){const e=t.match(/slide(\d+)\.xml$/);if(e){const s=parseInt(e[1]);this.slides[s]=await this.parseSingleSlide(t,s)}}}catch(t){console.error("Failed to parse slides:",t)}}parseLayoutShapes(t,e){const s=[],r=Object.keys(t).find(t=>t.includes("sld"));if(!r)return s;const i=t[r]["p:cSld"];if(!i)return s;const a=i["p:spTree"];if(!a)return s;const l={...e,slideContent:t};return Object.keys(a).forEach(t=>{if("p:nvGrpSpPr"===t||"p:grpSpPr"===t)return;const e=a[t];(Array.isArray(e)?e:[e]).forEach(e=>{const r=this.processNode(t,e,l);r&&"shape"===r.type&&(r.isLayoutShape=!0,s.push(r))})}),s}async parseSingleSlide(t,e){try{const s=await this.readXmlFile(t);if(!s)return null;const r=t.replace("slides/slide","slides/_rels/slide")+".rels",i=await this.readXmlFile(r);if(!i)return console.warn(`No relationship file found for slide ${e}`),null;const a=i.Relationships?.Relationship;if(!a)return console.warn(`No relationships found in ${r}`),null;const l=Array.isArray(a)?a:[a],o={};let n="";if(l.forEach(t=>{const e=this.getAttrs(t);e&&(o[e.Id]={target:e.Target,type:e.Type},"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slideLayout"===e.Type&&(n=e.Target.replace("../","ppt/")))}),!n)return console.warn(`No slideLayout found for slide ${e}`),null;const h=await this.readXmlFile(n);if(!h)return console.warn(`Failed to read slideLayout ${n}`),null;this.slideLayoutContent[n]=h;const d=this.indexNodes(h),p=n.replace("slideLayouts/slideLayout","slideLayouts/_rels/slideLayout")+".rels",c=await this.readXmlFile(p);if(!c)return console.warn(`No relationship file found for slideLayout ${n}`),null;const g=c.Relationships?.Relationship;if(!g)return null;const y=Array.isArray(g)?g:[g],f={};let u="";if(y.forEach(t=>{const e=this.getAttrs(t);e&&(f[e.Id]={target:e.Target,type:e.Type},"http://schemas.openxmlformats.org/officeDocument/2006/relationships/slideMaster"===e.Type&&(u=e.Target.replace("../","ppt/")))}),!u)return console.warn(`No slideMaster found for slideLayout ${n}`),null;const x=await this.readXmlFile(u);if(!x)return console.warn(`Failed to read slideMaster ${u}`),null;this.slideMasterContent[u]=x;const m=this.indexNodes(x),T=u.replace("slideMasters/slideMaster","slideMasters/_rels/slideMaster")+".rels",b=await this.readXmlFile(T);if(!b)return console.warn(`No relationship file found for slideMaster ${u}`),null;const P=b.Relationships?.Relationship;if(!P)return null;const v=Array.isArray(P)?P:[P],B={};let S="";v.forEach(t=>{const e=this.getAttrs(t);e&&(B[e.Id]={target:e.Target,type:e.Type},"http://schemas.openxmlformats.org/officeDocument/2006/relationships/theme"===e.Type&&(S=e.Target.replace("../","ppt/")))});let F=null;S&&(F=await this.readXmlFile(S),F&&(this.themeContent=F,this.parseThemeColors(F)));const L={zip:this.zip,slideContent:s,slideLayoutContent:h,slideLayoutTables:d,slideMasterContent:x,slideMasterTables:m,slideResObj:o,layoutResObj:f,masterResObj:B,themeContent:this.themeContent,themeResObj:{},defaultTextStyle:this.defaultTextStyle},A=this.getSlideBackgroundInfo(L),w=this.getColorMapOverride(s,h,x),C=this.parseLayoutShapes(h,L),$=this.parseLayoutShapes(x,L),M={id:e,width:this.slideWidth,height:this.slideHeight,backgroundColor:A.color,backgroundImage:A.image,shapes:[],images:[],tables:[],graphs:[],layout:{filename:n,content:h,tables:d,colorMapOvr:w.layout,shapes:C},master:{filename:u,content:x,tables:m,colorMapOvr:w.master,shapes:$},theme:{filename:S,content:F},warpObj:L},I=this.getTextByPathList(s,["p:sld","p:cSld","p:spTree"]);return I?(Object.keys(I).forEach(t=>{if("p:nvGrpSpPr"===t||"p:grpSpPr"===t)return;const e=I[t];(Array.isArray(e)?e:[e]).forEach(e=>{const s=this.processNode(t,e,L);s&&("shape"===s.type?M.shapes.push(s):"image"===s.type?M.images.push(s):"table"===s.type?M.tables.push(s):"chart"===s.type&&M.graphs.push(s))})}),M):M}catch(e){return console.error(`Failed to parse slide ${t}:`,e),null}}processNode(t,e,s){switch(t){case"p:sp":return this.processShapeNode(e,s);case"p:pic":return this.processPictureNode(e,s);case"p:graphicFrame":return this.processGraphicFrameNode(e,s);case"p:grpSp":return this.processGroupNode(e,s);default:return null}}processShapeNode(t,e){const s={type:"shape"},r=t["p:nvSpPr"],i=r?.["p:cNvPr"],a=this.getAttrs(i);a&&(s.id=a.id,s.name=a.name);let o=this.getTextByPathList(t,["p:spPr","a:xfrm"]);if(o){const t=this.getAttrs(o["a:off"]),e=this.getAttrs(o["a:ext"]);t&&(s.x=Math.round(parseInt(t.x)*l),s.y=Math.round(parseInt(t.y)*l)),e&&(s.width=Math.round(parseInt(e.cx)*l),s.height=Math.round(parseInt(e.cy)*l));const r=this.getAttrs(o);r?.rot&&(s.rotation=Math.round(parseInt(r.rot)/6e4))}else if(r){const t=r["p:nvPr"],i=t?.["p:ph"];if(i){const t=this.getAttrs(i);if(t){const r=t.idx,i=t.type;let a=null;if(e.slideLayoutTables&&(a=void 0!==r?e.slideLayoutTables.idxTable[r]:void 0!==i?e.slideLayoutTables.typeTable[i]:null),!a&&e.slideMasterTables&&(a=void 0!==r?e.slideMasterTables.idxTable[r]:void 0!==i?e.slideMasterTables.typeTable[i]:null),a){const t=this.getTextByPathList(a,["p:spPr","a:xfrm"]);if(t){const e=this.getAttrs(t["a:off"]),r=this.getAttrs(t["a:ext"]);e&&(s.x=Math.round(parseInt(e.x)*l),s.y=Math.round(parseInt(e.y)*l)),r&&(s.width=Math.round(parseInt(r.cx)*l),s.height=Math.round(parseInt(r.cy)*l))}}}}}s.fillColor=this.parseShapeFill(t,e),s.borderColor=this.parseShapeBorder(t,e);const n=r?.["p:nvPr"],h=n?.["p:ph"],d=this.getAttrs(h);d&&(s.placeholder={idx:d.idx,type:d.type,orient:d.orient,sz:d.sz,hasCustomPrompt:d.hasCustomPrompt}),s.node=t;const p=this.getTextByPathList(t,["p:txBody"]);p?s.textBlocks=this.parseTextBody(p,e,s.x||0,s.y||0,s.width||0,s.height||0):s.placeholder&&(s.textBlocks=this.getPlaceholderText(s.placeholder,e,s.x||0,s.y||0,s.width||0,s.height||0));const c=this.getTextByPathList(t,["p:spPr","a:prstGeom"]),g=this.getAttrs(c);return g?.prst&&(s.shapeType=g.prst),s.warpObj=e,s}processPictureNode(t,e){const s=this.getTextByPathList(t,["p:blipFill","a:blip"]),r=this.getAttrs(s);if(!r)return null;const i=r["r:embed"];if(!i)return null;const a=this.getTextByPathList(t,["p:spPr","a:xfrm"]),o=this.getAttrs(a?.["a:off"]),n=this.getAttrs(a?.["a:ext"]);return{type:"image",rId:i,x:o?Math.round(parseInt(o.x)*l):0,y:o?Math.round(parseInt(o.y)*l):0,width:n?Math.round(parseInt(n.cx)*l):0,height:n?Math.round(parseInt(n.cy)*l):0}}processGraphicFrameNode(t,e){const s=this.getTextByPathList(t,["a:graphic"]);if(!s)return null;const r=this.getTextByPathList(s,["a:graphicData","a:tbl"]);if(r)return this.parseTable(r,t,e);const i=this.getTextByPathList(s,["a:graphicData","c:chart"]);return i?this.parseChart(i,t):null}processGroupNode(t,e){const s={type:"group",children:[]},r=this.getTextByPathList(t,["p:grpSpPr","a:xfrm"]);if(r){const t=this.getAttrs(r["a:off"]),e=this.getAttrs(r["a:ext"]);t&&(s.x=Math.round(parseInt(t.x)*l),s.y=Math.round(parseInt(t.y)*l)),e&&(s.width=Math.round(parseInt(e.cx)*l),s.height=Math.round(parseInt(e.cy)*l))}return Object.keys(t).forEach(r=>{if("p:nvGrpSpPr"===r||"p:grpSpPr"===r)return;const i=t[r];(Array.isArray(i)?i:[i]).forEach(t=>{const i=this.processNode(r,t,e);i&&s.children.push(i)})}),s}parseTextBody(t,e,s,r,i,a){const l=[],o=t["a:p"];if(!o)return l;return(Array.isArray(o)?o:[o]).forEach((t,o)=>{const n={runs:[],alignment:this.parseTextAlignment(t),verticalAlign:this.parseVerticalAlignment(t),x:s,y:r,width:i,height:a},h=t["a:r"];if(!h)return;(Array.isArray(h)?h:[h]).forEach(t=>{const s=this.parseTextRunWithLink(t,e);s&&n.runs.push(s)}),n.runs.length>0&&l.push(n)}),l}parseTextRunWithLink(t,e){const s=this.parseTextRun(t),r=t["a:rPr"]?.["a:hlinkClick"];if(r){const t=this.getAttr(r,"r:id");t&&e.slideResObj[t]&&(s.link=e.slideResObj[t].target)}return s}parseTextRun(t){let e=t["a:t"];"string"!=typeof e&&(e=this.getTextByPathList(t,["a:fld","a:t"]),"string"!=typeof e&&(e="")),e&&(e=e.replace(/\t/g,"    ").replace(/\n/g," "));const s={text:e||""},r=t["a:rPr"],i=this.getAttrs(r);if(i){if(i.sz){const t=parseInt(i.sz);isNaN(t)||(s.fontSize=t/100*1.25)}"1"===i.b&&(s.bold=!0),"1"===i.i&&(s.italic=!0),"1"===i.u&&(s.underline=!0),"1"===i.strike&&(s.strike=!0)}if(r){const t=this.getAttrs(r["a:ea"]);t?.typeface&&(s.fontFamily=t.typeface);const e=this.getAttrs(r["a:latin"]);e?.typeface&&!s.fontFamily&&(s.fontFamily=e.typeface);const i=this.getAttrs(r["a:cs"]);i?.typeface&&!s.fontFamily&&(s.fontFamily=i.typeface);const a=this.getAttrs(r["a:ea"]);a?.type&&!s.fontFamily&&(s.fontFamily=a.type);const l=this.getAttrs(r["a:latin"]);l?.type&&!s.fontFamily&&(s.fontFamily=l.type);const o=this.getAttrs(r["a:cs"]);o?.type&&!s.fontFamily&&(s.fontFamily=o.type)}return r?.["a:solidFill"]&&(s.color=this.getColorValue(r["a:solidFill"])),s}parseTextAlignment(t){const e=t["a:pPr"],s=this.getAttrs(e),r=s?.algn;switch(r){case"ctr":return"center";case"r":return"right";case"just":return"justify";default:return"left"}}parseVerticalAlignment(t){const e=t["a:pPr"],s=this.getAttrs(e),r=s?.anchor;switch(r){case"ctr":return"middle";case"b":return"bottom";default:return"top"}}parseShapeFill(t,e){const s=this.getTextByPathList(t,["p:spPr","a:solidFill"]);if(s&&e){const t=this.getSolidFill(s,e);return t?`#${t}`:void 0}}parseShapeBorder(t,e){const s=this.getTextByPathList(t,["p:spPr","a:ln"]);if(s?.["a:solidFill"]&&e){const t=this.getSolidFill(s["a:solidFill"],e);return t?`#${t}`:void 0}}parseSlideBackground(t){const e=this.getTextByPathList(t,["p:sld","p:cSld","p:bg"]);if(!e)return;const s=this.getTextByPathList(e,["p:bgPr","a:solidFill"]);return s?this.getColorValue(s):void 0}getSlideBackgroundFill(t){const{slideContent:e,slideLayoutContent:s,slideMasterContent:r,themeContent:i}=t;let a=this.getTextByPathList(e,["p:sld","p:cSld","p:bg"]);if(a){const e=a["p:bgPr"],s=a["p:bgRef"];if(e)return this.getBgFill(e,t);if(s)return this.getBgRef(s,t)}if(a=this.getTextByPathList(s,["p:sldLayout","p:cSld","p:bg"]),a){const e=a["p:bgPr"],s=a["p:bgRef"];if(e)return this.getBgFill(e,t);if(s)return this.getBgRef(s,t)}if(a=this.getTextByPathList(r,["p:sldMaster","p:cSld","p:bg"]),a){const e=a["p:bgPr"],s=a["p:bgRef"];if(e)return this.getBgFill(e,t);if(s)return this.getBgRef(s,t)}}getSlideBackgroundInfo(t){const{slideContent:e,slideLayoutContent:s,slideMasterContent:r}=t;let i={},a=this.getTextByPathList(e,["p:sld","p:cSld","p:bg"]);if(a){const e=a["p:bgPr"],s=a["p:bgRef"];if(e){if(i.color=this.getBgColor(e,t),i.image=this.getBgImage(e,t),i.color||i.image)return i}else if(s&&(i=this.getBgRefInfo(s,t),i.color||i.image))return i}if(a=this.getTextByPathList(s,["p:sldLayout","p:cSld","p:bg"]),a){const e=a["p:bgPr"],s=a["p:bgRef"];if(e){if(i.color=this.getBgColor(e,t),i.image=this.getBgImage(e,t),i.color||i.image)return i}else if(s&&(i=this.getBgRefInfo(s,t),i.color||i.image))return i}if(a=this.getTextByPathList(r,["p:sldMaster","p:cSld","p:bg"]),a){const e=a["p:bgPr"],s=a["p:bgRef"];if(e){if(i.color=this.getBgColor(e,t),i.image=this.getBgImage(e,t),i.color||i.image)return i}else if(s&&(i=this.getBgRefInfo(s,t),i.color||i.image))return i}return i}getBgFill(t,e){const s=t["a:solidFill"];if(s){const t=this.getSolidFill(s,e);return t?`#${t}`:void 0}const r=t["a:blipFill"];if(r)return this.getBlipFill(r,e);const i=t["a:gradFill"];return i?this.getGradFill(i,e):void 0}getBgColor(t,e){const s=t["a:solidFill"];if(s){const t=this.getSolidFill(s,e);return t?`#${t}`:void 0}const r=t["a:gradFill"];if(r){const t=r["a:gsLst"];if(t){const s=t["a:gs"];if(s){const t=Array.isArray(s)?s:[s];if(t[0]){const s=t[0]["a:solidFill"];if(s){const t=this.getSolidFill(s,e);return t?`#${t}`:void 0}}}}}}getBgImage(t,e){const s=t["a:blipFill"];if(s)return this.getBlipFill(s,e)}getBlipFill(t,e){const s=t["a:blip"];if(s){const t=this.getAttr(s,"r:embed");if(t){if(e.layoutResObj[t])return e.layoutResObj[t].target.replace("../","ppt/");if(e.masterResObj[t])return e.masterResObj[t].target.replace("../","ppt/");if(e.themeResObj[t])return e.themeResObj[t].target.replace("../","ppt/")}}}getGradFill(t,e){const s=t["a:gsLst"];if(s){const t=s["a:gs"];if(t){const s=Array.isArray(t)?t:[t];if(s[0]){const t=s[0]["a:solidFill"];if(t){const s=this.getSolidFill(t,e);return s?`#${s}`:void 0}}}}}getBgRefInfo(t,e){const s={},r=this.getAttr(t,"idx");if(!r)return s;const i=parseInt(r);if(i>1e3){const t=i-1e3,r=this.getTextByPathList(e.themeContent,["a:theme","a:themeElements","a:fmtScheme","a:bgFillStyleLst"]);if(r){const i=Object.keys(r).filter(t=>t.startsWith("a:"));if(i[t-1]){const a=r[i[t-1]];if(a["a:solidFill"]){const t=this.getSolidFill(a["a:solidFill"],e);s.color=t?`#${t}`:void 0}if(a["a:blipFill"]&&(s.image=this.getBlipFill(a["a:blipFill"],e)),a["a:gradFill"]){const t=this.getGradFill(a["a:gradFill"],e);s.color=t}}}}else s.image=this.getBgImageFromRef(i,e);return s}getBgImageFromRef(t,e){}getBgRef(t,e){const s=this.getAttr(t,"idx");if(!s)return;const r=parseInt(s);if(r>1e3){const t=r-1e3,s=this.getTextByPathList(e.themeContent,["a:theme","a:themeElements","a:fmtScheme","a:bgFillStyleLst"]);if(s){const r=Object.keys(s).filter(t=>t.startsWith("a:"));if(r[t-1]){const i=s[r[t-1]];if(i["a:solidFill"]){const t=this.getSolidFill(i["a:solidFill"],e);return t?`#${t}`:void 0}if(i["a:blipFill"])return this.getBlipFill(i["a:blipFill"],e);if(i["a:gradFill"])return this.getGradFill(i["a:gradFill"],e)}}}}getSolidFill(t,e){if(t["a:srgbClr"]){const e=this.getAttrs(t["a:srgbClr"]);return e?.val}if(t["a:schemeClr"]){const s=t["a:schemeClr"],r=this.getAttrs(s);if(r?.val)return this.getSchemeColorFromTheme(r.val,e)}else if(t["a:prstClr"]){const e=t["a:prstClr"],s=this.getAttrs(e);if(s?.val)return this.getPrstColorValue(s.val)}else if(t["a:sysClr"]){const e=t["a:sysClr"],s=this.getAttrs(e);return s?.lastClr}}getSchemeColorFromTheme(t,e){if(this.themeColors[t])return this.themeColors[t];const s=this.getTextByPathList(e.themeContent,["a:theme","a:themeElements","a:clrScheme"]);if(s){const e=s[`a:${t}`];if(e)return this.getColorValue(e)}}getPlaceholderText(t,e,s,r,i,a){const l=t.idx,o=t.type;let n=null;if(e.slideLayoutTables&&(n=void 0!==l?e.slideLayoutTables.idxTable[l]:void 0!==o?e.slideLayoutTables.typeTable[o]:null),!n&&e.slideMasterTables&&(n=void 0!==l?e.slideMasterTables.idxTable[l]:void 0!==o?e.slideMasterTables.typeTable[o]:null),n){const t=this.getTextByPathList(n,["p:txBody"]);if(t)return this.parseTextBody(t,e,s,r,i,a)}return[]}getColorMapOverride(t,e,s){const r={},i=this.getTextByPathList(t,["p:sld","p:clrMapOvr","a:overrideClrMapping"]);if(i){const t=this.getAttrs(i);r.slide=t}const a=this.getTextByPathList(e,["p:sldLayout","p:clrMapOvr","a:overrideClrMapping"]);if(a){const t=this.getAttrs(a);r.layout=t}const l=this.getTextByPathList(s,["p:sldMaster","p:clrMap","a:clrMapping"]);if(l){const t=this.getAttrs(l);r.master=t}return r}parseTable(t,e,s){const r={type:"table",rows:[],style:{}},i=t["a:tblGrid"]?.["a:gridCol"];if(i){const t=Array.isArray(i)?i:[i];r.columnWidths=t.map(t=>{const e=this.getAttrs(t);return Math.round(parseInt(e?.w||"0")*l)})}const a=t["a:tr"];if(!a)return r;return(Array.isArray(a)?a:[a]).forEach(t=>{const e={cells:[]},i=t["a:tc"];if(!i)return;(Array.isArray(i)?i:[i]).forEach(t=>{const r={textBlocks:[]},i=t["a:txBody"];i&&(r.textBlocks=this.parseTextBody(i,s,0,0,0,0)),e.cells.push(r)}),r.rows.push(e)}),r}parseChart(t,e){return{type:"chart",chartType:this.getTextByPathList(t,["c:chart","attrs","r:id"])||"unknown"}}async parseMedia(){for(const t in this.slides){const e=this.slides[t];if(e.backgroundImage&&(e.backgroundImageData=await this.extractImage(e.backgroundImage)),!e.images||0===e.images.length)continue;const s=`ppt/slides/_rels/slide${t}.xml.rels`,r=await this.readXmlFile(s);if(!r)continue;const i=r.Relationships?.Relationship;if(!i)continue;const a=Array.isArray(i)?i:[i],l=new Map(a.map(t=>{const e=this.getAttrs(t);return[e?.Id,e?.Target]}));for(const t of e.images){const e=l.get(t.rId);e&&(t.path=e.replace("../","ppt/"),t.data=await this.extractImage(t.path))}}}async extractImage(t){if(this.imageCache.has(t))return this.imageCache.get(t);try{const e=this.zip.file(t);if(!e)return"";const s=await e.async("base64"),r=t.split(".").pop()?.toLowerCase()||"",i=`data:${{png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",bmp:"image/bmp",svg:"image/svg+xml",emf:"image/x-emf",wmf:"image/x-wmf"}[r]||"image/png"};base64,${s}`;return this.imageCache.set(t,i),i}catch(e){return console.error(`Failed to extract image ${t}:`,e),""}}getColorValue(t){if(t){if(t["a:prstClr"])return this.getPrstColorValue(t["a:prstClr"]);if(t["a:schemeClr"]){const e=t["a:schemeClr"],s=this.getAttrs(e);if(s?.val)return this.themeColors[s.val]}if(t["a:srgbClr"]){const e=t["a:srgbClr"],s=this.getAttrs(e);return`#${s?.val||"000000"}`}if(t["a:sysClr"]){const e=t["a:sysClr"],s=this.getAttrs(e);return s?.lastClr||void 0}}}getPrstColorValue(t){const e=this.getAttrs(t);if(!e?.val)return;const s=e.val,r={black:"000000",white:"FFFFFF",red:"FF0000",green:"00FF00",blue:"0000FF",yellow:"FFFF00",cyan:"00FFFF",magenta:"FF00FF",gray:"808080"};return r[s]?`#${r[s]}`:void 0}async readXmlFile(t){try{const s=this.zip.file(t);if(!s)return null;const r=await s.async("uint8array"),i=new TextDecoder("utf-8").decode(r);return new e.XMLParser({ignoreAttributes:!1,attributeNamePrefix:"@_",textNodeName:"#text",ignoreDeclaration:!0,ignorePiTags:!0,isArray:(t,e,s,r)=>!!["a:gridCol","a:tr","a:tc","a:p","a:r","Relationship"].includes(t)}).parse(i)}catch(e){return console.error(`Failed to read XML file ${t}:`,e),null}}getTextByPathList(t,e){if(!t)return;let s=t;for(const t of e){if(!s||void 0===s[t])return;s=s[t]}return s}getAttrs(t){if(!t)return;const e={};for(const s in t)s.startsWith("@_")&&(e[s.substring(2)]=t[s]);return Object.keys(e).length>0?e:void 0}getAttr(t,e){if(t)return t[`@_${e}`]}parseTextElements(t){return[]}parseTextBlocks(t){return[]}parseShapes(t){return[]}parseMediaElements(t){return[]}parseGraphs(t){return[]}parseTables(t){return[]}parseSmartArt(t){return[]}parseEquations(t){return[]}getSlides(){return this.slides}getTotalSlides(){return this.totalSlides}getSlideWidth(){return this.slideWidth}getSlideHeight(){return this.slideHeight}getWarpObjForSlide(t){const e=this.slides[t];if(!e)return null;const s=e.layout?.content,r=e.layout?.tables,i=e.master?.content,a=e.master?.tables,l=e.theme?.content,o=this.getTextByPathList(i,["p:sldMaster","p:txStyles"]);return{zip:this.zip,slideContent:e,slideLayoutContent:s,slideLayoutTables:r,slideMasterContent:i,slideMasterTables:a,slideResObj:{},layoutResObj:{},masterResObj:{},themeContent:l,themeResObj:{},defaultTextStyle:this.defaultTextStyle,slideMasterTextStyles:o}}}class n{constructor(t,e){this.options=t,this.buffer=e,this.styleTable={},this.parser=new o(e)}async render(){await this.parser.init();const t=this.parser.getSlides(),e=this.parser.getTotalSlides(),s=this.parser.getSlideWidth(),r=this.parser.getSlideHeight();let i='<div class="pptxjs-container">';for(let a=1;a<=e;a++){const e=t[a];if(e){const t=this.parser.getWarpObjForSlide(a);i+=this.renderSlide(e,a,s,r,t)}}const a=this.generateGlobalCSS();return a&&(i+=`<style>${a}</style>`),i+="</div>",i}renderSlide(t,e,s,r,i){const a="revealjs"===this.options.slideType?"section":"div";let l=`<${a} class="slide" data-slide-id="${e}" style="width:${t.width||s}px;height:${t.height||r}px;">`;return!t.backgroundColor||t.backgroundImage||t.backgroundImageData?t.backgroundImageData&&(l+=`<div class="slide-background" style="width:100%;height:100%;background-image:url('${t.backgroundImageData}');background-size:cover;background-position:center;"></div>`):l+=`<div class="slide-background" style="width:100%;height:100%;background-color:${t.backgroundColor};"></div>`,t.layout&&t.layout.shapes&&t.layout.shapes.forEach(e=>{t.shapes&&t.shapes.some(t=>t.placeholder?.idx===e.placeholderType?.placeholder?.idx)||(l+=this.renderShape(e,i))}),t.master&&t.master.shapes&&t.master.shapes.forEach(e=>{const s=t.layout&&t.layout.shapes&&t.layout.shapes.some(t=>t.placeholder?.idx===e.placeholderType?.placeholder?.idx),r=t.shapes&&t.shapes.some(t=>t.placeholder?.idx===e.placeholderType?.placeholder?.idx);s||r||(l+=this.renderShape(e,i))}),t.shapes&&t.shapes.forEach(t=>{l+=this.renderShape(t,i)}),t.images&&t.images.forEach(t=>{l+=this.renderImage(t)}),t.tables&&t.tables.forEach(t=>{l+=this.renderTable(t)}),t.graphs&&t.graphs.forEach(t=>{l+=this.renderChart(t)}),l+=`</${a}>`,l}renderShape(t,e){const s=[`top:${t.y||0}px`,`left:${t.x||0}px`,`width:${t.width||0}px`,`height:${t.height||0}px`,"1px solid hidden","background-color: inherit",`z-index: ${t.id||1}`,`transform: rotate(${t.rotation||0}deg)`];let r,i='<div class="block v-up content"';return void 0!==t.id&&(i+=` _id="${t.id}"`),void 0!==t.placeholder?.idx&&(i+=` _idx="${t.placeholder.idx}"`),t.placeholder?.type&&(i+=` _type="${t.placeholder.type}"`),t.name&&(i+=` _name="${t.name}"`),i+=` style="${s.join(";")}">`,t.textBodyNode?r=t.textBodyNode:t.node&&(r=t.node["p:txBody"]),r&&e?i+=this.genTextBody(r,t,e,t.type,t.placeholder?.idx):t.textBlocks&&(i+=this.renderTextBlocksLegacy(t.textBlocks,t)),i+="</div>",i}genTextBody(t,e,s,r,i){let a="";if(!t)return a;const l=this.getTextByPathList(e,["p:style","a:fontRef"]),o=t["a:p"],n=Array.isArray(o)?o:[o];for(let o=0;o<n.length;o++){const h=n[o];let d="";const p=this.getVerticalMargins(h,t,r,i,s);p&&(d=p),"body"!==r&&"obj"!==r&&"shape"!==r||(d+="font-size: 0px;",d+="font-weight: 100;",d+="font-style: normal;");const c=this.getStyleClass(d),g=this.getTextByPathList(e,["p:spPr","a:xfrm","a:ext","attrs","cx"]),y=void 0!==g?`width:${parseInt(g)*(96/914400)}px;`:"width:inherit;";a+=`<div style='display: flex;${y}' class='slide-prgrph h-left pregraph-ltr ${c} ${this.getPregraphDir(h,t,i,r,s)}'>`,a+=`<div style='height:100%;direction:initial;overflow-wrap:break-word;word-wrap:break-word;${y}'>`;let f=h["a:r"],u=h["a:fld"];if(h["a:br"],void 0!==f&&(f=Array.isArray(f)?f:[f]),void 0!==u&&(u=Array.isArray(u)?u:[u]),void 0!==f&&void 0!==u&&(f=f.concat(u)),void 0!==f)for(let e=0;e<f.length;e++)a+=this.genSpanElement(f[e],e,h,t,l,void 0,i,r,f.length,s);a+="</div></div>"}return a}renderTextBlocksLegacy(t,e){let s="";return t&&t.length>0&&t.forEach(t=>{t.runs&&t.runs.length>0&&t.runs.forEach(t=>{const e=[];void 0!==t.fontSize&&e.push(`font-size:${t.fontSize}px`),t.fontFamily&&e.push(`font-family:${t.fontFamily}`),e.push("font-weight:"+(t.bold?"bold":"inherit")),e.push("font-style:"+(t.italic?"italic":"inherit")),e.push("text-decoration:"+(t.underline?"underline":t.strike?"line-through":"inherit")),e.push("text-align:left"),e.push("vertical-align:baseline"),t.color&&e.push(`color:${t.color}`);const r=e.join(";"),i=this.getStyleClass(r);s+=`<span class="text-block ${i}">${this.escapeHtml(t.text||"")}</span>`})}),s}genSpanElement(t,e,s,r,i,a,l,o,n,h,d=!1){let p="";const c=r?r["a:lstStyle"]:void 0,g=h.slideMasterTextStyles;let y=t["a:t"];"string"!=typeof y&&(y=this.getTextByPathList(t,["a:fld","a:t"]),"string"!=typeof y&&(y="&nbsp;"));const f=s["a:pPr"];let u=1;const x=this.getTextByPathList(f,["attrs","lvl"]);void 0!==x&&(u=parseInt(x)+1);const m=this.getFontSize(t,r,i,u,o,h);p+=`font-size:${m};`;const T=this.getFontType(t,o,h,i);p+=`font-family:${T};`;const b=this.getFontBold(t,o,g);p+=`font-weight:${b};`;const P=this.getFontItalic(t,o,g);p+=`font-style:${P};`;const v=this.getFontDecoration(t,o,g);p+=`text-decoration:${v};`;const B=this.getTextHorizontalAlign(t,s,o,h);p+=`text-align:${B};`;const S=this.getTextVerticalAlign(t,o,g);p+=`vertical-align:${S};`;const F=this.getFontColorPr(t,s,c,i,u,l,o,h),L=F[2];"solid"===L&&(void 0!==F[0]&&""!==F[0]&&(p+=`color:#${F[0]};`),void 0!==F[1]&&""!==F[1]&&(p+=`text-shadow:${F[1]};`),void 0!==F[3]&&""!==F[3]&&(p+=`background-color:#${F[3]};`));let A=this.getVerticalMargins(s,r,o,l,h);"inherit"!==m&&"0px"!==m&&(A+=`font-size:${m};`),"inherit"!==T&&(A+=`font-family:${T};`),"inherit"!==b&&"normal"!==b&&(A+=`font-weight:${b};`),"inherit"!==P&&"normal"!==P&&(A+=`font-style:${P};`),"inherit"!==v&&"none"!==v&&(A+=`text-decoration:${v};`),"left"!==B&&(A+=`text-align:${B};`),"baseline"!==S&&(A+=`vertical-align:${S};`);const w=this.getTextByPathList(t,["a:rPr","attrs","lang"]);A+=void 0!==w&&-1!==["he-IL","ar-AE","ar-SA","dv-MV","fa-IR","ur-PK"].indexOf(w)?"direction:rtl;":"direction:ltr;","solid"===L&&void 0!==F[0]&&""!==F[0]&&(A+=`color:#${F[0]};`);const C=this.getStyleClass(A);let $="";return"solid"===L&&(void 0!==F[1]&&""!==F[1]&&($+=`text-shadow:${F[1]};`),void 0!==F[3]&&""!==F[3]&&($+=`background-color:#${F[3]};`)),`<span class="${C}" style="${$}">${this.escapeHtml(y||"")}</span>`}getFontSize(t,e,s,r,i,a){let l,o,n;const h=e?e["a:lstStyle"]:void 0,d=`a:lvl${r}pPr`;if(void 0!==t["a:rPr"]){const e=this.getAttr(t["a:rPr"],"sz");void 0!==e&&(l=parseInt(e)/100)}return"number"!=typeof l&&void 0!==t["a:fld"]&&(o=this.getTextByPathList(t["a:fld"],["a:rPr","attrs","sz"]),void 0!==o&&(l=parseInt(o)/100)),"number"!=typeof l&&t["a:t"],"number"!=typeof l&&void 0!==h&&(o=this.getTextByPathList(h,[d,"a:defRPr","attrs","sz"]),void 0!==o&&(l=parseInt(o)/100)),"number"!=typeof l&&(o=this.getTextByPathList(a.slideLayoutTables,["typeTable",i,"p:txBody","a:lstStyle",d,"a:defRPr","attrs","sz"]),n=this.getTextByPathList(a.slideLayoutTables,["typeTable",i,"p:txBody","a:lstStyle",d,"a:defRPr","attrs","kern"]),void 0!==o&&(l=parseInt(o)/100),void 0!==n&&"number"==typeof l&&l-parseInt(n)/100>0&&(l-=parseInt(n)/100)),"number"!=typeof l&&(o=this.getTextByPathList(a.slideMasterTables,["typeTable",i,"p:txBody","a:lstStyle",d,"a:defRPr","attrs","sz"]),n=this.getTextByPathList(a.slideMasterTables,["typeTable",i,"p:txBody","a:lstStyle",d,"a:defRPr","attrs","kern"]),void 0===o&&("title"===i||"subTitle"===i||"ctrTitle"===i?(o=this.getTextByPathList(a.slideMasterTextStyles,["p:titleStyle",d,"a:defRPr","attrs","sz"]),n=this.getTextByPathList(a.slideMasterTextStyles,["p:titleStyle",d,"a:defRPr","attrs","kern"])):"body"===i||"obj"===i||"dt"===i||"sldNum"===i||"textBox"===i?(o=this.getTextByPathList(a.slideMasterTextStyles,["p:bodyStyle",d,"a:defRPr","attrs","sz"]),n=this.getTextByPathList(a.slideMasterTextStyles,["p:bodyStyle",d,"a:defRPr","attrs","kern"])):"shape"===i&&(o=this.getTextByPathList(a.slideMasterTextStyles,["p:otherStyle",d,"a:defRPr","attrs","sz"]),n=this.getTextByPathList(a.slideMasterTextStyles,["p:otherStyle",d,"a:defRPr","attrs","kern"]))),void 0!==o&&(l=parseInt(o)/100),void 0!==n&&"number"==typeof l&&l-parseInt(n)/100>parseInt(n)/100&&(l-=parseInt(n)/100)),"number"!=typeof l&&(o=this.getTextByPathList(a.defaultTextStyle,[d,"a:defRPr","attrs","sz"]),void 0!==o&&(l=parseInt(o)/100)),("number"!=typeof l||l<=0)&&(l="title"===i||"subTitle"===i||"ctrTitle"===i?44:"body"===i||"obj"===i||"dt"===i||"sldNum"===i?18:14),1.25*l+"px"}getFontType(t,e,s,r){let i=this.getTextByPathList(t,["a:rPr","a:ea","attrs","typeface"]);if(void 0===i&&(i=this.getTextByPathList(t,["a:rPr","a:latin","attrs","typeface"])),void 0===i&&(i=this.getTextByPathList(t,["a:rPr","a:cs","attrs","typeface"])),void 0===i&&s&&s.themeContent){let t,a="";r&&r.attrs&&(t=this.getAttr(r,"idx"));const l=this.getTextByPathList(s.themeContent,["a:theme","a:themeElements","a:fontScheme"]);l&&(t||(t="title"===e||"subTitle"===e||"ctrTitle"===e?"major":"minor"),a=`a:${t}Font`,i=this.getTextByPathList(l,[a,"a:ea","attrs","typeface"]),void 0===i&&(i=this.getTextByPathList(l,[a,"a:latin","attrs","typeface"])),void 0===i&&(i=this.getTextByPathList(l,[a,"a:cs","attrs","typeface"])))}return void 0===i||""===i?"inherit":i}getFontBold(t,e,s){return void 0!==t["a:rPr"]&&"1"===this.getAttr(t["a:rPr"],"b")?"bold":"inherit"}getFontItalic(t,e,s){return void 0!==t["a:rPr"]&&"1"===this.getAttr(t["a:rPr"],"i")?"italic":"inherit"}getFontDecoration(t,e,s){if(void 0!==t["a:rPr"]){const e=this.getAttr(t["a:rPr"],"u"),s=this.getAttr(t["a:rPr"],"strike");if(void 0!==e&&"none"!==e&&void 0===s)return"underline";if(void 0===e&&void 0!==s)return"line-through";if(void 0!==e&&void 0!==s)return"underline line-through"}return"none"}getTextHorizontalAlign(t,e,s,r){let i=this.getTextByPathList(e,["a:pPr","attrs","algn"]);const a=this.getTextByPathList(e,["a:pPr","attrs","lvl"]),l=`a:lvl${void 0!==a?parseInt(a)+1:1}pPr`,o=e?this.getTextByPathList(e["p:txBody"],["a:lstStyle"]):void 0;if(void 0===i&&(i=this.getTextByPathList(o,[l,"attrs","algn"])),void 0===i&&r.slideLayoutTables){const t=r.slideLayoutTables.idxTable;if(t){const e=Object.keys(t)[0];e&&(i=this.getTextByPathList(t[e],["p:txBody","a:lstStyle",l,"attrs","algn"]))}}switch(void 0===i&&r.slideMasterTextStyles&&("title"===s||"ctrTitle"===s?i=this.getTextByPathList(r.slideMasterTextStyles,["p:titleStyle",l,"attrs","algn"]):"body"===s||"obj"===s||"subTitle"===s?i=this.getTextByPathList(r.slideMasterTextStyles,["p:bodyStyle",l,"attrs","algn"]):"shape"===s&&(i=this.getTextByPathList(r.slideMasterTextStyles,["p:otherStyle",l,"attrs","algn"]))),i){case"ctr":return"center";case"r":return"right";case"just":case"justLow":case"dist":case"thaiDist":return"justify";default:return"left"}}getTextVerticalAlign(t,e,s){return this.getTextByPathList(t,["a:rPr","attrs","baseline"])||"baseline"}getPregraphDir(t,e,s,r,i){return"pregraph-ltr"}getVerticalMargins(t,e,s,r,i){let a=1,l=this.getTextByPathList(t,["a:pPr","a:spcBef","a:spcPts","attrs","val"]),o=this.getTextByPathList(t,["a:pPr","a:spcAft","a:spcPts","attrs","val"]),n=this.getTextByPathList(t,["a:pPr","a:lnSpc","a:spcPct","attrs","val"]),h="Pct";void 0===n&&(n=this.getTextByPathList(t,["a:pPr","a:lnSpc","a:spcPts","attrs","val"]),void 0!==n&&(h="Pts"));const d=this.getTextByPathList(t,["a:pPr","attrs","lvl"]);let p;if(void 0!==d&&(a=parseInt(d)+1),void 0!==t["a:r"]){const r=this.getFontSize(t["a:r"],e,void 0,a,s,i);"inherit"!==r&&(p=parseInt(r,10))}const c="shape"!==s&&"textBox"!==s;if(c&&(void 0===l||void 0===o||void 0===n)&&void 0!==r){const t=this.getTextByPathList(i,["slideLayoutTables","idxTable",r.toString(),"p:txBody","a:p",(a-1).toString(),"a:pPr"]);void 0===l&&(l=this.getTextByPathList(t,["a:spcBef","a:spcPts","attrs","val"])),void 0===o&&(o=this.getTextByPathList(t,["a:spcAft","a:spcPts","attrs","val"])),void 0===n&&(n=this.getTextByPathList(t,["a:lnSpc","a:spcPct","attrs","val"]),void 0===n&&(n=this.getTextByPathList(t,["a:pPr","a:lnSpc","a:spcPts","attrs","val"]),void 0!==n&&(h="Pts")))}if(c&&(void 0===l||void 0===o||void 0===n)){const t=i.slideMasterTextStyles;let e="";const r=`a:lvl${a}pPr`;switch(s){case"title":case"ctrTitle":e="p:titleStyle";break;case"body":case"obj":case"dt":case"ftr":case"sldNum":case"textBox":e="p:bodyStyle";break;default:e="p:otherStyle"}const d=this.getTextByPathList(t,[e,r]);void 0!==d&&(void 0===l&&(l=this.getTextByPathList(d,["a:spcBef","a:spcPts","attrs","val"])),void 0===o&&(o=this.getTextByPathList(d,["a:spcAft","a:spcPts","attrs","val"])),void 0===n&&(n=this.getTextByPathList(d,["a:lnSpc","a:spcPct","attrs","val"]),void 0===n&&(n=this.getTextByPathList(d,["a:pPr","a:lnSpc","a:spcPts","attrs","val"]),void 0!==n&&(h="Pts"))))}let g=0,y=0,f=0,u="";if(void 0!==l&&(g=parseInt(l)/100),void 0!==o&&(y=parseInt(o)/100),void 0!==n&&void 0!==p)if("Pts"===h)u+=`padding-top: ${parseInt(n)/100-p}px;`;else{const t=parseInt(n)/1e5;f=p*(t-1)-p;u+=`padding-top: ${t>1?f:0}px;`,u+=`padding-bottom: ${f}px;`}return void 0===l&&void 0===n||(u+=`margin-top: ${g-1}px;`),void 0===o&&void 0===n||(u+=`margin-bottom: ${y}px;`),u}getLayoutAndMasterNode(t,e){return{nodeLaout:void 0,nodeMaster:void 0}}getFontColorPr(t,e,s,r,i,a,l,o){let n="";const h=t["a:rPr"];return h&&h["a:solidFill"]&&(n=this.getSolidFill(h["a:solidFill"])),[n,"",n?"solid":"",""]}getSolidFill(t){const e=t?.["a:srgbClr"];if(e){return this.getAttr(e,"val")||""}return""}getAttr(t,e){if(t&&t.attrs)return t.attrs[e]}getTextByPathList(t,e){if(!t)return;let s=t;for(const t of e){if(!s||void 0===s[t])return;s=s[t]}return s}renderImage(t){const e=["position:absolute",`left:${t.x||0}px`,`top:${t.y||0}px`,`width:${t.width||0}px`,`height:${t.height||0}px`],s=t.data||"";return`<img class="slide-image" style="${e.join(";")}" src="${s}" alt="slide image" />`}renderTable(t){let e='<table class="slide-table">';return t.rows&&t.rows.forEach(t=>{e+="<tr>",t.cells&&t.cells.forEach(t=>{e+="<td>",t.textBlocks&&t.textBlocks.forEach(t=>{e+=this.renderTextBlock(t)}),e+="</td>"}),e+="</tr>"}),e+="</table>",e}renderChart(t){return`<div class="slide-chart" data-chart-type="${t.chartType||"unknown"}">Chart placeholder</div>`}getStyleClass(t){if(this.styleTable[t])return this.styleTable[t].name;const e=`_css_${Object.keys(this.styleTable).length+1}`;return this.styleTable[t]={name:e,text:t},e}generateGlobalCSS(){let t="";for(const e in this.styleTable){const s=this.styleTable[e];t+=`.text-block.${s.name}{${s.text}}\n`}return t}escapeHtml(t){if("string"!=typeof t)return t?.toString?.()||t;const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return t.replace(/[&<>"']/g,t=>e[t])}renderTextBlock(t,e){return""}}var h;async function d(t){const e=await a(t.pptxFileUrl);return new n(t,e).render()}exports.PptxElementType=void 0,(h=exports.PptxElementType||(exports.PptxElementType={})).TEXT="text",h.TEXT_BLOCK="text_block",h.SHAPE="shape",h.MEDIA="media",h.GRAPH="graph",h.TABLE="table",h.SMART_ART="smart_art",h.EQUATION="equation","browser"===i()&&(window.pptxToHtml=d),exports.detectEnv=i,exports.pptxToHtml=d,exports.readPptxFile=a;
//# sourceMappingURL=ppt-parser.cjs.js.map
