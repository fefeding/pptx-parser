<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>pptx 解析</title>

<!-- 引入 PPTX 解析所需的样式表 -->
<link rel="stylesheet" href="/src/css/pptxjs.css">
<link rel="stylesheet" href="/src/css/nv.d3.min.css">

<!-- 引入 PPTX 解析所需的第三方库 -->
<script type="text/javascript" src="/src/lib/jszip.min.js"></script>
<script type="text/javascript" src="/src/lib/d3.min.js"></script>
<script type="text/javascript" src="/src/lib/nv.d3.min.js"></script>


<style>
	html, body { margin: 0; padding: 0; }
	#warper { margin-right: auto; margin-left: 20px; }
	.slides-loadnig-msg { display:block; width:100%; color:white; background-color: #ddd; }
	.slides-loading-progress-bar { width: 1%; background-color: #4775d1; }
</style>
</head>
<body>
	<!-- 主容器 -->
	<div id="warper">
		<!-- 文件上传输入框 -->
		<input id="uploadFileInput" type="file" />
		<br><br>
		<!-- 结果显示容器 -->
		<div id="container">
			<!-- 全屏按钮 -->
			<input id="fullscreen-btn" type="button" value="Fullscreen" />
			<br>
			<!-- PPTX 解析结果显示区域 -->
			<div id="result"></div>
		</div>
	</div>
<script type="module">
// 引入 PPTX 解析核心模块
import pptxToHtml from '/src/js/index.js';

// 获取 DOM 元素引用
var resultDiv = document.getElementById("result");
var loadingMsgDiv = null;
var progressBarDiv = null;
var slideWidth = 0;
var slideHeight = 0;

// 创建加载提示消息
function createLoadingMsg() {
	if (loadingMsgDiv) return;
	loadingMsgDiv = document.createElement("div");
	loadingMsgDiv.className = "slides-loadnig-msg";
	progressBarDiv = document.createElement("div");
	progressBarDiv.className = "slides-loading-progress-bar";
	progressBarDiv.innerHTML = "<span style='text-align: center;'>Loading... (1%)</span>";
	loadingMsgDiv.appendChild(progressBarDiv);
	resultDiv.insertBefore(loadingMsgDiv, resultDiv.firstChild);
}

// 移除加载提示消息
function removeLoadingMsg() {
	if (loadingMsgDiv) {
		loadingMsgDiv.remove();
		loadingMsgDiv = null;
	}
}

// 更新进度条
function updateProgressBar(percent) {
	if (progressBarDiv) {
		progressBarDiv.style.width = percent + "%";
		progressBarDiv.innerHTML = "<span style='text-align: center;'>Loading...(" + percent + "%)</span>";
	}
}

// 创建幻灯片包装容器
function createSlidesWrapper() {
	if (document.getElementById("all_slides_warpper") !== null) return;
	var slides = document.querySelectorAll("#result .slide");
	if (slides.length === 0) return;
	var wrapper = document.createElement("div");
	wrapper.id = "all_slides_warpper";
	wrapper.className = "slides";
	var firstSlide = slides[0];
	if (firstSlide && firstSlide.parentNode) {
		firstSlide.parentNode.insertBefore(wrapper, firstSlide);
		for (var i = 0; i < slides.length; i++) {
			wrapper.appendChild(slides[i]);
		}
	}
}

// 处理文件输入变化事件
document.getElementById("uploadFileInput").addEventListener("change", function(evt) {
	var file = evt.target.files[0];
	if (!file) return;

	// 验证文件类型
	var fileType = file.type;
	if (fileType !== "application/vnd.openxmlformats-officedocument.presentationml.presentation") {
		alert("This is not pptx file");
		return;
	}

	// 清空结果区域
	resultDiv.innerHTML = "";
	createLoadingMsg();

	// 使用 FileReader 读取文件
	var reader = new FileReader();
	reader.onload = async function(e) {
		var fileData = e.target.result;
		
		try {
			// 直接获取解析结果（异步函数）
			const result = await pptxToHtml(fileData, {
				slideMode: false,
				keyBoardShortCut: false,
				slideModeConfig: {
					first: 1,
					nav: false,
					navTxtColor: "white",
					navNextTxt: "&#8250;",
					navPrevTxt: "&#8249;",
					showPlayPauseBtn: false,
					keyBoardShortCut: false,
					showSlideNum: false,
					showTotalSlideNum: false,
					autoSlide: false,
					randomAutoSlide: false,
					loop: false,
					background: "black",
					transition: "default",
					transitionTime: 1
				},
				callbacks: {
					onProgress: function(percent) {
						updateProgressBar(percent);
					}
				}
			});
			
			console.log("PPTX Result:", result);
			console.log("PPTX Charts:", result.charts);
			
			// 渲染全局CSS
			if (result.styles && result.styles.global) {
				var style = document.createElement("style");
				style.innerHTML = result.styles.global;
				resultDiv.appendChild(style);
			}
			
			// 渲染所有幻灯片
			result.slides.forEach(slide => {
				resultDiv.innerHTML += slide.html;
			});
			
			console.log('charts', result.charts);
			// 渲染所有图表
			if (result.charts && result.charts.length > 0) {
				result.charts.forEach(chartInfo => {
					var chartElement = d3.select("#" + chartInfo.chartId);
					if (chartElement.empty()) {
						console.warn("Chart element not found: #" + chartInfo.chartId);
						return;
					}

					if (!chartInfo.data) {
						console.warn("Chart data is null or undefined for chart: " + chartInfo.chartId);
						return;
					}

					var chartData = chartInfo.data;
					var chartStyles = [];
					
					// 处理图表样式信息
					if (Array.isArray(chartData)) {
						chartData.forEach((series, index) => {
							if (series.style) {
								chartStyles[index] = series.style;
							} else {
								chartStyles[index] = {};
							}
						});
					}
					
					// 饼图需要特殊的数据格式转换
					if (chartInfo.type === "pieChart" || chartInfo.type === "pie3DChart") {
						console.log("Converting pie chart data");
						// 将 [{key: "Series", values: [{x: 0, y: 10}, ...]}] 
						// 转换为 [{x: label, y: value}, ...]
						// 注意：NVD3饼图使用x作为标签，y作为值
						if (Array.isArray(chartData) && chartData.length > 0) {
							const series = chartData[0];
							console.log("Series:", series);
							if (series.values && Array.isArray(series.values)) {
								// NVD3饼图可以直接使用values数组
								chartData = series.values.map((item, index) => {
									let label = `Item ${index}`;
									if (series.xlabels && series.xlabels[index] !== undefined) {
										label = series.xlabels[index];
									}
									let value = 0;
									if (item && item.y !== undefined) {
										value = parseFloat(item.y);
									}
									const convertedItem = {
										x: label,
										y: value
									};
									console.log(`Converted item ${index}:`, convertedItem);
									return convertedItem;
								});
								console.log("Converted pie chart data:", chartData);
								console.log("Pie values array:", chartData);
								chartData.forEach((item, index) => {
									console.log(`Pie value ${index}:`, item, "has x:", item.x !== undefined, "has y:", item.y !== undefined);
								});
							}
						}
					} else {
						console.log("Not a pie chart, using original data format");
					}
					
					console.log("After conversion - chartData:", chartData);
					console.log("Chart styles:", chartStyles);
					
					var chart = null;
					
					// 预处理图例位置
					let legendPosition = 'right';
					if (chartInfo.style && chartInfo.style.legend && chartInfo.style.legend.position) {
						// PPTX位置值: b(bottom), t(top), l(left), r(right), tr(top-right), tl(top-left), br(bottom-right), bl(bottom-left)
						// NVD3位置值: top, right, bottom, left
						const positionMap = {
							'b': 'bottom',
							't': 'top',
							'l': 'left',
							'r': 'right',
							'tr': 'right',
							'tl': 'left',
							'br': 'right',
							'bl': 'left'
						};
						if (positionMap[chartInfo.style.legend.position]) {
							legendPosition = positionMap[chartInfo.style.legend.position];
						}
					}
					
					switch (chartInfo.type) {
						case "lineChart":
							chart = nv.models.lineChart();
							if (legendPosition === 'right') {
								chart.legend.rightAlign(true);
								chart.legend.align(true);
								chart.legend.height(30);
								chart.margin({top: 30, right: 100, bottom: 50, left: 60});
							} else if (legendPosition === 'left') {
								chart.legend.rightAlign(false);
								chart.legend.align(false);
								chart.legend.height(30);
								chart.margin({top: 30, right: 50, bottom: 50, left: 100});
							} else if (legendPosition === 'top') {
								chart.legend.rightAlign(false);
								chart.legend.align(false);
								chart.legend.height(30);
								chart.margin({top: 50, right: 50, bottom: 50, left: 60});
							} else if (legendPosition === 'bottom') {
								chart.legend.rightAlign(false);
								chart.legend.align(false);
								chart.legend.height(30);
								chart.margin({top: 30, right: 50, bottom: 80, left: 60});
							}
							break;
						case "barChart":
							chart = nv.models.multiBarChart();
							if (legendPosition === 'right') {
								chart.legend.rightAlign(true);
								chart.legend.align(true);
								chart.legend.height(30);
								chart.margin({top: 30, right: 100, bottom: 50, left: 60});
							} else if (legendPosition === 'left') {
								chart.legend.rightAlign(false);
								chart.legend.align(false);
								chart.legend.height(30);
								chart.margin({top: 30, right: 50, bottom: 50, left: 100});
							} else if (legendPosition === 'top') {
								chart.legend.rightAlign(false);
								chart.legend.align(false);
								chart.legend.height(30);
								chart.margin({top: 50, right: 50, bottom: 50, left: 60});
							} else if (legendPosition === 'bottom') {
								chart.legend.rightAlign(false);
								chart.legend.align(false);
								chart.legend.height(30);
								chart.margin({top: 30, right: 50, bottom: 80, left: 60});
							}
							break;
						case "pieChart":
					case "pie3DChart":
							// NVD3 pie chart expects data in format: [{key: "Series", values: [{x: label, y: value}, ...]}]
							chart = nv.models.pieChart()
								.x(function(d) { 
									return d.x; 
								})
								.y(function(d) { 
									return d.y; 
								})
								.showLabels(true);
							break;
						case "areaChart":
							chart = nv.models.stackedAreaChart();
							if (legendPosition === 'right') {
								chart.legend.rightAlign(true);
								chart.legend.align(true);
								chart.legend.height(30);
								chart.margin({top: 30, right: 100, bottom: 50, left: 60});
							} else if (legendPosition === 'left') {
								chart.legend.rightAlign(false);
								chart.legend.align(false);
								chart.legend.height(30);
								chart.margin({top: 30, right: 50, bottom: 50, left: 100});
							} else if (legendPosition === 'top') {
								chart.legend.rightAlign(false);
								chart.legend.align(false);
								chart.legend.height(30);
								chart.margin({top: 50, right: 50, bottom: 50, left: 60});
							} else if (legendPosition === 'bottom') {
								chart.legend.rightAlign(false);
								chart.legend.align(false);
								chart.legend.height(30);
								chart.margin({top: 30, right: 50, bottom: 80, left: 60});
							}
							break;
						case "scatterChart":
							chart = nv.models.scatterChart();
							if (legendPosition === 'right') {
								chart.legend.rightAlign(true);
								chart.legend.align(true);
								chart.legend.height(30);
								chart.margin({top: 30, right: 100, bottom: 50, left: 60});
							} else if (legendPosition === 'left') {
								chart.legend.rightAlign(false);
								chart.legend.align(false);
								chart.legend.height(30);
								chart.margin({top: 30, right: 50, bottom: 50, left: 100});
							} else if (legendPosition === 'top') {
								chart.legend.rightAlign(false);
								chart.legend.align(false);
								chart.legend.height(30);
								chart.margin({top: 50, right: 50, bottom: 50, left: 60});
							} else if (legendPosition === 'bottom') {
								chart.legend.rightAlign(false);
								chart.legend.align(false);
								chart.legend.height(30);
								chart.margin({top: 30, right: 50, bottom: 80, left: 60});
							}
							break;
					}
					
					if (chart) {
						try {
							// 验证数据格式
							let isValid = true;
							if (!Array.isArray(chartData)) {
								console.error("Chart data is not an array");
								isValid = false;
							} else {
								// 饼图使用简单格式: [{x: label, y: value}, ...]
								// 其他图表使用格式: {key: "Series", values: [...]}
								const isPieChart = chartInfo.type === "pieChart" || chartInfo.type === "pie3DChart";
								
								chartData.forEach((item, index) => {
									if (!item || typeof item !== 'object') {
										console.error(`Chart data item ${index} is not an object:`, item);
										isValid = false;
									}
									
									if (isPieChart) {
										// 饼图格式: {x: label, y: value}
										if (item.x === undefined || item.y === undefined) {
											console.error(`Pie chart data item ${index} missing required fields (x or y):`, item);
											isValid = false;
										}
									} else {
										// 其他图表格式: {key: "Series", values: [...]}
										if (!item.key || !item.values || !Array.isArray(item.values)) {
											console.error(`Chart data item ${index} missing required fields (key or values):`, item);
											isValid = false;
										}
									}
								});
							}
							
							if (!isValid) {
								console.error("Invalid chart data, skipping rendering");
								return;
							}
							
							// 应用样式
							const isPieChart = chartInfo.type === "pieChart" || chartInfo.type === "pie3DChart";
							
							// 应用系列样式
							if (!isPieChart && chartStyles.length > 0) {
								// 为非饼图设置颜色
								if (chart.color) {
									chart.color(function(d, i) {
										if (chartStyles[i]) {
											if (chartStyles[i].gradientFill && chartStyles[i].gradientFill.color && chartStyles[i].gradientFill.color.length > 0) {
												// 使用渐变填充的第一个颜色
												return "#" + chartStyles[i].gradientFill.color[0];
											} else if (chartStyles[i].fillColor) {
												// 使用纯色填充
												return chartStyles[i].fillColor;
											} else {
												// 默认颜色
												return d3.scale.category10().range()[i % 10];
											}
										} else {
											// 默认颜色
											return d3.scale.category10().range()[i % 10];
										}
									});
								}
							} else if (isPieChart && chartStyles.length > 0 && chartStyles[0]) {
								// 为饼图设置颜色
								if (chart.color) {
									chart.color(function(d, i) {
										if (chartStyles[0]) {
											if (chartStyles[0].gradientFill && chartStyles[0].gradientFill.color && chartStyles[0].gradientFill.color.length > 0) {
												// 使用渐变填充的第一个颜色
												return "#" + chartStyles[0].gradientFill.color[0];
											} else if (chartStyles[0].fillColor) {
												// 使用纯色填充
												return chartStyles[0].fillColor;
											} else {
												// 默认颜色
												return d3.scale.category10().range()[i % 10];
											}
										} else {
											// 默认颜色
											return d3.scale.category10().range()[i % 10];
										}
									});
								}
							}
						
							// 应用图表样式
							if (chartInfo.style) {
								const chartStyle = chartInfo.style;
								
								// 应用图例样式
								if (chartStyle.legend) {
									if (chart.legend) {
										if (chartStyle.legend.fontSize) {
											// 注意：NVD3 可能不直接支持设置图例字体大小
											console.log("Legend font size:", chartStyle.legend.fontSize);
										}
										if (chartStyle.legend.color) {
											// 注意：NVD3 可能不直接支持设置图例颜色
											console.log("Legend color:", chartStyle.legend.color);
										}
									}
								}
							}
							// 输出图表样式信息
							console.log("Applied chart style:", chartInfo.style);
							
							// 检查图表元素是否已经包含SVG
							var existingSvg = chartElement.select("svg");
							if (!existingSvg.empty()) {
								console.log("Removing existing SVG from chart element");
								existingSvg.remove();
							}
							
							// 创建SVG元素
							var svgElement = chartElement.append("svg")
								.datum(chartData)
								.transition().duration(500)
								.call(chart);
							nv.utils.windowResize(chart.update);
							
							// 应用图表样式（在SVG创建后）
							if (chartInfo.style) {
								const chartStyle = chartInfo.style;
								
								// 应用图表标题样式
								if (chartStyle.title) {
									if (chart.title) {
										if (chartStyle.title.fontSize) {
											// 注意：NVD3 可能不直接支持设置标题字体大小
											console.log("Title font size:", chartStyle.title.fontSize);
										}
										if (chartStyle.title.color) {
											// 注意：NVD3 可能不直接支持设置标题颜色
											console.log("Title color:", chartStyle.title.color);
										}
									}
								}
								
								// 应用图表区域样式
								if (chartStyle.chartArea) {
									if (chartStyle.chartArea.fillColor) {
										// 直接设置 SVG 元素的背景颜色
										svgElement.style("background-color", chartStyle.chartArea.fillColor);
										console.log("Applied chart area fill color:", chartStyle.chartArea.fillColor);
									}
									if (chartStyle.chartArea.borderColor) {
										// 直接设置 SVG 元素的边框颜色
										svgElement.style("border-color", chartStyle.chartArea.borderColor);
										svgElement.style("border-width", chartStyle.chartArea.borderWidth || "1px");
										svgElement.style("border-style", "solid");
										console.log("Applied chart area border color:", chartStyle.chartArea.borderColor);
									}
								}
								
								// 应用轴样式
								if (chartStyle.categoryAxis) {
									if (chart.xAxis) {
										if (chartStyle.categoryAxis.color) {
											// 注意：NVD3 可能不直接支持设置轴标签颜色
											console.log("Category axis color:", chartStyle.categoryAxis.color);
										}
										if (chartStyle.categoryAxis.fontSize) {
											// 注意：NVD3 可能不直接支持设置轴标签字体大小
											console.log("Category axis font size:", chartStyle.categoryAxis.fontSize);
										}
										if (chartStyle.categoryAxis.lineColor) {
											// 注意：NVD3 可能不直接支持设置轴线颜色
											console.log("Category axis line color:", chartStyle.categoryAxis.lineColor);
										}
									}
								}
								
								if (chartStyle.valueAxis) {
									if (chart.yAxis) {
										if (chartStyle.valueAxis.color) {
											// 注意：NVD3 可能不直接支持设置轴标签颜色
											console.log("Value axis color:", chartStyle.valueAxis.color);
										}
										if (chartStyle.valueAxis.fontSize) {
											// 注意：NVD3 可能不直接支持设置轴标签字体大小
											console.log("Value axis font size:", chartStyle.valueAxis.fontSize);
										}
										if (chartStyle.valueAxis.gridlineColor) {
											// 注意：NVD3 可能不直接支持设置网格线颜色
											console.log("Gridline color:", chartStyle.valueAxis.gridlineColor);
										}
										if (chartStyle.valueAxis.gridlineWidth) {
											// 注意：NVD3 可能不直接支持设置网格线宽度
											console.log("Gridline width:", chartStyle.valueAxis.gridlineWidth);
										}
										if (chartStyle.valueAxis.lineColor) {
											// 注意：NVD3 可能不直接支持设置轴线颜色
											console.log("Value axis line color:", chartStyle.valueAxis.lineColor);
										}
									}
								}
							}
						} catch (err) {
							console.error("Error rendering chart:", err);
							console.error("Chart info:", chartInfo);
							console.error("Chart data:", chartData);
						}
					}
				});
			}
			
			// 创建幻灯片包装器
			createSlidesWrapper();
			removeLoadingMsg();
			
		} catch (err) {
			console.error(err);
			removeLoadingMsg();
			alert(err.message);
		}
	};
	reader.readAsArrayBuffer(file);
});
</script>
<script type="text/javascript">
    // 全屏功能实现
    var oldWidth, oldMargin, isFullscreenMode = false;
    document.getElementById("fullscreen-btn").addEventListener("click", function() {
        if (!isFullscreenMode) {
            // 进入全屏模式
            var slides = document.querySelectorAll("#result .slide");
            if (slides.length > 0) {
                oldWidth = slides[0].style.width;
                oldMargin = slides[0].style.margin;
                for (var i = 0; i < slides.length; i++) {
                    slides[i].style.width = "99%";
                    slides[i].style.margin = "0 auto";
                }
            }
            
            // 兼容不同浏览器的全屏 API
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
            } else if (document.documentElement.webkitRequestFullscreen) {
                document.documentElement.webkitRequestFullscreen();
            } else if (document.documentElement.msRequestFullscreen) {
                document.documentElement.msRequestFullscreen();
            } else if (document.documentElement.mozRequestFullScreen) {
                document.documentElement.mozRequestFullScreen();
            }
            isFullscreenMode = true;
        } else {
            // 退出全屏模式
            var slides = document.querySelectorAll("#result .slide");
            for (var i = 0; i < slides.length; i++) {
                slides[i].style.width = oldWidth;
                slides[i].style.margin = oldMargin;
            }
            
            // 兼容不同浏览器的退出全屏 API
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            }
            isFullscreenMode = false;
        }
    });

    // 监听全屏状态变化
    document.addEventListener("fullscreenchange", function() {
        if (!document.fullscreenElement) {
            // 退出全屏时恢复原始样式
            var slides = document.querySelectorAll("#result .slide");
            for (var i = 0; i < slides.length; i++) {
                slides[i].style.width = oldWidth;
                slides[i].style.margin = oldMargin;
            }
        }
    });
</script>
</body>
</html>
