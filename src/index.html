<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>PPTXjs - Meshesha</title>

<link rel="stylesheet" href="./css/pptxjs.css">

<!-- Use D3 v3 for NVD3 compatibility -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.6/nv.d3.min.js"></script>


<script type="text/javascript" src="./js/jszip.min.js"></script>
    <script type="text/javascript" src="./js/utils/jszip-utils.js"></script>
    <!-- <script src="./js/utils/xml-parser.js"></script> -->
    <!-- <script src="./js/txml.js"></script> -->
    <script type="text/javascript" src="./js/tinycolor.js"></script>
    <!-- <script type="text/javascript" src="./js/filereader.js"></script> -->


    <!-- <script type="module" type="text/javascript" src="./js/utils/xml-parser.js"></script>
    <script type="module" type="text/javascript" src="./js/core/pptx-constants.js"></script>
    <script type="module" type="text/javascript" src="./js/utils/utils.js"></script>
    <script type="module" type="text/javascript" src="./js/core/pptx-color-utils.js"></script>
    <script type="module" type="text/javascript" src="./js/core/pptx-layout-utils.js"></script>
    <script type="module" type="text/javascript" src="./js/core/pptx-css-utils.js"></script>
    <script type="module" type="text/javascript" src="./js/core/pptx-style-manager.js"></script>
    <script type="module" type="text/javascript" src="./js/shape/pptx-shape-utils.js"></script>
    <script type="module" type="text/javascript" src="./js/shape/pptx-shape-fills-utils.js"></script>
    <script type="module" type="text/javascript" src="./js/shape/pptx-shape-property-extractor.js"></script>
    <script type="module" type="text/javascript" src="./js/shape/pptx-shape-container.js"></script>
    <script type="module" type="text/javascript" src="./js/shape/pptx-basic-shapes.js"></script>
    <script type="module" type="text/javascript" src="./js/shape/pptx-flowchart-shapes.js"></script>
    <script type="module" type="text/javascript" src="./js/shape/pptx-actionbutton-shapes.js"></script>
    <script type="module" type="text/javascript" src="./js/shape/pptx-star-shapes.js"></script>
    <script type="module" type="text/javascript" src="./js/shape/pptx-callout-shapes.js"></script>
    <script type="module" type="text/javascript" src="./js/shape/pptx-arrow-shapes.js"></script>
    <script type="module" type="text/javascript" src="./js/shape/pptx-math-shapes.js"></script>
    <script type="module" type="text/javascript" src="./js/text/pptx-text-style-utils.js"></script>
    <script type="module" type="text/javascript" src="./js/text/pptx-bullet-utils.js"></script>
    <script type="module" type="text/javascript" src="./js/text/text-utils.js"></script>
    <script type="module" type="text/javascript" src="./js/text/pptx-text-element-utils.js"></script>
    <script type="module" type="text/javascript" src="./js/table/pptx-table-utils.js"></script>
    <script type="module" type="text/javascript" src="./js/core/pptx-background-utils.js"></script>
    <script type="module" type="text/javascript" src="./js/node/pptx-node-utils.js"></script>
    <script type="module" type="text/javascript" src="./js/image/pptx-image-utils.js"></script>
    <script type="module" type="text/javascript" src="./js/diagram/pptx-diagram-utils.js"></script>
    <script type="module" type="text/javascript" src="./js/ui/pptx-ui-utils.js"></script>
    <script type="module" type="text/javascript" src="./js/pptx-parser.js"></script>
    <script type="module" type="text/javascript" src="./js/pptx-html.js"></script>
    <script type="module" src="./js/pptxjs.js"></script> -->

<script type="module">
    document.addEventListener('DOMContentLoaded', function() {
		var oldWidth, oldMargin, isFullscreenMode = false;
		var fullscreenBtn = document.getElementById('fullscreen-btn');
		var resultDiv = document.getElementById('result');
		
		fullscreenBtn.addEventListener('click', function(){
			if (!isFullscreenMode) {
				var slides = document.querySelectorAll('#result .slide');
				if (slides.length > 0) {
					oldWidth = window.getComputedStyle(slides[0]).width;
					oldMargin = window.getComputedStyle(slides[0]).margin;
				}
				slides.forEach(function(slide) {
					slide.style.width = '99%';
					slide.style.margin = '0 auto';
				});
				if (resultDiv.requestFullscreen) {
					resultDiv.requestFullscreen();
				} else if (resultDiv.mozRequestFullScreen) {
					resultDiv.mozRequestFullScreen();
				} else if (resultDiv.webkitRequestFullscreen) {
					resultDiv.webkitRequestFullscreen();
				} else if (resultDiv.msRequestFullscreen) {
					resultDiv.msRequestFullscreen();
				}
				isFullscreenMode = true;
			} else {
				var slides = document.querySelectorAll('#result .slide');
				slides.forEach(function(slide) {
					slide.style.width = oldWidth;
					slide.style.margin = oldMargin;
				});
				if (document.exitFullscreen) {
					document.exitFullscreen();
				} else if (document.mozCancelFullScreen) {
					document.mozCancelFullScreen();
				} else if (document.webkitExitFullscreen) {
					document.webkitExitFullscreen();
				} else if (document.msExitFullscreen) {
					document.msExitFullscreen();
				}
				isFullscreenMode = false;
			}
		});
		
		document.addEventListener('fullscreenchange', function() {
			if (!document.fullscreenElement) {
				var slides = document.querySelectorAll('#result .slide');
				slides.forEach(function(slide) {
					slide.style.width = oldWidth;
					slide.style.margin = oldMargin;
				});
			}
		});
    });
</script>
<style>
	html, body { margin: 0; padding: 0; }
	#warper { margin-right: auto; margin-left: auto; }
</style>
</head>
<body>
	<div id="warper">
		<input id="uploadFileInput" type="file" />
		<br><br>
		<div id="container">
			<input id="fullscreen-btn" type="button" value="Fullscreen" />
			<br>
			<div  id="result"></div>
		</div>
	</div>
<script type="module">
    import { pptxToHtml } from './js/pptxjs.js';
    import { PPTXHtml } from './js/pptx-html.js';
    import { PPTXUIUtils } from './js/ui/pptx-ui-utils.js';

    const resultDiv = document.getElementById('result');
    const fileInput = document.getElementById('uploadFileInput');

    // 文件上传处理
    fileInput.addEventListener('change', function(evt) {
        const file = evt.target.files[0];
        if (!file) return;

        const fileType = file.type;
        if (fileType !== "application/vnd.openxmlformats-officedocument.presentationml.presentation") {
            alert("This is not a pptx file");
            return;
        }

        // 显示加载状态
        PPTXUIUtils.updateProgressBar(1);

        // 调用 pptxToHtml 解析文件
        pptxToHtml(file, {
            container: resultDiv,
            onProgress: function(percent) {
                PPTXUIUtils.updateProgressBar(percent);
            }
        }).then(function(result) {
            // 解析完成，插入 HTML 和 CSS
            console.log("About to insert HTML, total length:", result.html.length);
            console.log("Number of slide divs:", (result.html.match(/class='slide'/g) || []).length);

            // 清空 resultDiv
            resultDiv.innerHTML = '';

            // 逐个插入 slide,而不是一次性插入所有 HTML
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = result.html;
            var slides = tempDiv.querySelectorAll('.slide');
            console.log("Found", slides.length, "slides in tempDiv");

            slides.forEach(function(slide, index) {
                console.log("Inserting slide", index, "with data-slide-index:", slide.getAttribute('data-slide-index'));
                resultDiv.appendChild(slide);
            });

            const style = document.createElement('style');
            style.textContent = result.css;
            document.head.appendChild(style);

            // 处理数字列表
            PPTXHtml.setNumericBullets(document.querySelectorAll(".block"));
            PPTXHtml.setNumericBullets(document.querySelectorAll("table td"));

            // 处理图表队列(必须在 HTML 插入 DOM 之后)
            if (result.chartQueue && result.chartQueue.length > 0) {
                console.log("Processing chart queue with", result.chartQueue.length, "charts");
                PPTXHtml.processMsgQueue(result.chartQueue);
            }

            // 移除加载提示
            PPTXUIUtils.removeLoadingMessage();
        }).catch(function(error) {
            console.error('Error parsing PPTX:', error);
            alert("Error parsing PPTX: " + error.message);
            PPTXUIUtils.removeLoadingMessage();
        });
    });
</script>

</body>
</html>
