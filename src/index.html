<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>pptx 解析</title>

<link rel="stylesheet" href="./css/pptxjs.css">
<link rel="stylesheet" href="./css/nv.d3.min.css">

<script type="text/javascript" src="./js/jszip.min.js"></script>
<script type="text/javascript" src="./js/filereader.js"></script>
<script type="text/javascript" src="./js/d3.min.js"></script>
<script type="text/javascript" src="./js/nv.d3.min.js"></script>


<!-- Core Dependencies -->
<script type="text/javascript" src="./js/core/tXml.js"></script>
<script type="text/javascript" src="./js/core/tinycolor.js"></script>






<style>
	html, body { margin: 0; padding: 0; }
	#warper { margin-right: auto; margin-left: 20px; }
	.slides-loadnig-msg { display:block; width:100%; color:white; background-color: #ddd; }
	.slides-loading-progress-bar { width: 1%; background-color: #4775d1; }
</style>
</head>
<body>
	<div id="warper">
		<input id="uploadFileInput" type="file" />
		<br><br>
		<div id="container">
			<input id="fullscreen-btn" type="button" value="Fullscreen" />
			<br>
			<div id="result"></div>
		</div>
	</div>
<script type="module">
import pptxToHtml from './js/pptxjs.js';
import { PPTXNodeUtils } from './js/utils/node.js';
import { PPTXTextUtils } from './js/utils/text.js';

var resultDiv = document.getElementById("result");
var loadingMsgDiv = null;
var progressBarDiv = null;
var slideWidth = 0;
var slideHeight = 0;

function createLoadingMsg() {
	if (loadingMsgDiv) return;
	loadingMsgDiv = document.createElement("div");
	loadingMsgDiv.className = "slides-loadnig-msg";
	progressBarDiv = document.createElement("div");
	progressBarDiv.className = "slides-loading-progress-bar";
	progressBarDiv.innerHTML = "<span style='text-align: center;'>Loading... (1%)</span>";
	loadingMsgDiv.appendChild(progressBarDiv);
	resultDiv.insertBefore(loadingMsgDiv, resultDiv.firstChild);
}

function removeLoadingMsg() {
	if (loadingMsgDiv) {
		loadingMsgDiv.remove();
		loadingMsgDiv = null;
	}
}

function updateProgressBar(percent) {
	if (progressBarDiv) {
		progressBarDiv.style.width = percent + "%";
		progressBarDiv.innerHTML = "<span style='text-align: center;'>Loading...(" + percent + "%)</span>";
	}
}

function createSlidesWrapper() {
	if (document.getElementById("all_slides_warpper") !== null) return;
	var slides = document.querySelectorAll("#result .slide");
	if (slides.length === 0) return;
	var wrapper = document.createElement("div");
	wrapper.id = "all_slides_warpper";
	wrapper.className = "slides";
	var firstSlide = slides[0];
	if (firstSlide && firstSlide.parentNode) {
		firstSlide.parentNode.insertBefore(wrapper, firstSlide);
		for (var i = 0; i < slides.length; i++) {
			wrapper.appendChild(slides[i]);
		}
	}
}

function setNumericBullets(elem) {
	var prgrphs_arry = elem;
	for (var i = 0; i < prgrphs_arry.length; i++) {
		var buSpan = prgrphs_arry[i].querySelectorAll('.numeric-bullet-style');
		if (buSpan.length > 0) {
			var prevBultTyp = "";
			var prevBultLvl = "";
			var buletIndex = 0;
			var tmpArry = new Array();
			var tmpArryIndx = 0;
			var buletTypSrry = new Array();
			for (var j = 0; j < buSpan.length; j++) {
				var bult_typ = buSpan[j].getAttribute("data-bulltname");
				var bult_lvl = buSpan[j].getAttribute("data-bulltlvl");
				if (buletIndex == 0) {
					prevBultTyp = bult_typ;
					prevBultLvl = bult_lvl;
					tmpArry[tmpArryIndx] = buletIndex;
					buletTypSrry[tmpArryIndx] = bult_typ;
					buletIndex++;
				} else {
					if (bult_typ == prevBultTyp && bult_lvl == prevBultLvl) {
						prevBultTyp = bult_typ;
						prevBultLvl = bult_lvl;
						buletIndex++;
						tmpArry[tmpArryIndx] = buletIndex;
						buletTypSrry[tmpArryIndx] = bult_typ;
					} else if (bult_typ != prevBultTyp && bult_lvl == prevBultLvl) {
						prevBultTyp = bult_typ;
						prevBultLvl = bult_lvl;
						tmpArryIndx++;
						tmpArry[tmpArryIndx] = buletIndex;
						buletTypSrry[tmpArryIndx] = bult_typ;
						buletIndex = 1;
					} else if (bult_typ != prevBultTyp && Number(bult_lvl) > Number(prevBultLvl)) {
						prevBultTyp = bult_typ;
						prevBultLvl = bult_lvl;
						tmpArryIndx++;
						tmpArry[tmpArryIndx] = buletIndex;
						buletTypSrry[tmpArryIndx] = bult_typ;
						buletIndex = 1;
					} else if (bult_typ != prevBultTyp && Number(bult_lvl) < Number(prevBultLvl)) {
						prevBultTyp = bult_typ;
						prevBultLvl = bult_lvl;
						tmpArryIndx--;
						buletIndex = tmpArry[tmpArryIndx] + 1;
					}
				}
				var numIdx = PPTXTextUtils.getNumTypeNum(buletTypSrry[tmpArryIndx], buletIndex);
				buSpan[j].innerHTML = numIdx;
			}
		}
	}
}

// Handle file input change
document.getElementById("uploadFileInput").addEventListener("change", function(evt) {
	var file = evt.target.files[0];
	if (!file) return;

	var fileType = file.type;
	if (fileType !== "application/vnd.openxmlformats-officedocument.presentationml.presentation") {
		alert("This is not pptx file");
		return;
	}

	var reader = new FileReader();
	reader.onload = function(e) {
		var fileData = e.target.result;
		pptxToHtml(fileData, {
			slideMode: false,
			keyBoardShortCut: false,
			slideModeConfig: {
				first: 1,
				nav: false,
				navTxtColor: "white",
				navNextTxt: "&#8250;",
				navPrevTxt: "&#8249;",
				showPlayPauseBtn: false,
				keyBoardShortCut: false,
				showSlideNum: false,
				showTotalSlideNum: false,
				autoSlide: false,
				randomAutoSlide: false,
				loop: false,
				background: "black",
				transition: "default",
				transitionTime: 1
			},
			callbacks: {
				onFileStart: function() {
					resultDiv.innerHTML = "";
					createLoadingMsg();
				},
				onProgress: function(percent) {
					updateProgressBar(percent);
				},
				onSlide: function(html, info) {
					resultDiv.innerHTML += html;
				},
				onThumbnail: function(base64) {
					// Handle thumbnail if needed
				},
				onSlideSize: function(size) {
					slideWidth = size.width;
					slideHeight = size.height;
				},
				onGlobalCSS: function(css) {
					var style = document.createElement("style");
					style.innerHTML = css;
					resultDiv.appendChild(style);
				},
				onChartReady: function(chartInfo) {
					var chartElement = d3.select("#" + chartInfo.chartID);
					if (chartElement.empty()) {
						console.warn("Chart element not found: #" + chartInfo.chartID);
						return;
					}
					if (!chartInfo.data || !Array.isArray(chartInfo.data) || chartInfo.data.length === 0) {
						console.warn("Invalid or empty chart data for chart: " + chartInfo.chartID);
						return;
					}
					chartElement.append("svg")
						.datum(chartInfo.data)
						.transition().duration(500)
						.call(chartInfo.chart);
					nv.utils.windowResize(chartInfo.chart.update);
				},
				onComplete: function(data) {
					setNumericBullets(document.querySelectorAll(".block"));
					setNumericBullets(document.querySelectorAll("table td"));
					createSlidesWrapper();
					removeLoadingMsg();
				},
				onError: function(error) {
					console.error(error);
					removeLoadingMsg();
					alert(error.message);
				}
			}
		});
	};
	reader.readAsArrayBuffer(file);
});
</script>
<script type="text/javascript">
    var oldWidth, oldMargin, isFullscreenMode = false;
    document.getElementById("fullscreen-btn").addEventListener("click", function() {
        if (!isFullscreenMode) {
            var slides = document.querySelectorAll("#result .slide");
            if (slides.length > 0) {
                oldWidth = slides[0].style.width;
                oldMargin = slides[0].style.margin;
                for (var i = 0; i < slides.length; i++) {
                    slides[i].style.width = "99%";
                    slides[i].style.margin = "0 auto";
                }
            }
            
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
            } else if (document.documentElement.webkitRequestFullscreen) {
                document.documentElement.webkitRequestFullscreen();
            } else if (document.documentElement.msRequestFullscreen) {
                document.documentElement.msRequestFullscreen();
            } else if (document.documentElement.mozRequestFullScreen) {
                document.documentElement.mozRequestFullScreen();
            }
            isFullscreenMode = true;
        } else {
            var slides = document.querySelectorAll("#result .slide");
            for (var i = 0; i < slides.length; i++) {
                slides[i].style.width = oldWidth;
                slides[i].style.margin = oldMargin;
            }
            
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            }
            isFullscreenMode = false;
        }
    });

    document.addEventListener("fullscreenchange", function() {
        if (!document.fullscreenElement) {
            var slides = document.querySelectorAll("#result .slide");
            for (var i = 0; i < slides.length; i++) {
                slides[i].style.width = oldWidth;
                slides[i].style.margin = oldMargin;
            }
        }
    });
</script>
</body>
</html>
